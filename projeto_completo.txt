==================================================
ARQUIVO: 404.html
==================================================
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Page Not Found</title>

    <style media="screen">
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #message { background: white; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px 16px; border-radius: 3px; }
      #message h3 { color: #888; font-weight: normal; font-size: 16px; margin: 16px 0 12px; }
      #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #message h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}
      #message p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #message a { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; }
      #message, #message a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
    </style>
  </head>
  <body>
    <div id="message">
      <h2>404</h2>
      <h1>Page Not Found</h1>
      <p>The specified file was not found on this website. Please check the URL for mistakes and try again.</p>
      <h3>Why am I seeing this?</h3>
      <p>This page was generated by the Firebase Command-Line Interface. To modify it, edit the <code>404.html</code> file in your project's configured <code>public</code> directory.</p>
    </div>
  </body>
</html>


==================================================
ARQUIVO: firebase.json
==================================================
{
  "functions": [
    {
      "source": "functions",
      "codebase": "default",
      "ignore": [
        "node_modules",
        ".git",
        "firebase-debug.log",
        "firebase-debug.*.log",
        "*.local"
      ]
    }
  ],
  "hosting": {
    "public": "dist",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  },
  "emulators": {
    "auth": {
      "port": 9099
    },
    "functions": {
      "port": 5001
    },
    "firestore": {
      "port": 8081
    },
    "ui": {
      "enabled": true
    },
    "singleProjectMode": true
  }
}


==================================================
ARQUIVO: index.html
==================================================
<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Novva R&S</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>

==================================================
ARQUIVO: package.json
==================================================
{
  "name": "novva-rs-saas-2",
  "private": true,
  "version": "2.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint . --ext js,jsx --report-unused-disable-directives --max-warnings 0",
    "preview": "vite preview"
  },
  "dependencies": {
    "@emotion/react": "^11.14.0",
    "@emotion/styled": "^11.14.1",
    "@mui/icons-material": "^7.3.6",
    "@mui/material": "^7.3.6",
    "@supabase/supabase-js": "^2.39.0",
    "clsx": "^2.0.0",
    "date-fns": "^4.1.0",
    "lucide-react": "^0.294.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.20.0",
    "recharts": "^3.6.0",
    "tailwind-merge": "^2.0.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.15",
    "@types/react-dom": "^18.2.7",
    "@vitejs/plugin-react": "^4.0.3",
    "autoprefixer": "^10.4.16",
    "eslint": "^8.45.0",
    "eslint-plugin-react": "^7.32.2",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.3",
    "postcss": "^8.4.31",
    "tailwindcss": "^3.4.1",
    "vite": "^4.4.5"
  }
}


==================================================
ARQUIVO: postcss.config.js
==================================================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

==================================================
ARQUIVO: tailwind.config.js
==================================================
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}

==================================================
ARQUIVO: vercel.json
==================================================
{
  "rewrites": [
    { "source": "/(.*)", "destination": "/index.html" }
  ]
}

==================================================
ARQUIVO: vite.config.js
==================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './src/test/setup.js',
    css: true,
  },
})

==================================================
ARQUIVO: .vercel\project.json
==================================================
{"projectId":"prj_HtLcAivMTvf4K2mSOR496vnc8rR7","orgId":"team_L2VfPt8LwRczWEzT69FA8EoY","projectName":"novva-rs-saas"}

==================================================
ARQUIVO: api\admin.js
==================================================
// api/admin.js (VERSÃƒO FINAL E CORRIGIDA)
import { createClient } from '@supabase/supabase-js';

async function validateAdmin(request) {
  const supabaseAdmin = createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_KEY
  );

  const authHeader = request.headers['authorization'];
  if (!authHeader) throw new Error('NÃ£o autorizado.');
  
  const token = authHeader.replace('Bearer ', '');
  const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
  if (userError) throw new Error('Token invÃ¡lido.');

  const { data: userData, error: userCheckError } = await supabaseAdmin
    .from('users')
    .select('isAdmin')
    .eq('id', user.id)
    .single();

  if (userCheckError) throw userCheckError;
  if (!userData || !userData.isAdmin) {
    throw new Error('Acesso negado. VocÃª nÃ£o Ã© um administrador.');
  }
  
  return { supabaseAdmin };
}

export default async function handler(request, response) {
  try {
    const { supabaseAdmin } = await validateAdmin(request);
    
    const action = request.method === 'GET' ? request.query.action : request.body.action;

    switch (action) {
      case 'getTenantsAndPlans': {
        const { data: tenants, error: tenantsError } = await supabaseAdmin
          .from('tenants')
          .select(`id, companyName, planId, cnpj, plans ( name )`);
        if (tenantsError) throw tenantsError;

        const { data: plans, error: plansError } = await supabaseAdmin
          .from('plans')
          .select('*');
        if (plansError) throw plansError;

        return response.status(200).json({ tenants, plans });
      }
        
      case 'updateTenantPlan': {
        if (request.method !== 'POST') { return response.status(405).json({ error: 'Use POST.' }); }
        const { tenantId, newPlanId } = request.body;
        const { data, error } = await supabaseAdmin.from('tenants').update({ planId: newPlanId }).eq('id', tenantId).select('id, companyName, planId, plans ( name )').single();
        if (error) throw error;
        return response.status(200).json({ message: 'Plano atualizado!', updatedTenant: data });
      }
      
      case 'getTenantDetails': {
        if (request.method !== 'GET') { return response.status(405).json({ error: 'Use GET.' }); }
        const { tenantId } = request.query;
        if (!tenantId) { return response.status(400).json({ error: 'tenantId Ã© obrigatÃ³rio.' }); }
        
        const { data: tenant, error: tenantError } = await supabaseAdmin.from('tenants').select('id, companyName').eq('id', tenantId).single();
        if (tenantError || !tenant) { return response.status(404).json({ error: 'Empresa nÃ£o encontrada.' }); }

        // AQUI ESTAVA O ERRO DE SINTAXE. ESTA Ã‰ A VERSÃƒO CORRETA.
        const { data: users, error: usersError } = await supabaseAdmin
          .from('users')
          .select('id, name, role, isAdmin') 
          .eq('tenantId', Number(tenantId));
        if (usersError) throw usersError;
        
        return response.status(200).json({ tenant, users });
      }

      case 'createTenant': {
        if (request.method !== 'POST') { return response.status(405).json({ error: 'Use POST.' }); }
        const { companyName, planId, cnpj } = request.body;
        if (!companyName || !planId) { return response.status(400).json({ error: 'Nome da empresa e Plano sÃ£o obrigatÃ³rios.' }); }

        const { data: newTenant, error } = await supabaseAdmin
          .from('tenants')
          .insert({ companyName, planId, cnpj: cnpj || null })
          .select('id, companyName, planId, cnpj, plans ( name )')
          .single();
        if (error) throw error;
        return response.status(201).json({ message: 'Empresa criada com sucesso!', newTenant });
      }
      
      case 'updateTenant': {
        if (request.method !== 'POST') { return response.status(405).json({ error: 'Use POST.' }); }
        const { id, companyName, planId, cnpj } = request.body;
        if (!id || !companyName || !planId) { return response.status(400).json({ error: 'ID, Nome e Plano sÃ£o obrigatÃ³rios.' }); }

        const { data: updatedTenant, error } = await supabaseAdmin
          .from('tenants')
          .update({ companyName, planId, cnpj: cnpj || null })
          .eq('id', id)
          .select('id, companyName, planId, cnpj, plans ( name )')
          .single();
        if (error) throw error;
        return response.status(200).json({ message: 'Empresa atualizada!', updatedTenant });
      }

      case 'deleteTenant': {
        if (request.method !== 'POST') { return response.status(405).json({ error: 'Use POST.' }); }
        const { tenantId } = request.body;
        if (!tenantId) { return response.status(400).json({ error: 'tenantId Ã© obrigatÃ³rio.' }); }
        
        const { error } = await supabaseAdmin.from('tenants').delete().eq('id', tenantId);
        if (error) throw error;
        return response.status(200).json({ message: 'Empresa excluÃ­da com sucesso!' });
      }
      
      case 'createPlan': {
        if (request.method !== 'POST') { return response.status(405).json({ error: 'Use POST.' }); }
        const { planData } = request.body;
        if (!planData) { return response.status(400).json({ error: 'Dados do plano sÃ£o obrigatÃ³rios.' }); }
        const { data: newPlan, error } = await supabaseAdmin.from('plans').insert(planData).select().single();
        if (error) throw error;
        return response.status(201).json({ message: 'Plano criado com sucesso!', newPlan });
      }

      case 'updatePlan': {
        if (request.method !== 'POST') { return response.status(405).json({ error: 'Use POST.' }); }
        const { planId, planData } = request.body;
        if (!planId || !planData) { return response.status(400).json({ error: 'planId e planData sÃ£o obrigatÃ³rios.' }); }
        const { data: updatedPlan, error } = await supabaseAdmin.from('plans').update(planData).eq('id', planId).select().single();
        if (error) throw error;
        return response.status(200).json({ message: 'Plano atualizado!', updatedPlan });
      }

      case 'deletePlan': {
        if (request.method !== 'POST') { return response.status(405).json({ error: 'Use POST.' }); }
        const { planId } = request.body;
        if (!planId) { return response.status(400).json({ error: 'planId Ã© obrigatÃ³rio.' }); }
        const { count, error: checkError } = await supabaseAdmin.from('tenants').select('*', { count: 'exact', head: true }).eq('planId', planId);
        if (checkError) throw checkError;
        if (count > 0) { return response.status(400).json({ error: `NÃ£o Ã© possÃ­vel excluir este plano. Ele estÃ¡ sendo usado por ${count} empresa(s).` }); }
        const { error } = await supabaseAdmin.from('plans').delete().eq('id', planId);
        if (error) throw error;
        return response.status(200).json({ message: 'Plano excluÃ­do com sucesso!' });
      }

      case 'createUser': {
        if (request.method !== 'POST') { return response.status(405).json({ error: 'Use POST.' }); }
        const { email, password, name, role, isAdmin, tenantId } = request.body;
        if (!email || !password || !name || !role || !tenantId) {
          return response.status(400).json({ error: 'Campos obrigatÃ³rios faltando.' });
        }

        const { data: authUser, error: authError } = await supabaseAdmin.auth.admin.createUser({
          email: email,
          password: password,
          email_confirm: true,
        });
        if (authError) throw authError;

        const { data: newUser, error: userError } = await supabaseAdmin
          .from('users')
          .insert({
            id: authUser.user.id,
            name: name,
            role: role,
            isAdmin: isAdmin || false,
            tenantId: tenantId
          })
          .select()
          .single();
        
        if (userError) {
          await supabaseAdmin.auth.admin.deleteUser(authUser.user.id);
          throw userError;
        }
        
        return response.status(201).json({ message: 'UsuÃ¡rio criado com sucesso!', newUser });
      }

      case 'updateUser': {
        if (request.method !== 'POST') { return response.status(405).json({ error: 'Use POST.' }); }
        const { userId, name, role, isAdmin } = request.body;
        if (!userId || !name || !role) {
          return response.status(400).json({ error: 'Campos obrigatÃ³rios faltando.' });
        }
        
        const { data: updatedUser, error } = await supabaseAdmin
          .from('users')
          .update({ name, role, isAdmin })
          .eq('id', userId)
          .select()
          .single();
        
        if (error) throw error;
        return response.status(200).json({ message: 'UsuÃ¡rio atualizado!', updatedUser });
      }

      case 'deleteUser': {
        if (request.method !== 'POST') { return response.status(405).json({ error: 'Use POST.' }); }
        const { userId } = request.body;
        if (!userId) { return response.status(400).json({ error: 'userId Ã© obrigatÃ³rio.' }); }

        const { error: userError } = await supabaseAdmin
          .from('users')
          .delete()
          .eq('id', userId);
        if (userError) throw userError;
        
        const { error: authError } = await supabaseAdmin.auth.admin.deleteUser(userId);
        if (authError) throw authError;
        
        return response.status(200).json({ message: 'UsuÃ¡rio excluÃ­do com sucesso!' });
      }
      
      default:
        return response.status(400).json({ error: 'AÃ§Ã£o de admin desconhecida.' });
    }

  } catch (error) {
    console.error("Erro na API de Admin:", error.message);
    if (error.message.includes('NÃ£o autorizado') || error.message.includes('Token invÃ¡lido')) {
      return response.status(401).json({ error: error.message });
    }
    if (error.message.includes('Acesso negado')) {
      return response.status(403).json({ error: error.message });
    }
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}

==================================================
ARQUIVO: api\apply.js
==================================================
// api/apply.js (VERSÃƒO FINAL, COMPLETA E CORRIGIDA)
import { createClient } from '@supabase/supabase-js';
import { formidable } from 'formidable';
import fs from 'fs';
import path from 'path';

export const config = {
  api: {
    bodyParser: false,
  },
};

export default async function handler(request, response) {
  if (request.method !== 'POST') {
    return response.status(405).json({ error: `MÃ©todo ${request.method} nÃ£o permitido.` });
  }

  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    const form = formidable({});
    const [fields, files] = await form.parse(request);
    
    const jobId = fields.jobId ? fields.jobId[0] : null;
    if (!jobId) { return response.status(400).json({ error: 'ID da vaga Ã© obrigatÃ³rio.' }); }

    // --- LÃ“GICA DE LIMITE ROBUSTA ---
    const { data: job, error: jobError } = await supabaseAdmin
      .from('jobs')
      .select('tenantId')
      .eq('id', jobId)
      .single();
    
    if (jobError || !job) { return response.status(404).json({ error: 'Vaga nÃ£o encontrada.' }); }

    const { data: tenant, error: tenantError } = await supabaseAdmin
      .from('tenants')
      .select('planId')
      .eq('id', job.tenantId)
      .single();

    if (tenantError || !tenant) { throw new Error('Empresa (tenant) nÃ£o encontrada para esta vaga.'); }

    const { data: plan, error: planError } = await supabaseAdmin
      .from('plans')
      .select('candidate_limit')
      .eq('id', tenant.planId)
      .single();
    
    if (planError || !plan) {
      throw new Error(`ConfiguraÃ§Ã£o de plano invÃ¡lida. O plano com ID "${tenant.planId}" nÃ£o foi encontrado na tabela 'plans'.`);
    }
    
    if (plan.candidate_limit !== -1) {
      const { count, error: countError } = await supabaseAdmin
        .from('applications')
        .select('*', { count: 'exact', head: true })
        .eq('jobId', jobId);
      if (countError) throw countError;
      if (count >= plan.candidate_limit) {
        return response.status(403).json({ error: `Limite de ${plan.candidate_limit} candidaturas para esta vaga foi atingido.` });
      }
    }
    // --- FIM DA LÃ“GICA DE LIMITE ---

    const { name, email } = fields;
    const resumeFile = files.resume;
    if (!name || !email || !resumeFile) { return response.status(400).json({ error: 'Nome, e-mail e currÃ­culo sÃ£o obrigatÃ³rios.' }); }
    const fileContent = fs.readFileSync(resumeFile[0].filepath);
    const fileExtension = path.extname(resumeFile[0].originalFilename);
    const fileName = `${email[0].replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}${fileExtension}`;
    const { data: uploadData, error: uploadError } = await supabaseAdmin.storage.from('resumes').upload(fileName, fileContent, { contentType: resumeFile[0].mimetype, upsert: false });
    if (uploadError) throw new Error(`Erro no upload: ${uploadError.message}`);
    let { data: candidate } = await supabaseAdmin.from('candidates').select('id').eq('email', email[0]).single();
    if (!candidate) {
      const { data: newCandidate, error: newCandidateError } = await supabaseAdmin.from('candidates').insert({ name: name[0], email: email[0] }).select('id').single();
      if (newCandidateError) throw newCandidateError;
      candidate = newCandidate;
    }
    const applicationFields = {};
    for (const key in fields) { applicationFields[key] = fields[key][0]; }
    const { error: applicationError } = await supabaseAdmin.from('applications').insert({ jobId: jobId, candidateId: candidate.id, resumeUrl: uploadData.path, formData: applicationFields });
    if (applicationError) throw applicationError;
    
    return response.status(201).json({ message: 'Candidatura enviada com sucesso!' });

  } catch (error) {
    console.error("Erro na candidatura:", error.message);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}

==================================================
ARQUIVO: api\createJob.js
==================================================
// api/createJob.js (VersÃ£o V2.0 - Freemium Limit & Full Fields)
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  if (request.method !== 'POST') {
    response.setHeader('Allow', ['POST']);
    return response.status(405).json({ error: `MÃ©todo ${request.method} nÃ£o permitido.` });
  }
  try {
    const supabaseAdmin = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY);
    const authHeader = request.headers['authorization'];
    if (!authHeader) return response.status(401).json({ error: 'NÃ£o autorizado.' });
    
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) return response.status(401).json({ error: 'Token invÃ¡lido.' });
    
    const { data: userData } = await supabaseAdmin.from('users').select('tenantId').eq('id', user.id).single();
    if (!userData) return response.status(404).json({ error: 'Perfil nÃ£o encontrado.' });
    const tenantId = userData.tenantId;

    // Busca dados do plano e contagem atual
    const { data: tenant, error: tenantError } = await supabaseAdmin
      .from('tenants')
      .select('plan:plans(id, job_limit)')
      .eq('id', tenantId)
      .single();
    
    if (tenantError) throw tenantError;

    // REGRA 6: Limite de Vagas Ativas apenas (especialmente Freemium)
    const job_limit = tenant.plan.job_limit;
    
    // Se o limite for diferente de -1 (ilimitado), verificamos
    if (job_limit !== -1) {
      const { count, error: countError } = await supabaseAdmin
        .from('jobs')
        .select('*', { count: 'exact', head: true })
        .eq('tenantId', tenantId)
        .eq('status', 'active'); // Conta apenas ativas!

      if (countError) throw countError;
      
      if (count >= job_limit) {
        return response.status(403).json({ 
            error: `Limite de ${job_limit} vagas ativas atingido para o plano ${tenant.plan.id}. Arquive ou exclua uma vaga para criar outra.` 
        });
      }
    }

    // Recebe todos os campos novos
    const { 
        title, 
        description, 
        requirements, 
        type, 
        location_type, 
        company_department_id 
    } = request.body;

    if (!title) return response.status(400).json({ error: 'O tÃ­tulo da vaga Ã© obrigatÃ³rio.' });
    
    // Prepara objeto de inserÃ§Ã£o com campos seguros
    const insertData = {
        title,
        tenantId,
        status: 'active',
        description: description || '',
        requirements: requirements || '',
        type: type || 'CLT',
        location_type: location_type || 'HÃ­brido',
        // Inicia com parÃ¢metros padrÃ£o se nÃ£o existirem
        parameters: { 
            triagem: [], 
            cultura: [], 
            tecnico: [], 
            notas: [
                {id: '1', nome: 'Abaixo', valor: 0},
                {id: '2', nome: 'Atende', valor: 50},
                {id: '3', nome: 'Supera', valor: 100}
            ] 
        }
    };

    // SÃ³ adiciona o departamento se ele vier preenchido
    if (company_department_id) {
        insertData.company_department_id = company_department_id;
    }
    
    const { data: newJob, error: insertError } = await supabaseAdmin
      .from('jobs')
      .insert(insertData)
      .select()
      .single();
      
    if (insertError) throw insertError;
    
    return response.status(201).json({ newJob });

  } catch (error) {
    console.error("Erro createJob:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}

==================================================
ARQUIVO: api\getApplicantsForJob.js
==================================================
// api/getApplicantsForJob.js (VERSÃƒO FINAL E CORRIGIDA)
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    // ValidaÃ§Ã£o do usuÃ¡rio (sem alteraÃ§Ãµes)
    const authHeader = request.headers['authorization'];
    if (!authHeader) return response.status(401).json({ error: 'NÃ£o autorizado.' });
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) return response.status(401).json({ error: 'Token invÃ¡lido.' });
    const { data: userData } = await supabaseAdmin.from('users').select('tenantId').eq('id', user.id).single();
    if (!userData) return response.status(404).json({ error: 'Perfil de usuÃ¡rio nÃ£o encontrado.' });
    const tenantId = userData.tenantId;
    const { jobId } = request.query;
    if (!jobId) return response.status(400).json({ error: 'O ID da vaga Ã© obrigatÃ³rio.' });

    // Busca a vaga e suas candidaturas de uma sÃ³ vez
    const { data: job, error: jobError } = await supabaseAdmin
      .from('jobs')
      .select(`
        id,
        tenantId,
        parameters,
        applications (
          id,
          created_at,
          evaluation,
          isHired,
          candidate:candidates ( id, name, email )
        )
      `)
      .eq('id', Number(jobId))
      .eq('tenantId', tenantId)
      .single();

    if (jobError || !job) {
      return response.status(404).json({ error: 'Vaga nÃ£o encontrada ou nÃ£o pertence Ã  sua empresa.' });
    }

    // Prepara os mapas para cÃ¡lculo (sem alteraÃ§Ãµes)
    const parameters = job.parameters || {};
    const notesMap = new Map((parameters.notas || []).map(note => [note.id, note.valor]));
    const weightsMap = {
      triagem: new Map((parameters.triagem || []).map(c => [c.name, c.weight])),
      cultura: new Map((parameters.cultura || []).map(c => [c.name, c.weight])),
      tÃ©cnico: new Map((parameters.tÃ©cnico || []).map(c => [c.name, c.weight])),
    };

    // Calcula as notas para cada candidatura
    const classifiedApplicants = job.applications.map(app => {
      const scores = { notaTriagem: 0, notaCultura: 0, notaTecnico: 0, notaGeral: 0 };
      if (app.evaluation) {
        ['triagem', 'cultura', 'tÃ©cnico'].forEach(section => {
          let sectionScore = 0;
          const sectionEvaluation = app.evaluation[section];
          if (sectionEvaluation) {
            for (const criterionName in sectionEvaluation) {
              if (criterionName !== 'anotacoes') {
                const noteId = sectionEvaluation[criterionName];
                const noteValue = notesMap.get(noteId) ?? 0;
                const weight = weightsMap[section]?.get(criterionName) ?? 0;
                sectionScore += (noteValue * weight) / 100;
              }
            }
          }
          if (section === 'triagem') scores.notaTriagem = sectionScore;
          if (section === 'cultura') scores.notaCultura = sectionScore;
          if (section === 'tÃ©cnico') scores.notaTecnico = sectionScore;
        });
        scores.notaGeral = scores.notaTriagem + scores.notaCultura + scores.notaTecnico;
      }

      // A CORREÃ‡ÃƒO ESTÃ AQUI: O campo 'isHired' foi restaurado
      return {
        applicationId: app.id,
        submissionDate: app.created_at,
        isHired: app.isHired,
        candidateName: app.candidate.name,
        candidateEmail: app.candidate.email,
        ...scores
      };
    });
    
    return response.status(200).json({ applicants: classifiedApplicants });

  } catch (error) {
    console.error("Erro na funÃ§Ã£o getApplicantsForJob:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}

==================================================
ARQUIVO: api\getApplicationDetails.js
==================================================
// api/getApplicationDetails.js (VersÃ£o Definitivamente Corrigida)
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    const authHeader = request.headers['authorization'];
    if (!authHeader) return response.status(401).json({ error: 'NÃ£o autorizado.' });
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) return response.status(401).json({ error: 'Token invÃ¡lido.' });

    const { data: userData } = await supabaseAdmin.from('users').select('tenantId').eq('id', user.id).single();
    if (!userData) return response.status(404).json({ error: 'Perfil de usuÃ¡rio nÃ£o encontrado.' });
    const tenantId = userData.tenantId;

    const { applicationId } = request.query;
    if (!applicationId) {
      return response.status(400).json({ error: 'O ID da candidatura Ã© obrigatÃ³rio.' });
    }

    const { data: application, error: applicationError } = await supabaseAdmin
      .from('applications')
      .select(`
        id,
        created_at,
        formData,
        resumeUrl,
        evaluation, 
        candidate:candidates ( * ),
        job:jobs ( title, parameters, tenantId )
      `)
      .eq('id', Number(applicationId))
      .single();

    if (applicationError) {
      if (applicationError.code === 'PGRST116') {
         return response.status(404).json({ error: 'Candidatura nÃ£o encontrada.' });
      }
      throw applicationError;
    }

    if (application.job.tenantId !== tenantId) {
      return response.status(403).json({ error: 'VocÃª nÃ£o tem permissÃ£o para ver esta candidatura.' });
    }

    return response.status(200).json({ application });

  } catch (error) {
    console.error("Erro na funÃ§Ã£o getApplicationDetails:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}

==================================================
ARQUIVO: api\getHiredApplicants.js
==================================================
// api/getHiredApplicants.js
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    // ValidaÃ§Ã£o do usuÃ¡rio de RH
    const authHeader = request.headers['authorization'];
    if (!authHeader) return response.status(401).json({ error: 'NÃ£o autorizado.' });
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) return response.status(401).json({ error: 'Token invÃ¡lido.' });
    
    const { data: userData } = await supabaseAdmin.from('users').select('tenantId').eq('id', user.id).single();
    if (!userData) return response.status(404).json({ error: 'Perfil de usuÃ¡rio nÃ£o encontrado.' });
    const tenantId = userData.tenantId;

    // Busca todas as candidaturas marcadas como 'isHired = true'
    const { data: hiredApplications, error: fetchError } = await supabaseAdmin
      .from('applications')
      .select(`
        id,
        hiredAt,
        formData,
        candidate:candidates ( name, email ),
        job:jobs ( id, title, tenantId )
      `)
      .eq('isHired', true);

    if (fetchError) throw fetchError;

    // Filtra no servidor para garantir que o usuÃ¡rio sÃ³ veja os aprovados do seu prÃ³prio tenant
    const tenantHired = hiredApplications.filter(app => app.job.tenantId === tenantId);

    return response.status(200).json({ hired: tenantHired });

  } catch (error) {
    console.error("Erro ao buscar candidatos contratados:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}

==================================================
ARQUIVO: api\getPublicJobData.js
==================================================
// api/getPublicJobData.js (VERSÃƒO FINAL E CORRIGIDA)
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    const { id: jobId } = request.query;
    if (!jobId) {
      return response.status(400).json({ error: 'O ID da vaga Ã© obrigatÃ³rio.' });
    }

    // A CORREÃ‡ÃƒO ESTÃ AQUI: Convertemos o jobId para Number()
    const { data: job, error: jobError } = await supabaseAdmin
      .from('jobs')
      .select(`
        title,
        tenantId,
        applications ( count )
      `)
      .eq('id', Number(jobId)) // Comparando nÃºmero com nÃºmero
      .single();

    if (jobError) throw jobError;

    const { data: tenant, error: tenantError } = await supabaseAdmin
      .from('tenants')
      .select('planId')
      .eq('id', job.tenantId)
      .single();
    
    if (tenantError) throw tenantError;
    
    const formattedJob = {
      title: job.title,
      candidateCount: job.applications[0] ? job.applications[0].count : 0,
      planId: tenant.planId
    };

    return response.status(200).json({ job: formattedJob });
  } catch (error) {
    console.error("Erro ao buscar dados pÃºblicos da vaga:", error);
    return response.status(500).json({ error: 'NÃ£o foi possÃ­vel buscar os dados da vaga.' });
  }
}

==================================================
ARQUIVO: api\getResumeSignedUrl.js
==================================================
// api/getResumeSignedUrl.js
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    // ValidaÃ§Ã£o de seguranÃ§a (sÃ³ usuÃ¡rios logados podem pedir links)
    const authHeader = request.headers['authorization'];
    if (!authHeader) return response.status(401).json({ error: 'NÃ£o autorizado.' });
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) return response.status(401).json({ error: 'Token invÃ¡lido.' });

    // Pega o caminho do arquivo que o frontend quer acessar
    const { filePath } = request.query;
    if (!filePath) {
      return response.status(400).json({ error: 'O caminho do arquivo Ã© obrigatÃ³rio.' });
    }

    // Gera uma URL assinada e segura, com validade de 60 segundos
    const { data, error: urlError } = await supabaseAdmin
      .storage
      .from('resumes')
      .createSignedUrl(filePath, 60); // 60 segundos de validade

    if (urlError) throw urlError;

    return response.status(200).json({ signedUrl: data.signedUrl });

  } catch (error) {
    console.error("Erro ao gerar URL assinada:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.' });
  }
}

==================================================
ARQUIVO: api\jobs.js
==================================================
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  // Usa a chave de serviÃ§o para ter acesso TOTAL (ignora RLS e permissÃµes)
  const supabaseAdmin = createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_KEY
  );

  try {
    // 1. AutenticaÃ§Ã£o BÃ¡sica
    const authHeader = request.headers['authorization'];
    if (!authHeader) throw new Error('Token ausente.');
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    
    if (userError || !user) throw new Error('Token invÃ¡lido.');

    // 2. Busca o Perfil para pegar o Tenant ID correto
    const { data: profile } = await supabaseAdmin
        .from('user_profiles')
        .select('tenantId, name, is_admin_system')
        .eq('id', user.id)
        .single();

    if (!profile || !profile.tenantId) {
        throw new Error('Perfil de usuÃ¡rio nÃ£o encontrado ou sem empresa.');
    }

    const tenantId = profile.tenantId;

    if (request.method === 'GET') {
        const { id } = request.query;

        // --- BUSCAS SEPARADAS (BLINDAGEM CONTRA ERRO DE TIPOS) ---

        // A. Busca Dados da Empresa
        const { data: tenant } = await supabaseAdmin
            .from('tenants')
            .select('companyName, planId')
            .eq('id', tenantId)
            .single();

        // B. Busca TODAS as Vagas deste Tenant
        const { data: jobs, error: jobsError } = await supabaseAdmin
            .from('jobs')
            .select('*') // Pega tudo, sem tentar join quebrado
            .eq('tenantId', tenantId);

        if (jobsError) throw jobsError;

        // C. Busca TODOS os Departamentos deste Tenant
        // (Aqui resolvemos o problema: O banco pode ter salvo como texto ou uuid, pegamos por string)
        const { data: departments } = await supabaseAdmin
            .from('company_departments')
            .select('id, name, tenantId'); 
            // Filtramos no cÃ³digo abaixo para garantir, caso o tipo no banco impeÃ§a o .eq()

        // D. Busca Contagem de Candidatos
        // Fazemos uma query raw ou agrupada para evitar join complexo
        const { data: applications } = await supabaseAdmin
            .from('applications')
            .select('jobId');

        // --- MONTAGEM DOS DADOS (MANUAL JOIN) ---
        
        // 1. Mapa de Contagem de Candidatos
        const candidateCounts = {};
        applications.forEach(app => {
            candidateCounts[app.jobId] = (candidateCounts[app.jobId] || 0) + 1;
        });

        // 2. Mapa de Departamentos (ID -> Nome)
        const deptMap = {};
        if (departments) {
            departments.forEach(d => {
                // Normaliza para string para garantir o match
                if (String(d.tenantId) === String(tenantId)) {
                    deptMap[d.id] = d.name;
                }
            });
        }

        // 3. Monta o Objeto Final para o Dashboard
        let formattedJobs = jobs.map(job => ({
            id: job.id,
            title: job.title,
            status: job.status,
            created_at: job.created_at,
            type: job.type,
            location_type: job.location_type,
            candidateCount: candidateCounts[job.id] || 0,
            // Aqui fazemos o vÃ­nculo manual que o banco estava recusando
            deptName: deptMap[job.company_department_id] || 'Geral'
        }));

        // 4. OrdenaÃ§Ã£o
        formattedJobs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        // Se for detalhe de uma vaga especÃ­fica
        if (id) {
            const specificJob = formattedJobs.find(j => j.id == id); // == para aceitar string/number
            if (!specificJob) return response.status(404).json({ error: 'Vaga nÃ£o encontrada.' });
            
            // Adiciona campos extras necessÃ¡rios para a tela de detalhes
            const rawJob = jobs.find(j => j.id == id);
            specificJob.description = rawJob.description;
            specificJob.requirements = rawJob.requirements;
            specificJob.parameters = rawJob.parameters;
            
            return response.status(200).json({ job: specificJob });
        }

        return response.status(200).json({
            jobs: formattedJobs,
            meta: {
                companyName: tenant?.companyName || 'Minha Empresa',
                userName: profile.name || user.email,
                planId: tenant?.planId || 'free',
                isAdmin: profile.is_admin_system
            }
        });
    }

    // POST (Escrita) - Mantido simples e direto
    if (request.method === 'POST') {
         const { action, jobId, newStatus } = request.body;
         
         if (action === 'updateJobStatus') {
            await supabaseAdmin.from('jobs').update({ status: newStatus }).eq('id', jobId);
            return response.status(200).json({ message: 'Atualizado' });
         }
         if (action === 'deleteJob') {
            await supabaseAdmin.from('applications').delete().eq('jobId', jobId);
            await supabaseAdmin.from('jobs').delete().eq('id', jobId);
            return response.status(200).json({ message: 'Deletado' });
         }
    }

    return response.status(405).json({ error: 'Method not allowed' });

  } catch (error) {
    console.error('API Error:', error.message);
    return response.status(500).json({ error: error.message });
  }
}

==================================================
ARQUIVO: api\saveEvaluation.js
==================================================
import { createClient } from '@supabase/supabase-js';
// Certifique-se de que o arquivo _utils/calculator.js existe conforme passo anterior
import { calculateWeightedScore } from './_utils/calculator.js'; 

export default async function handler(request, response) {
  if (request.method !== 'POST') return response.status(405).json({ error: 'MÃ©todo nÃ£o permitido' });

  const supabaseAdmin = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY);

  try {
    const authHeader = request.headers['authorization'];
    if (!authHeader) throw new Error('Token ausente.');
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: authError } = await supabaseAdmin.auth.getUser(token);
    
    if (authError || !user) throw new Error('Token invÃ¡lido.');

    const { applicationId, scores, notes } = request.body;

    // 1. Busca ParÃ¢metros da Vaga
    const { data: appData, error: appError } = await supabaseAdmin
        .from('applications')
        .select('job:jobs(parameters)')
        .eq('id', applicationId)
        .single();

    if (appError || !appData) throw new Error('Candidatura nÃ£o encontrada.');

    // 2. Calcula Nota (Backend)
    // A funÃ§Ã£o calculateWeightedScore deve tratar o 'N/A' ignorando o peso
    const finalScore = calculateWeightedScore(scores, appData.job.parameters);

    // 3. Salva na tabela EVALUATIONS (Confirmada nos metadados)
    const { error: saveError } = await supabaseAdmin
        .from('evaluations')
        .upsert({
            application_id: applicationId,
            evaluator_id: user.id,
            scores: scores,
            notes: notes,
            final_score: finalScore,
            updated_at: new Date()
        }, { onConflict: 'application_id, evaluator_id' });

    if (saveError) throw saveError;

    return response.status(200).json({ message: 'AvaliaÃ§Ã£o salva!', score: finalScore });

  } catch (error) {
    console.error('Save Error:', error);
    return response.status(500).json({ error: error.message });
  }
}

==================================================
ARQUIVO: api\updateHiredStatus.js
==================================================
// api/updateHiredStatus.js (VersÃ£o com data de contrataÃ§Ã£o)
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  if (request.method !== 'POST') {
    return response.status(405).json({ error: 'MÃ©todo nÃ£o permitido.' });
  }

  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    // ValidaÃ§Ã£o do usuÃ¡rio (sem alteraÃ§Ãµes)
    const authHeader = request.headers['authorization'];
    if (!authHeader) return response.status(401).json({ error: 'NÃ£o autorizado.' });
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) return response.status(401).json({ error: 'Token invÃ¡lido.' });
    
    const { applicationId, isHired } = request.body;
    if (!applicationId || typeof isHired !== 'boolean') {
      return response.status(400).json({ error: 'applicationId e isHired (booleano) sÃ£o obrigatÃ³rios.' });
    }

    // AQUI ESTÃ A LÃ“GICA ADITIVA:
    // Se estÃ¡ contratando, define a data atual. Se estÃ¡ "descontratando", define como nulo.
    const updateData = {
      isHired: isHired,
      hiredAt: isHired ? new Date().toISOString() : null
    };

    const { data, error: updateError } = await supabaseAdmin
      .from('applications')
      .update(updateData) // Usa o novo objeto de dados
      .eq('id', applicationId)
      .select()
      .single();

    if (updateError) throw updateError;

    return response.status(200).json({ message: 'Status do candidato atualizado com sucesso!', updatedApplication: data });

  } catch (error) {
    console.error("Erro ao atualizar status de contrataÃ§Ã£o:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}

==================================================
ARQUIVO: api\updateJobParameters.js
==================================================
// api/updateJobParameters.js
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  if (request.method !== 'POST') {
    response.setHeader('Allow', ['POST']);
    return response.status(405).json({ error: `MÃ©todo ${request.method} nÃ£o permitido.` });
  }

  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    // 1. Valida o token do usuÃ¡rio para garantir que ele estÃ¡ logado
    const authHeader = request.headers['authorization'];
    if (!authHeader) {
      return response.status(401).json({ error: 'NÃ£o autorizado.' });
    }
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) {
      return response.status(401).json({ error: 'Token invÃ¡lido.' });
    }

    // 2. Busca o tenantId do usuÃ¡rio para garantir que ele sÃ³ edite suas prÃ³prias vagas
    const { data: userData } = await supabaseAdmin.from('users').select('tenantId').eq('id', user.id).single();
    if (!userData) {
      return response.status(404).json({ error: 'Perfil de usuÃ¡rio nÃ£o encontrado.' });
    }
    const tenantId = userData.tenantId;

    // 3. Pega o ID da vaga e os novos parÃ¢metros do corpo da requisiÃ§Ã£o
    const { jobId, parameters } = request.body;
    if (!jobId || !parameters) {
      return response.status(400).json({ error: 'jobId e parameters sÃ£o obrigatÃ³rios.' });
    }

    // 4. Atualiza a vaga no banco de dados
    const { data, error: updateError } = await supabaseAdmin
      .from('jobs')
      .update({ parameters: parameters }) // Atualiza apenas a coluna 'parameters'
      .eq('id', jobId)                   // Onde o ID da vaga bate
      .eq('tenantId', tenantId)          // E ONDE a vaga pertence ao tenant do usuÃ¡rio (SEGURANÃ‡A)
      .select()
      .single();

    if (updateError) {
      // Se o erro for 'PGRST116', significa que a vaga nÃ£o foi encontrada (ou nÃ£o pertence ao tenant)
      if (updateError.code === 'PGRST116') {
        return response.status(404).json({ error: 'Vaga nÃ£o encontrada ou vocÃª nÃ£o tem permissÃ£o para editÃ¡-la.' });
      }
      throw updateError;
    }

    // 5. Retorna sucesso
    return response.status(200).json({ message: 'ParÃ¢metros salvos com sucesso!', updatedJob: data });

  } catch (error) {
    console.error("Erro na funÃ§Ã£o updateJobParameters:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}

==================================================
ARQUIVO: api\_utils\calculator.js
==================================================
// api/_utils/calculator.js
export function calculateWeightedScore(userScores, jobParameters) {
    if (!userScores || !jobParameters) return 0;

    // Converte lista de notas do banco em Mapa para acesso rÃ¡pido
    // Ex: { "uuid-nota-1": 0, "uuid-nota-2": 50, "uuid-nota-3": 100 }
    const notesMap = new Map((jobParameters.notas || []).map(n => [n.id, Number(n.valor)]));

    const sections = ['triagem', 'cultura', 'tecnico']; // SeÃ§Ãµes padrÃ£o
    let totalScore = 0;
    let totalMaxPossible = 0;

    sections.forEach(section => {
        const criteriaList = jobParameters[section] || []; // Ex: [{name: 'React', weight: 2}]
        const userSectionScores = userScores[section] || {}; // Ex: { 'React': 'uuid-nota-3' }

        criteriaList.forEach(criterion => {
            const noteId = userSectionScores[criterion.name];
            
            // LÃ“GICA DE N/A: Se a notaId for 'NA' ou nÃ£o existir, ignoramos este critÃ©rio
            if (!noteId || noteId === 'NA') return;

            const noteValue = notesMap.get(noteId); // Valor (0, 50, 100)
            const weight = Number(criterion.weight) || 1; // Peso (1x, 2x...)

            if (noteValue !== undefined) {
                totalScore += (noteValue * weight);
                totalMaxPossible += (100 * weight); // O mÃ¡ximo seria tirar 100 nesse critÃ©rio
            }
        });
    });

    // Evita divisÃ£o por zero se tudo for N/A
    if (totalMaxPossible === 0) return 0;

    // Normaliza para 0-100 com 1 casa decimal
    return Number(((totalScore / totalMaxPossible) * 100).toFixed(1));
}

==================================================
ARQUIVO: functions\.eslintrc.js
==================================================
module.exports = {
  root: true,
  env: {
    es6: true,
    node: true,
  },
  extends: [
    "eslint:recommended",
    "google",
  ],
  rules: {
    quotes: ["error", "double"],
  },
};

==================================================
ARQUIVO: functions\index.js
==================================================
const functions = require("firebase-functions");
const admin = require("firebase-admin");

admin.initializeApp();

exports.getJobsByTenant = functions.https.onCall(async (data, context) => {
  if (!context.auth) {
    throw new functions.https.HttpsError(
      "unauthenticated",
      "VocÃª precisa estar autenticado."
    );
  }

  const uid = context.auth.uid;
  const db = admin.firestore();

  try {
    const userDoc = await db.collection("users").doc(uid).get();
    if (!userDoc.exists) {
      throw new functions.https.HttpsError(
        "not-found",
        "UsuÃ¡rio nÃ£o encontrado."
      );
    }
    const tenantId = userDoc.data().tenantId;
    if (!tenantId) {
      throw new functions.https.HttpsError(
        "permission-denied",
        "UsuÃ¡rio sem tenantId."
      );
    }

    const jobsSnapshot = await db.collection("jobs").where("tenantId", "==", tenantId).get();
    const jobs = [];
    jobsSnapshot.forEach((doc) => {
      jobs.push({ id: doc.id, ...doc.data() });
    });

    return { jobs };

  } catch (error) {
    console.error("Erro ao buscar vagas:", error);
    throw new functions.https.HttpsError(
      "internal",
      "Ocorreu um erro ao buscar as vagas."
    );
  }
});

==================================================
ARQUIVO: functions\package.json
==================================================
{
  "name": "functions",
  "description": "Cloud Functions for Firebase",
  "scripts": {
    "lint": "eslint .",
    "serve": "firebase emulators:start --only functions",
    "shell": "firebase functions:shell",
    "start": "npm run shell",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log"
  },
  "engines": {
    "node": "20"
  },
  "main": "index.js",
  "dependencies": {
    "firebase-admin": "^11.11.1",
    "firebase-functions": "^3.24.1"
  },
  "devDependencies": {
    "eslint": "^8.15.0",
    "eslint-plugin-promise": "^6.0.0",
    "firebase-functions-test": "^0.2.0"
  },
  "private": true
}

==================================================
ARQUIVO: functions\functions\package.json
==================================================
{
  "dependencies": {
    "functions": "file:.."
  }
}


==================================================
ARQUIVO: src\App.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { supabase } from './supabase/client';
import Login from './pages/Login';
import Register from './pages/Register';
import Dashboard from './pages/Dashboard';
import JobDetails from './pages/JobDetails';
import ApplicationDetails from './pages/ApplicationDetails';
import Settings from './pages/Settings';
import ApplyJob from './pages/ApplyJob'; // NOVO IMPORT

export default function App() {
  const [session, setSession] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setLoading(false);
    });

    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
      setSession(session);
    });

    return () => subscription.unsubscribe();
  }, []);

  if (loading) return <div className="p-10 text-center">Carregando Sistema...</div>;

  return (
    <BrowserRouter>
      <Routes>
        {/* ROTAS PÃšBLICAS (Candidatos) */}
        <Route path="/apply/:jobId" element={<ApplyJob />} />

        {/* ROTAS DE AUTENTICAÃ‡ÃƒO */}
        <Route path="/login" element={!session ? <Login /> : <Navigate to="/" />} />
        <Route path="/register" element={!session ? <Register /> : <Navigate to="/" />} />
        
        {/* ROTAS PROTEGIDAS (Admin/Recrutador) */}
        <Route path="/" element={session ? <Dashboard /> : <Navigate to="/login" />} />
        <Route path="/jobs/:jobId" element={session ? <JobDetails /> : <Navigate to="/login" />} />
        <Route path="/applications/:appId" element={session ? <ApplicationDetails /> : <Navigate to="/login" />} />
        <Route path="/settings" element={session ? <Settings /> : <Navigate to="/login" />} />
      </Routes>
    </BrowserRouter>
  );
}

==================================================
ARQUIVO: src\index.css
==================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

body {
  @apply bg-gray-50 text-gray-900;
}

==================================================
ARQUIVO: src\main.jsx
==================================================
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.jsx'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)

==================================================
ARQUIVO: src\components\AreaSelect.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { supabase } from '../supabase/client';

export default function AreaSelect({ tenantId, value, onChange }) {
  const [departments, setDepartments] = useState([]);
  const [loading, setLoading] = useState(false);
  const [isCreating, setIsCreating] = useState(false);
  const [newName, setNewName] = useState('');

  useEffect(() => {
    if (tenantId) fetchDepts();
  }, [tenantId]);

  const fetchDepts = async () => {
    const { data } = await supabase
      .from('company_departments')
      .select('*')
      .eq('tenantId', tenantId)
      .order('name');
    setDepartments(data || []);
  };

  const handleCreate = async () => {
    if (!newName.trim()) return;
    setLoading(true);
    // Insere direto na tabela criada no SQL anterior
    const { data, error } = await supabase
      .from('company_departments')
      .insert({ name: newName, tenantId })
      .select()
      .single();
    
    if (!error && data) {
      setDepartments([...departments, data]);
      onChange(data.id); // Seleciona o novo
      setIsCreating(false);
      setNewName('');
    } else {
      alert('Erro ao criar departamento.');
    }
    setLoading(false);
  };

  if (isCreating) {
    return (
      <div className="flex gap-2 items-end">
        <div className="flex-1">
          <label className="block text-sm font-medium text-gray-700 mb-1">Nome da Nova Ãrea</label>
          <input 
            className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none"
            value={newName}
            onChange={e => setNewName(e.target.value)}
            placeholder="Ex: Financeiro"
            autoFocus
          />
        </div>
        <button 
          type="button"
          onClick={handleCreate} 
          disabled={loading}
          className="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 h-[42px]"
        >
          {loading ? '...' : 'Salvar'}
        </button>
        <button 
          type="button"
          onClick={() => setIsCreating(false)} 
          className="bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300 h-[42px]"
        >
          X
        </button>
      </div>
    );
  }

  return (
    <div>
      <label className="block text-sm font-medium text-gray-700 mb-1">Departamento / Ãrea</label>
      <select 
        className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white"
        value={value || ''}
        onChange={e => {
          if (e.target.value === 'NEW') setIsCreating(true);
          else onChange(e.target.value);
        }}
      >
        <option value="">Selecione...</option>
        {departments.map(d => (
          <option key={d.id} value={d.id}>{d.name}</option>
        ))}
        <option value="NEW" className="font-bold text-blue-600">+ Criar Nova Ãrea</option>
      </select>
    </div>
  );
}

==================================================
ARQUIVO: src\components\EvaluationForm.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { supabase } from '../supabase/client';
import { Save, UserCheck, MessageSquare } from 'lucide-react';
import { Box, Typography, Paper, Grid, Button, TextField, Alert } from '@mui/material';
import { processEvaluation } from '../utils/evaluationLogic';

export default function EvaluationForm({ applicationId, jobParameters, initialData, allEvaluations, onSaved }) {
  const [answers, setAnswers] = useState({ triagem: {}, cultura: {}, tecnico: {} });
  const [notes, setNotes] = useState('');
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    if (initialData) {
        setAnswers({
            triagem: initialData.triagem || {},
            cultura: initialData.cultura || {},
            tecnico: initialData.tecnico || {}
        });
        setNotes(initialData.anotacoes_gerais || '');
    }
  }, [initialData]);

  const currentScores = processEvaluation({ scores: answers }, jobParameters);

  const handleSelection = (section, criteriaName, noteId) => {
      setAnswers(prev => {
          const newSection = { ...prev[section] };
          if (newSection[criteriaName] === noteId) delete newSection[criteriaName];
          else newSection[criteriaName] = noteId;
          return { ...prev, [section]: newSection };
      });
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("UsuÃ¡rio nÃ£o logado");

      const finalCalc = processEvaluation({ scores: answers }, jobParameters);

      const payload = {
        triagem: answers.triagem,
        cultura: answers.cultura,
        tecnico: answers.tecnico,
        anotacoes_gerais: notes,
        pillar_scores: finalCalc,
        evaluator_name: user.email,
        updated_at: new Date()
      };

      const { error: evalError } = await supabase.from('evaluations').upsert({
            application_id: applicationId,
            evaluator_id: user.id,
            scores: payload, 
            notes: notes,
            final_score: finalCalc.total
        }, { onConflict: 'application_id, evaluator_id' });

      if (evalError) throw evalError;
      alert("Salvo!");
      if (onSaved) onSaved();
    } catch (error) { alert("Erro: " + error.message); } finally { setSaving(false); }
  };

  const renderSectionCompact = (key, title, criteria) => {
    if (!criteria?.length) return null;
    const ratingScale = jobParameters.notas || [];
    const tempScores = processEvaluation({ scores: answers }, jobParameters);
    
    return (
      <Paper variant="outlined" sx={{ p: 1.5, mb: 2, borderColor: '#e0e0e0', bgcolor: '#fff' }}>
        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 1 }}>
            <Typography variant="subtitle2" sx={{ fontWeight: 'bold', fontSize: '0.85rem', color: '#1976d2' }}>{title}</Typography>
            <Typography variant="caption" sx={{ fontWeight: 'bold', bgcolor: '#e3f2fd', px: 1, py: 0.5, borderRadius: 1 }}>Nota: {tempScores[key].toFixed(1)}</Typography>
        </Box>
        {criteria.map((crit, idx) => (
            <Box key={idx} sx={{ mb: 1.5, borderBottom: '1px dashed #eee', pb: 1 }}>
                <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 0.5 }}>
                    <Typography variant="caption" sx={{ fontWeight: 500, width: '80%', lineHeight: 1.2 }}>{crit.name}</Typography>
                    <Typography variant="caption" color="text.secondary">{crit.weight}%</Typography>
                </Box>
                <Box sx={{ display: 'flex', gap: 0.5, flexWrap: 'wrap' }}>
                    {ratingScale.map(option => (
                        <Button key={option.id} size="small" onClick={() => handleSelection(key, crit.name, option.id)}
                                sx={{ minWidth: '30px', height: '24px', fontSize: '0.65rem', p: '0 8px', textTransform: 'none', bgcolor: answers[key]?.[crit.name] === option.id ? '#1976d2' : '#f5f5f5', color: answers[key]?.[crit.name] === option.id ? '#fff' : '#666', '&:hover': { bgcolor: answers[key]?.[crit.name] === option.id ? '#1565c0' : '#eeeeee' } }}>
                            {option.nome}
                        </Button>
                    ))}
                </Box>
            </Box>
        ))}
      </Paper>
    );
  };

  if (!jobParameters) return <Typography variant="caption">Carregando...</Typography>;

  return (
    <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
      <Box sx={{ mb: 2, display: 'flex', justifyContent: 'space-between', alignItems: 'center', bgcolor: '#fff', p: 1.5, borderRadius: 1, border: '1px solid #e0e0e0' }}>
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <UserCheck size={16} color="#666" />
            <Typography variant="body2" sx={{ fontWeight: 'bold' }}>Minha AvaliaÃ§Ã£o</Typography>
        </Box>
        <Typography variant="h6" sx={{ fontWeight: 'bold', color: '#1976d2' }}>
            {currentScores.total.toFixed(1)} <Typography component="span" variant="caption" color="text.secondary">/10</Typography>
        </Typography>
      </Box>

      <Box sx={{ flex: 1, overflowY: 'auto', pr: 1 }}>
          <Grid container spacing={1}>
              <Grid item xs={12} md={4}>{renderSectionCompact("triagem", "Triagem", jobParameters.triagem)}</Grid>
              <Grid item xs={12} md={4}>{renderSectionCompact("cultura", "Fit Cultural", jobParameters.cultura)}</Grid>
              <Grid item xs={12} md={4}>{renderSectionCompact("tecnico", "TÃ©cnico", jobParameters.tecnico || jobParameters['tÃ©cnico'])}</Grid>
          </Grid>
          
          <Paper variant="outlined" sx={{ p: 2, mt: 1 }}>
            <Typography variant="caption" fontWeight="bold" color="text.secondary" sx={{ textTransform: 'uppercase', mb: 1, display: 'block' }}>Minhas AnotaÃ§Ãµes</Typography>
            <TextField multiline rows={2} fullWidth variant="outlined" size="small" value={notes} onChange={e => setNotes(e.target.value)} placeholder="ComentÃ¡rios..." sx={{ bgcolor: '#fff' }} InputProps={{ style: { fontSize: '0.8rem' } }} />
          </Paper>

          {/* HISTÃ“RICO DE TODAS AS ANOTAÃ‡Ã•ES */}
          <Box sx={{ mt: 3, borderTop: '1px solid #eee', pt: 2 }}>
              <Typography variant="caption" fontWeight="bold" color="text.secondary" sx={{ textTransform: 'uppercase', mb: 1, display: 'flex', alignItems: 'center', gap: 1 }}>
                  <MessageSquare size={14} /> HistÃ³rico de ObservaÃ§Ãµes ({allEvaluations?.length || 0})
              </Typography>
              {allEvaluations && allEvaluations.length > 0 ? allEvaluations.map((ev, i) => (
                  <Box key={i} sx={{ mb: 1, p: 1.5, bgcolor: '#f9fafb', borderRadius: 1, border: '1px solid #eee' }}>
                      <Box display="flex" justifyContent="space-between" mb={0.5}>
                          {/* Usa o nome mapeado ou fallback */}
                          <Typography variant="caption" fontWeight="bold" color="primary">{ev.evaluator_name || 'UsuÃ¡rio'}</Typography>
                          <Typography variant="caption" color="text.secondary">Nota: {Number(ev.final_score).toFixed(1)}</Typography>
                      </Box>
                      <Typography variant="body2" sx={{ fontSize: '0.8rem', color: '#444' }}>{ev.notes || ev.scores?.anotacoes_gerais || 'Sem comentÃ¡rios.'}</Typography>
                  </Box>
              )) : <Typography variant="caption" color="text.secondary">Nenhuma avaliaÃ§Ã£o registrada ainda.</Typography>}
          </Box>
      </Box>

      <Box sx={{ mt: 2, pt: 1, borderTop: '1px solid #eee' }}>
        <Button onClick={handleSave} disabled={saving} variant="contained" fullWidth color="primary" startIcon={<Save size={16}/>} sx={{ textTransform: 'none', fontWeight: 'bold' }}>{saving ? "Salvando..." : "Salvar Minha Nota"}</Button>
      </Box>
    </Box>
  );
}

==================================================
ARQUIVO: src\components\jobs\CreateJobModal.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { supabase } from '../../supabase/client';
import AreaSelect from '../AreaSelect';
import { AlertTriangle, Copy } from 'lucide-react';

export default function CreateJobModal({ open, onClose, onSuccess }) {
  const [tenantId, setTenantId] = useState(null);
  const [loading, setLoading] = useState(false);
  const [limitError, setLimitError] = useState(null);
  const [previousJobs, setPreviousJobs] = useState([]); // Lista de vagas para cÃ³pia
  const [copyFromId, setCopyFromId] = useState(''); // ID da vaga selecionada para cÃ³pia

  const [formData, setFormData] = useState({
    title: '', description: '', requirements: '', type: 'CLT', location_type: 'HÃ­brido', company_department_id: ''
  });

  useEffect(() => {
    if (open) {
      initialize();
    }
  }, [open]);

  const initialize = async () => {
    setLimitError(null);
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    // 1. Pega Tenant
    const { data: profile } = await supabase.from('user_profiles').select('tenantId').eq('id', user.id).single();
    if (!profile?.tenantId) return;
    setTenantId(profile.tenantId);

    // 2. Verifica Limites
    const { data: tenant } = await supabase.from('tenants').select('planId').eq('id', profile.tenantId).single();
    const { data: plan } = await supabase.from('plans').select('job_limit').eq('id', tenant.planId || 'freemium').single();
    
    const limit = plan?.job_limit || 2;
    const isUnlimited = limit === -1;

    const { count } = await supabase
        .from('jobs')
        .select('*', { count: 'exact', head: true })
        .eq('tenantId', profile.tenantId)
        .eq('status', 'active');

    if (!isUnlimited && count >= limit) {
        setLimitError(`Limite de vagas ativas atingido (${limit}).`);
    }

    // 3. Busca vagas anteriores para permitir cÃ³pia de critÃ©rios
    const { data: jobs } = await supabase
        .from('jobs')
        .select('id, title')
        .eq('tenantId', profile.tenantId)
        .order('created_at', { ascending: false });
    setPreviousJobs(jobs || []);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (limitError) return;
    
    setLoading(true);
    
    let parameters = {}; // PadrÃ£o vazio

    // Se escolheu copiar, busca os parÃ¢metros da vaga origem
    if (copyFromId) {
        const { data } = await supabase.from('jobs').select('parameters').eq('id', copyFromId).single();
        if (data?.parameters) {
            parameters = data.parameters;
        }
    } else {
        // ParÃ¢metros Default
        parameters = {
            triagem: [], cultura: [], tecnico: [],
            notas: [{id:'1',nome:'Abaixo',valor:0}, {id:'2',nome:'Atende',valor:50}, {id:'3',nome:'Supera',valor:100}]
        };
    }

    const payload = {
      ...formData,
      tenantId: tenantId,
      status: 'active',
      company_department_id: formData.company_department_id ? parseInt(formData.company_department_id) : null,
      parameters: parameters // Salva os critÃ©rios copiados ou padrÃ£o
    };

    const { error } = await supabase.from('jobs').insert(payload);

    if (error) alert('Erro: ' + error.message);
    else {
      setFormData({ title: '', description: '', requirements: '', type: 'CLT', location_type: 'HÃ­brido', company_department_id: '' });
      setCopyFromId('');
      onSuccess();
      onClose();
    }
    setLoading(false);
  };

  if (!open) return null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
      <div className="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div className="p-6 border-b flex justify-between items-center">
          <h2 className="text-xl font-bold">Nova Vaga</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">âœ•</button>
        </div>
        
        {limitError ? (
            <div className="p-6 text-center">
                <div className="bg-red-50 text-red-700 p-4 rounded border border-red-200 mb-4 flex items-start gap-3 text-left">
                    <AlertTriangle className="w-6 h-6 shrink-0" />
                    <div>
                        <p className="font-bold">Limite Atingido</p>
                        <p className="text-sm mt-1">{limitError}</p>
                    </div>
                </div>
                <button onClick={onClose} className="bg-gray-200 px-4 py-2 rounded">Fechar</button>
            </div>
        ) : (
            <form onSubmit={handleSubmit} className="p-6 space-y-4">
            
            {/* Seletor de CÃ³pia - NOVIDADE */}
            {previousJobs.length > 0 && (
                <div className="bg-blue-50 p-3 rounded border border-blue-100 mb-4">
                    <label className="block text-xs font-bold text-blue-800 mb-1 flex items-center gap-1">
                        <Copy size={12}/> Copiar critÃ©rios de avaliaÃ§Ã£o de:
                    </label>
                    <select 
                        className="w-full border p-2 rounded text-sm bg-white"
                        value={copyFromId}
                        onChange={e => setCopyFromId(e.target.value)}
                    >
                        <option value="">-- ComeÃ§ar do Zero --</option>
                        {previousJobs.map(j => (
                            <option key={j.id} value={j.id}>{j.title}</option>
                        ))}
                    </select>
                </div>
            )}

            <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">TÃ­tulo da Vaga *</label>
                <input required className="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-blue-500" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} />
            </div>

            {tenantId && <AreaSelect tenantId={tenantId} value={formData.company_department_id} onChange={val => setFormData({...formData, company_department_id: val})} />}

            <div className="grid grid-cols-2 gap-4">
                <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Modelo</label>
                <select className="w-full border p-2 rounded bg-white" value={formData.location_type} onChange={e => setFormData({...formData, location_type: e.target.value})}>
                    <option>Presencial</option><option>HÃ­brido</option><option>Remoto</option>
                </select>
                </div>
                <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Contrato</label>
                <select className="w-full border p-2 rounded bg-white" value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})}>
                    <option>CLT</option><option>PJ</option><option>EstÃ¡gio</option>
                </select>
                </div>
            </div>

            <div><label className="block text-sm font-medium text-gray-700 mb-1">DescriÃ§Ã£o</label><textarea className="w-full border p-2 rounded outline-none" rows="3" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">Requisitos</label><textarea className="w-full border p-2 rounded outline-none" rows="3" value={formData.requirements} onChange={e => setFormData({...formData, requirements: e.target.value})} /></div>

            <div className="flex justify-end gap-2 pt-4">
                <button type="button" onClick={onClose} className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">Cancelar</button>
                <button type="submit" disabled={loading} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50">{loading ? 'Criando...' : 'Criar Vaga'}</button>
            </div>
            </form>
        )}
      </div>
    </div>
  );
}

==================================================
ARQUIVO: src\components\jobs\JobCriteria.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { supabase } from '../../supabase/client';
import { Save, Plus, Trash2, Copy, AlertCircle, CheckCircle2 } from 'lucide-react';

export default function JobCriteria({ job, onUpdate }) {
  const defaultParams = {
    triagem: [],
    cultura: [],
    tecnico: [],
    notas: [
      { id: '1', nome: 'Abaixo', valor: 0 },
      { id: '2', nome: 'Atende', valor: 5 },
      { id: '3', nome: 'Supera', valor: 10 }
    ]
  };

  const [params, setParams] = useState(job.parameters || defaultParams);
  const [loading, setLoading] = useState(false);
  const [importJobId, setImportJobId] = useState('');
  const [allJobs, setAllJobs] = useState([]);

  useEffect(() => {
    const fetchJobs = async () => {
      const { data } = await supabase
        .from('jobs')
        .select('id, title')
        .neq('id', job.id)
        .order('created_at', { ascending: false });
      setAllJobs(data || []);
    };
    fetchJobs();
  }, [job.id]);

  // --- LÃ“GICA DE CRITÃ‰RIOS (PESOS) ---
  const getSectionTotal = (sectionKey) => {
    const items = params[sectionKey] || [];
    return items.reduce((acc, item) => acc + (Number(item.weight) || 0), 0);
  };

  const addItem = (section) => {
    const newItem = { name: '', weight: 0 };
    setParams({ ...params, [section]: [...(params[section] || []), newItem] });
  };

  const removeItem = (section, index) => {
    const newList = [...params[section]];
    newList.splice(index, 1);
    setParams({ ...params, [section]: newList });
  };

  const updateItem = (section, index, field, value) => {
    const newList = [...params[section]];
    newList[index][field] = value;
    setParams({ ...params, [section]: newList });
  };

  // --- LÃ“GICA DA RÃ‰GUA DE NOTAS (NOVA) ---
  const addNoteLevel = () => {
    const newNote = { id: crypto.randomUUID(), nome: '', valor: 0 };
    setParams({ ...params, notas: [...(params.notas || []), newNote] });
  };

  const removeNoteLevel = (index) => {
    const newNotas = [...params.notas];
    newNotas.splice(index, 1);
    setParams({ ...params, notas: newNotas });
  };

  const updateNoteLevel = (index, field, value) => {
    const newNotas = [...params.notas];
    newNotas[index][field] = value;
    setParams({ ...params, notas: newNotas });
  };

  // --- SALVAR E IMPORTAR ---
  const handleSave = async () => {
    // 1. ValidaÃ§Ã£o de Pesos
    const sections = ['triagem', 'cultura', 'tecnico'];
    const errors = [];

    sections.forEach(sec => {
      const total = getSectionTotal(sec);
      if ((params[sec] && params[sec].length > 0) && total !== 100) {
        errors.push(`A seÃ§Ã£o ${sec.toUpperCase()} soma ${total}% (deve ser 100%).`);
      }
    });

    // 2. ValidaÃ§Ã£o da RÃ©gua de Notas
    if (!params.notas || params.notas.length < 2) {
      errors.push("A RÃ©gua de Notas deve ter pelo menos 2 nÃ­veis (ex: Min e Max).");
    }

    if (errors.length > 0) {
      alert(`Erro de ValidaÃ§Ã£o:\n\n${errors.join('\n')}\n\nAjuste antes de salvar.`);
      return;
    }

    setLoading(true);
    const { error } = await supabase
      .from('jobs')
      .update({ parameters: params })
      .eq('id', job.id);

    if (error) alert("Erro ao salvar: " + error.message);
    else {
      alert("CritÃ©rios atualizados com sucesso!");
      if (onUpdate) onUpdate();
    }
    setLoading(false);
  };

  const importCriteria = async () => {
    if (!importJobId) return;
    const { data } = await supabase.from('jobs').select('parameters').eq('id', importJobId).single();
    if (data?.parameters) {
      setParams(data.parameters);
      alert("CritÃ©rios importados! Verifique os pesos e salve.");
    }
  };

  // --- RENDERIZADORES ---
  const renderSection = (title, key, color) => {
    const totalWeight = getSectionTotal(key);
    const isValid = totalWeight === 100;
    const isEmpty = !params[key] || params[key].length === 0;

    let statusColor = "text-gray-400";
    let statusIcon = null;
    let statusText = "Vazio (0%)";

    if (!isEmpty) {
      if (isValid) {
        statusColor = "text-green-600";
        statusIcon = <CheckCircle2 size={16} />;
        statusText = "Total: 100% (OK)";
      } else {
        statusColor = "text-red-600";
        statusIcon = <AlertCircle size={16} />;
        statusText = `Total: ${totalWeight}% (Faltam ${100 - totalWeight}%)`;
      }
    }

    return (
      <div className={`bg-gray-50 p-4 rounded border mb-4 ${!isEmpty && !isValid ? 'border-red-200 bg-red-50' : ''}`}>
        <div className="flex justify-between items-center mb-3">
          <div className="flex flex-col">
            <h3 className={`font-bold uppercase text-sm ${color}`}>{title}</h3>
            <div className={`text-xs font-bold flex items-center gap-1 mt-1 ${statusColor}`}>
              {statusIcon} {statusText}
            </div>
          </div>
          <button onClick={() => addItem(key)} className="text-xs flex items-center gap-1 text-blue-600 font-bold hover:underline">
            <Plus size={14}/> Adicionar CritÃ©rio
          </button>
        </div>
        
        {isEmpty && <p className="text-sm text-gray-400 italic">Nenhum critÃ©rio definido.</p>}

        <div className="space-y-2">
          {(params[key] || []).map((item, idx) => (
            <div key={idx} className="flex gap-2 items-center">
              <input 
                className="flex-1 border p-1 rounded text-sm outline-none focus:ring-1 focus:ring-blue-500"
                placeholder="Nome do CritÃ©rio (Ex: ComunicaÃ§Ã£o)"
                value={item.name}
                onChange={e => updateItem(key, idx, 'name', e.target.value)}
              />
              <div className="w-24 relative">
                <input 
                  type="number"
                  className="w-full border p-1 rounded text-sm text-center pr-6 outline-none focus:ring-1 focus:ring-blue-500"
                  placeholder="%"
                  value={item.weight}
                  onChange={e => updateItem(key, idx, 'weight', e.target.value)}
                />
                <span className="absolute right-2 top-1 text-gray-400 text-xs">%</span>
              </div>
              <button onClick={() => removeItem(key, idx)} className="text-red-500 hover:bg-red-100 p-1 rounded">
                <Trash2 size={14}/>
              </button>
            </div>
          ))}
        </div>
      </div>
    );
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-end border-b pb-4">
        <div>
          <h2 className="text-lg font-bold text-gray-800">ConfiguraÃ§Ã£o da AvaliaÃ§Ã£o</h2>
          <p className="text-sm text-gray-500">Defina os critÃ©rios e seus pesos (Soma deve ser 100%).</p>
        </div>
        
        <div className="flex gap-2 items-center">
          <select 
            className="border p-2 rounded text-sm max-w-[200px]"
            value={importJobId}
            onChange={e => setImportJobId(e.target.value)}
          >
            <option value="">Copiar de outra vaga...</option>
            {allJobs.map(j => <option key={j.id} value={j.id}>{j.title}</option>)}
          </select>
          <button onClick={importCriteria} disabled={!importJobId} className="bg-gray-200 p-2 rounded hover:bg-gray-300" title="Copiar">
            <Copy size={16}/>
          </button>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          {renderSection('Triagem (RH)', 'triagem', 'text-purple-600')}
          {renderSection('Fit Cultural', 'cultura', 'text-green-600')}
        </div>
        
        <div>
          {renderSection('TÃ©cnico / Hard Skills', 'tecnico', 'text-blue-600')}
          
          {/* CONFIGURAÃ‡ÃƒO DA RÃ‰GUA DE NOTAS (DINÃ‚MICA) */}
          <div className="bg-white p-4 rounded border shadow-sm border-l-4 border-l-orange-400">
            <div className="flex justify-between items-center mb-3">
              <div>
                <h3 className="font-bold uppercase text-sm text-gray-800">RÃ©gua de Notas</h3>
                <p className="text-xs text-gray-500">Defina os nÃ­veis e valores para o cÃ¡lculo.</p>
              </div>
              <button onClick={addNoteLevel} className="text-xs flex items-center gap-1 text-orange-600 font-bold hover:underline">
                <Plus size={14}/> Novo NÃ­vel
              </button>
            </div>

            <div className="space-y-2">
              <div className="flex gap-2 text-xs font-bold text-gray-400 px-1">
                <span className="flex-1">Nome do NÃ­vel</span>
                <span className="w-20 text-center">Nota</span>
                <span className="w-6"></span>
              </div>
              
              {(params.notas || []).map((nota, idx) => (
                <div key={idx} className="flex gap-2 items-center">
                  <input 
                    className="flex-1 border p-1 rounded text-sm outline-none focus:ring-1 focus:ring-orange-500"
                    value={nota.nome}
                    placeholder="Ex: Atende"
                    onChange={e => updateNoteLevel(idx, 'nome', e.target.value)}
                  />
                  <input 
                    type="number"
                    className="w-20 border p-1 rounded text-sm text-center outline-none focus:ring-1 focus:ring-orange-500"
                    value={nota.valor}
                    placeholder="0"
                    onChange={e => updateNoteLevel(idx, 'valor', e.target.value)}
                  />
                  <button onClick={() => removeNoteLevel(idx)} className="text-red-400 hover:text-red-600 p-1">
                    <Trash2 size={14}/>
                  </button>
                </div>
              ))}
              
              {(!params.notas || params.notas.length === 0) && (
                <p className="text-sm text-red-500 italic py-2 text-center bg-red-50 rounded">
                  Defina pelo menos 2 nÃ­veis de nota.
                </p>
              )}
            </div>
          </div>
        </div>
      </div>

      <div className="flex justify-end pt-4 border-t">
        <button 
          onClick={handleSave} 
          disabled={loading}
          className="bg-blue-600 text-white px-6 py-2 rounded flex items-center gap-2 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium shadow-sm"
        >
          <Save size={18}/> {loading ? 'Salvando...' : 'Salvar ConfiguraÃ§Ã£o'}
        </button>
      </div>
    </div>
  );
}

==================================================
ARQUIVO: src\pages\ApplicationDetails.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { supabase } from '../supabase/client';
import EvaluationForm from '../components/EvaluationForm';
import { ArrowLeft, Mail, MapPin, BookOpen, FileText, Download, Linkedin, Github, Phone, Calendar } from 'lucide-react';
import { Box, Grid, Paper, Typography, Button, CircularProgress, Divider, Avatar } from '@mui/material';
import { processEvaluation } from '../utils/evaluationLogic';
import { formatPhone, formatUrl } from '../utils/formatters';

export default function ApplicationDetails() {
  const { appId } = useParams();
  const navigate = useNavigate();
  
  const [appData, setAppData] = useState(null);
  const [job, setJob] = useState(null);
  const [currentUserEvaluation, setCurrentUserEvaluation] = useState(null);
  const [globalScore, setGlobalScore] = useState(0);
  const [evaluatorsCount, setEvaluatorsCount] = useState(0);
  const [allEvaluations, setAllEvaluations] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchData();
  }, [appId]);

  const fetchData = async () => {
    setLoading(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      const { data: application } = await supabase.from('applications').select('*, candidates(*)').eq('id', appId).single();
      const candidateObj = Array.isArray(application.candidates) ? application.candidates[0] : application.candidates;
      
      // Parse Seguro do formData
      let safeFormData = application.formData;
      if (typeof safeFormData === 'string') {
          try { safeFormData = JSON.parse(safeFormData); } catch(e) { console.log('Erro parse formData', e); }
      }
      
      setAppData({ ...application, formData: safeFormData, candidate: candidateObj });

      let jobParams = {};
      if (application.jobId) {
        const { data: jobData } = await supabase.from('jobs').select('*').eq('id', application.jobId).single();
        setJob(jobData);
        jobParams = jobData.parameters || {};
      }

      const { data: allEvals } = await supabase.from('evaluations').select('*').eq('application_id', appId);
      if (allEvals) {
          const userIds = [...new Set(allEvals.map(e => e.evaluator_id))];
          let usersMap = {};
          if (userIds.length > 0) {
              const { data: users } = await supabase.from('users').select('id, name, email').in('id', userIds);
              users?.forEach(u => usersMap[u.id] = u.name || u.email);
          }
          const evalsWithNames = allEvals.map(e => ({ ...e, evaluator_name: usersMap[e.evaluator_id] || 'Avaliador' }));
          setAllEvaluations(evalsWithNames);
          setEvaluatorsCount(evalsWithNames.length);
          
          let sumTotal = 0, validCount = 0;
          evalsWithNames.forEach(ev => {
              const scores = processEvaluation(ev, jobParams);
              if (scores.total > 0) { sumTotal += scores.total; validCount++; }
          });
          setGlobalScore(validCount > 0 ? (sumTotal / validCount) : 0);

          if (user) {
              const myEval = allEvals.find(e => e.evaluator_id === user.id);
              if (myEval) {
                  const myScores = processEvaluation(myEval, jobParams);
                  setCurrentUserEvaluation({ ...myEval.scores, anotacoes_gerais: myEval.notes || myEval.scores?.anotacoes_gerais, final_score: myScores.total });
              } else { setCurrentUserEvaluation(null); }
          }
      }
    } catch (err) { console.error(err); } finally { setLoading(false); }
  };

  const renderInfo = (data) => {
    if (!data) return null;
    
    // Suporte para estrutura plana (novo JSON) ou aninhada (antigo)
    const course = data.course || data.education?.course;
    const institution = data.institution || data.education?.institution;
    const year = data.completionYear || data.education?.date;
    const birth = data.birthDate;
    const eng = data.englishLevel;

    return (
        <>
            {/* Bloco FormaÃ§Ã£o */}
            <Box sx={{ mt: 3 }}>
                <Typography variant="caption" fontWeight="bold" sx={{textTransform: 'uppercase', color: 'text.secondary', display:'flex', alignItems:'center', gap:1}}>
                    <BookOpen size={14}/> FormaÃ§Ã£o
                </Typography>
                <Box sx={{ bgcolor: '#f9fafb', p: 1.5, borderRadius: 1, border: '1px solid #eee', mt: 0.5 }}>
                    <Typography variant="caption" display="block" fontWeight="bold">{course || 'Curso nÃ£o informado'}</Typography>
                    <Typography variant="caption" display="block" color="text.secondary">{institution || 'InstituiÃ§Ã£o nÃ£o informada'}</Typography>
                    {year && <Typography variant="caption" display="block" color="text.secondary">ConclusÃ£o: {year}</Typography>}
                </Box>
            </Box>

            {/* Bloco Extras (InglÃªs, Nasc) */}
            {(birth || eng) && (
                <Box sx={{ mt: 2 }}>
                    <Typography variant="caption" fontWeight="bold" sx={{textTransform: 'uppercase', color: 'text.secondary', display:'flex', alignItems:'center', gap:1}}>
                        <Calendar size={14}/> Detalhes
                    </Typography>
                    <Box sx={{ bgcolor: '#f9fafb', p: 1.5, borderRadius: 1, border: '1px solid #eee', mt: 0.5 }}>
                        {birth && <Typography variant="caption" display="block">Nascimento: {birth}</Typography>}
                        {eng && <Typography variant="caption" display="block">InglÃªs: {eng}</Typography>}
                    </Box>
                </Box>
            )}
        </>
    );
  };

  const renderScoreBadges = (gScore, myScore, count) => {
    const getBgColor = (s) => s >= 8 ? '#e8f5e9' : s >= 5 ? '#fff3e0' : '#ffebee';
    const getTextColor = (s) => s >= 8 ? '#2e7d32' : s >= 5 ? '#ef6c00' : '#c62828';
    return (
        <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 3, width: '100%' }}>
            <Paper elevation={0} sx={{ bgcolor: getBgColor(gScore), p: 2, borderRadius: 2, border: '1px solid', borderColor: 'divider', textAlign: 'center' }}>
                <Typography variant="subtitle2" sx={{ textTransform: 'uppercase', fontWeight: 'bold', color: 'text.secondary', fontSize: '0.75rem' }}>Nota Global</Typography>
                <Typography variant="caption" sx={{ display:'block', fontSize: '0.7rem', color: 'text.secondary', mb: 0.5 }}>({count} {count === 1 ? 'avaliaÃ§Ã£o' : 'avaliaÃ§Ãµes'})</Typography>
                <Typography variant="h3" sx={{ fontWeight: 800, color: getTextColor(gScore), lineHeight: 1 }}>{Number(gScore || 0).toFixed(1)}</Typography>
            </Paper>
            <Paper elevation={0} sx={{ bgcolor: '#f3f4f6', p: 2, borderRadius: 2, border: '1px solid', borderColor: 'divider', textAlign: 'center' }}>
                <Typography variant="subtitle2" sx={{ textTransform: 'uppercase', fontWeight: 'bold', color: 'text.secondary', fontSize: '0.75rem', mb: 1 }}>Minha Nota</Typography>
                <Typography variant="h3" sx={{ fontWeight: 800, color: '#374151', lineHeight: 1 }}>{Number(myScore || 0).toFixed(1)}</Typography>
            </Paper>
        </Box>
    );
  };

  if (loading) return <Box p={4} display="flex" justifyContent="center"><CircularProgress /></Box>;
  if (!appData) return <Box p={4} textAlign="center">Candidato nÃ£o encontrado.</Box>;

  const params = job?.parameters || {};
  const formData = appData.formData || {};
  const candidate = appData.candidate || {};
  
  // Mescla dados do formData com a tabela candidate
  const displayPhone = candidate.phone || formData.phone;
  const displayCity = candidate.city || formData.city;
  const displayState = candidate.state || formData.state;
  const linkedIn = candidate.linkedin_profile || formData.linkedinProfile || formData.linkedin_profile;
  const gitHub = candidate.github_profile || formData.githubProfile;

  return (
    <Box sx={{ bgcolor: '#f8f9fa', minHeight: '100vh', p: 2 }}>
      <Button onClick={() => navigate(-1)} startIcon={<ArrowLeft size={16}/>} sx={{ mb: 2, color: 'text.secondary' }}>Voltar</Button>
      <Grid container spacing={3}>
        <Grid item xs={12} md={3}>
          <Paper sx={{ p: 3, height: '100%' }} elevation={0} variant="outlined">
            <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', textAlign: 'center' }}>
              <Avatar sx={{ width: 80, height: 80, bgcolor: '#1976d2', fontSize: '2rem', mb: 2, fontWeight: 'bold' }}>{candidate.name?.[0]}</Avatar>
              <Typography variant="h6" sx={{ fontSize: '1.1rem', fontWeight: 'bold', lineHeight: 1.2 }}>{candidate.name}</Typography>
              <Typography variant="caption" color="text.secondary" sx={{ mb: 2 }}>{job?.title}</Typography>
              {renderScoreBadges(globalScore, currentUserEvaluation?.final_score, evaluatorsCount)}
            </Box>
            <Divider sx={{ my: 3 }} />
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5 }}>
                <Box display="flex" alignItems="center" gap={1.5}><Mail size={16} className="text-gray-400"/><Typography variant="body2" sx={{wordBreak: 'break-all'}}>{candidate.email || formData.email}</Typography></Box>
                <Box display="flex" alignItems="center" gap={1.5}><Phone size={16} className="text-gray-400"/><Typography variant="body2">{formatPhone(displayPhone)}</Typography></Box>
                <Box display="flex" alignItems="center" gap={1.5}><MapPin size={16} className="text-gray-400"/><Typography variant="body2">{displayCity} - {displayState}</Typography></Box>
            </Box>
            <Box sx={{ mt: 3, display: 'flex', flexDirection: 'column', gap: 1 }}>
                {candidate.resume_url && (<Button variant="contained" color="primary" fullWidth href={candidate.resume_url} target="_blank" startIcon={<Download size={18}/>} sx={{ mb: 1, textTransform: 'none', fontWeight: 'bold' }}>Ver CurrÃ­culo</Button>)}
                {linkedIn && (<Button variant="outlined" fullWidth href={formatUrl(linkedIn)} target="_blank" startIcon={<Linkedin size={16}/>} sx={{ textTransform: 'none', color: '#0077b5', borderColor: '#0077b5' }}>LinkedIn</Button>)}
                {gitHub && (<Button variant="outlined" fullWidth href={formatUrl(gitHub)} target="_blank" startIcon={<Github size={16}/>} sx={{ textTransform: 'none', color: '#333', borderColor: '#333' }}>GitHub</Button>)}
            </Box>
            <Divider sx={{ my: 3 }} />
            
            {renderInfo(formData)}

            <Box sx={{ mt: 3 }}>
               <Typography variant="caption" fontWeight="bold" sx={{textTransform: 'uppercase', color: 'text.secondary', display:'flex', alignItems:'center', gap:1}}><FileText size={14}/> MotivaÃ§Ã£o</Typography>
               <Typography variant="body2" paragraph sx={{ bgcolor: '#f9fafb', p: 1.5, borderRadius: 1, border: '1px solid #eee', mt: 1, whiteSpace: 'pre-line', fontSize: '0.85rem' }}>{formData.motivation || 'NÃ£o informada'}</Typography>
            </Box>
            <Box sx={{ mt: 2 }}><Typography variant="caption" color="text.secondary">Candidatou-se em: {new Date(appData.created_at).toLocaleDateString('pt-BR')}</Typography></Box>
          </Paper>
        </Grid>
        <Grid item xs={12} md={9}>
          <Paper sx={{ p: 0, height: '100%', overflow: 'hidden', bgcolor: 'transparent' }} elevation={0}>
             <EvaluationForm applicationId={appData.id} jobParameters={params} initialData={currentUserEvaluation} allEvaluations={allEvaluations} onSaved={fetchData} />
          </Paper>
        </Grid>
      </Grid>
    </Box>
  );
}

==================================================
ARQUIVO: src\pages\ApplyJob.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import { supabase } from '../supabase/client';
import { Building, MapPin, Briefcase, CheckCircle, Send, GraduationCap, User, Link as LinkIcon, FileText, Upload, Paperclip } from 'lucide-react';

export default function ApplyJob() {
  const { jobId } = useParams();
  const [job, setJob] = useState(null);
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [success, setSuccess] = useState(false);

  // Estados para Upload de Arquivo
  const [resumeType, setResumeType] = useState('file'); // 'file' ou 'link'
  const [resumeFile, setResumeFile] = useState(null);

  // Estado do FormulÃ¡rio
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    city: '',
    state: '',
    linkedin_profile: '',
    github_profile: '',
    resume_url: '', // SerÃ¡ preenchido automaticamente apÃ³s upload
    
    motivation: '',
    education_level: '',
    education_status: '',
    course_name: '',
    institution: '',
    conclusion_date: '',
    current_period: ''
  });

  useEffect(() => {
    fetchJobDetails();
  }, [jobId]);

  const fetchJobDetails = async () => {
    const { data, error } = await supabase
      .from('jobs')
      .select('title, description, requirements, location_type, type, status')
      .eq('id', jobId)
      .single();

    if (error || !data) {
      alert("Vaga nÃ£o encontrada ou encerrada.");
    } else {
      setJob(data);
    }
    setLoading(false);
  };

  const handleInputChange = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleFileChange = (e) => {
    if (e.target.files && e.target.files.length > 0) {
      setResumeFile(e.target.files[0]);
    }
  };

  const uploadResumeToStorage = async () => {
    if (!resumeFile) return null;

    const fileExt = resumeFile.name.split('.').pop();
    const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
    const filePath = `${fileName}`;

    // 1. Upload para o bucket 'resumes'
    const { error: uploadError } = await supabase.storage
      .from('resumes')
      .upload(filePath, resumeFile);

    if (uploadError) throw new Error("Erro no upload do arquivo: " + uploadError.message);

    // 2. Pegar URL pÃºblica
    const { data } = supabase.storage.from('resumes').getPublicUrl(filePath);
    return data.publicUrl;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setSubmitting(true);

    try {
      if (job.status !== 'active') throw new Error("Esta vaga nÃ£o estÃ¡ mais aceitando candidaturas.");
      
      let finalResumeUrl = formData.resume_url;

      // --- LÃ“GICA DE UPLOAD ---
      if (resumeType === 'file') {
        if (!resumeFile) throw new Error("Por favor, selecione um arquivo de currÃ­culo.");
        finalResumeUrl = await uploadResumeToStorage();
      } else {
        if (!formData.resume_url) throw new Error("Por favor, informe o link do currÃ­culo.");
      }

      // 1. Upsert Candidato
      const { data: candidate, error: candError } = await supabase
        .from('candidates')
        .upsert({
            email: formData.email,
            name: formData.name,
            phone: formData.phone,
            city: formData.city,
            state: formData.state,
            linkedin_profile: formData.linkedin_profile,
            github_profile: formData.github_profile,
            resume_url: finalResumeUrl, // Usa a URL gerada ou o link colado
            updated_at: new Date()
        }, { onConflict: 'email' }) // Isso agora vai funcionar com a constraint criada no SQL
        .select()
        .single();

      if (candError) throw candError;

      // 2. Prepara Application Data
      const appPayload = {
        motivation: formData.motivation,
        education: {
            level: formData.education_level,
            status: formData.education_status,
            course: formData.course_name,
            institution: formData.institution,
            date: formData.conclusion_date,
            period: formData.current_period
        },
        applied_at: new Date().toISOString()
      };

      // 3. Insert Application
      const { error: appError } = await supabase
        .from('applications')
        .insert({
            jobId: jobId,
            candidateId: candidate.id,
            status: 'new',
            formData: appPayload
        });

      if (appError) {
        if (appError.code === '23505') throw new Error("VocÃª jÃ¡ se candidatou para esta vaga.");
        throw appError;
      }

      setSuccess(true);

    } catch (err) {
      alert("Erro ao enviar: " + err.message);
    } finally {
      setSubmitting(false);
    }
  };

  const isSuperiorOrTech = ['tecnico', 'superior', 'pos', 'mestrado'].includes(formData.education_level);
  const isStudying = formData.education_status === 'cursando';
  const isCompleted = formData.education_status === 'completo';

  if (loading) return <div className="min-h-screen flex items-center justify-center bg-gray-50">Carregando...</div>;
  if (!job) return <div className="min-h-screen flex items-center justify-center bg-gray-50">Vaga indisponÃ­vel.</div>;

  if (success) {
    return (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
            <div className="bg-white p-8 rounded-lg shadow-md text-center max-w-md w-full border-t-4 border-green-500">
                <div className="flex justify-center mb-4">
                    <div className="bg-green-100 p-3 rounded-full">
                        <CheckCircle className="text-green-600 w-12 h-12" />
                    </div>
                </div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Candidatura Enviada!</h2>
                <p className="text-gray-600 mb-6">
                    Seus dados foram enviados com sucesso para a vaga de <strong>{job.title}</strong>.
                </p>
                <button onClick={() => window.location.reload()} className="text-blue-600 font-medium hover:underline text-sm">
                    Voltar para a vaga
                </button>
            </div>
        </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-10 px-4 font-sans">
      <div className="max-w-5xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden border border-gray-100">
        
        {/* Header da Vaga */}
        <div className="bg-slate-800 p-8 text-white relative">
            <h1 className="text-3xl font-bold mb-3">{job.title}</h1>
            <div className="flex flex-wrap gap-4 text-slate-300 text-sm font-medium">
                <span className="flex items-center gap-1 bg-slate-700 px-3 py-1 rounded-full"><Briefcase size={14}/> {job.type}</span>
                <span className="flex items-center gap-1 bg-slate-700 px-3 py-1 rounded-full"><MapPin size={14}/> {job.location_type}</span>
                <span className="flex items-center gap-1 bg-slate-700 px-3 py-1 rounded-full"><Building size={14}/> Novva R&S</span>
            </div>
        </div>

        <div className="grid lg:grid-cols-12">
            <div className="lg:col-span-5 p-8 bg-gray-50 border-r border-gray-100 sticky top-0 h-fit">
                <div className="space-y-8">
                    <div>
                        <h3 className="font-bold text-slate-800 text-lg mb-3 flex items-center gap-2">
                            <FileText size={20} className="text-blue-600"/> DescriÃ§Ã£o
                        </h3>
                        <p className="text-slate-600 whitespace-pre-line text-sm leading-relaxed">{job.description || "Sem descriÃ§Ã£o."}</p>
                    </div>
                    {job.requirements && (
                        <div>
                            <h3 className="font-bold text-slate-800 text-lg mb-3 flex items-center gap-2">
                                <CheckCircle size={20} className="text-green-600"/> Requisitos
                            </h3>
                            <p className="text-slate-600 whitespace-pre-line text-sm leading-relaxed">{job.requirements}</p>
                        </div>
                    )}
                </div>
            </div>

            <div className="lg:col-span-7 p-8 bg-white">
                <h2 className="text-2xl font-bold text-slate-800 mb-6 pb-2 border-b border-gray-100">Ficha de InscriÃ§Ã£o</h2>
                
                <form onSubmit={handleSubmit} className="space-y-8">
                    
                    {/* DADOS PESSOAIS */}
                    <section>
                        <h4 className="flex items-center gap-2 text-sm font-bold text-blue-600 uppercase mb-4 tracking-wide">
                            <User size={16}/> Dados BÃ¡sicos
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div className="md:col-span-2">
                                <label className="block text-xs font-bold text-gray-500 mb-1">Nome Completo *</label>
                                <input required className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                    value={formData.name} onChange={e => handleInputChange('name', e.target.value)} />
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-xs font-bold text-gray-500 mb-1">Email *</label>
                                <input required type="email" className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                    value={formData.email} onChange={e => handleInputChange('email', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">Telefone / Celular *</label>
                                <input required className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                    value={formData.phone} onChange={e => handleInputChange('phone', e.target.value)} />
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                                <div className="col-span-2">
                                    <label className="block text-xs font-bold text-gray-500 mb-1">Cidade</label>
                                    <input className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                        value={formData.city} onChange={e => handleInputChange('city', e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">UF</label>
                                    <select className="w-full border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-blue-100"
                                        value={formData.state} onChange={e => handleInputChange('state', e.target.value)}>
                                        <option value="">--</option>
                                        {['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'].map(uf => (
                                            <option key={uf} value={uf}>{uf}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </section>

                    {/* CURRÃCULO E LINKS (COM UPLOAD) */}
                    <section>
                        <h4 className="flex items-center gap-2 text-sm font-bold text-blue-600 uppercase mb-4 tracking-wide border-t border-gray-100 pt-6">
                            <Paperclip size={16}/> CurrÃ­culo e Links
                        </h4>
                        
                        {/* Toggle Tipo de CurrÃ­culo */}
                        <div className="bg-gray-50 p-4 rounded-lg border mb-4">
                            <label className="block text-xs font-bold text-gray-500 mb-2">Como deseja enviar seu currÃ­culo?</label>
                            <div className="flex gap-4 mb-4">
                                <label className="flex items-center gap-2 text-sm cursor-pointer">
                                    <input type="radio" name="resumeType" checked={resumeType === 'file'} onChange={() => setResumeType('file')} />
                                    <Upload size={16} className="text-gray-600"/> Enviar Arquivo (PDF/DOC)
                                </label>
                                <label className="flex items-center gap-2 text-sm cursor-pointer">
                                    <input type="radio" name="resumeType" checked={resumeType === 'link'} onChange={() => setResumeType('link')} />
                                    <LinkIcon size={16} className="text-gray-600"/> Colar Link (Drive/LinkedIn)
                                </label>
                            </div>

                            {resumeType === 'file' ? (
                                <div>
                                    <input 
                                      type="file" 
                                      accept=".pdf,.doc,.docx"
                                      onChange={handleFileChange}
                                      className="block w-full text-sm text-slate-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-full file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-blue-50 file:text-blue-700
                                        hover:file:bg-blue-100"
                                    />
                                    <p className="text-xs text-gray-400 mt-1">Formatos aceitos: PDF, DOC, DOCX. MÃ¡x 5MB.</p>
                                </div>
                            ) : (
                                <input 
                                    className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                    placeholder="Cole aqui o link do seu currÃ­culo..."
                                    value={formData.resume_url} 
                                    onChange={e => handleInputChange('resume_url', e.target.value)} 
                                />
                            )}
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">Linkedin (Opcional)</label>
                                <input className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                    placeholder="linkedin.com/in/..."
                                    value={formData.linkedin_profile} onChange={e => handleInputChange('linkedin_profile', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">GitHub / PortfÃ³lio (Opcional)</label>
                                <input className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                    placeholder="github.com/..."
                                    value={formData.github_profile} onChange={e => handleInputChange('github_profile', e.target.value)} />
                            </div>
                        </div>
                    </section>

                    {/* ESCOLARIDADE (CONDICIONAL) */}
                    <section>
                        <h4 className="flex items-center gap-2 text-sm font-bold text-blue-600 uppercase mb-4 tracking-wide border-t border-gray-100 pt-6">
                            <GraduationCap size={16}/> FormaÃ§Ã£o
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">NÃ­vel de Escolaridade *</label>
                                <select required className="w-full border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-blue-100"
                                    value={formData.education_level} onChange={e => handleInputChange('education_level', e.target.value)}
                                >
                                    <option value="">Selecione...</option>
                                    <option value="medio">Ensino MÃ©dio</option>
                                    <option value="tecnico">Ensino TÃ©cnico</option>
                                    <option value="superior">Superior (GraduaÃ§Ã£o)</option>
                                    <option value="pos">PÃ³s-GraduaÃ§Ã£o / MBA</option>
                                    <option value="mestrado">Mestrado / Doutorado</option>
                                </select>
                            </div>

                            {formData.education_level && (
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">Status *</label>
                                    <select required className="w-full border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-blue-100"
                                        value={formData.education_status} onChange={e => handleInputChange('education_status', e.target.value)}
                                    >
                                        <option value="">Selecione...</option>
                                        <option value="completo">Completo</option>
                                        <option value="cursando">Cursando</option>
                                        <option value="incompleto">Incompleto / Trancado</option>
                                    </select>
                                </div>
                            )}

                            {isSuperiorOrTech && formData.education_status && (
                                <>
                                    <div className="md:col-span-2">
                                        <label className="block text-xs font-bold text-gray-500 mb-1">Nome do Curso *</label>
                                        <input required className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                            value={formData.course_name} onChange={e => handleInputChange('course_name', e.target.value)} />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-xs font-bold text-gray-500 mb-1">InstituiÃ§Ã£o de Ensino *</label>
                                        <input required className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                            value={formData.institution} onChange={e => handleInputChange('institution', e.target.value)} />
                                    </div>
                                </>
                            )}

                            {isSuperiorOrTech && isStudying && (
                                <>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">PrevisÃ£o de Formatura *</label>
                                        <input required type="month" className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100" 
                                            value={formData.conclusion_date} onChange={e => handleInputChange('conclusion_date', e.target.value)} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">PerÃ­odo Atual *</label>
                                        <select required className="w-full border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-blue-100"
                                            value={formData.current_period} onChange={e => handleInputChange('current_period', e.target.value)}
                                        >
                                            <option value="">Selecione...</option>
                                            {[1,2,3,4,5,6,7,8,9,10].map(n => <option key={n} value={`${n}Âº Semestre`}>{n}Âº Semestre</option>)}
                                        </select>
                                    </div>
                                </>
                            )}

                            {isSuperiorOrTech && isCompleted && (
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">Ano de ConclusÃ£o *</label>
                                    <input required type="number" min="1970" max="2030" className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100" 
                                        value={formData.conclusion_date} onChange={e => handleInputChange('conclusion_date', e.target.value)} />
                                </div>
                            )}
                        </div>
                    </section>

                    {/* MOTIVAÃ‡ÃƒO */}
                    <section>
                        <h4 className="flex items-center gap-2 text-sm font-bold text-blue-600 uppercase mb-4 tracking-wide border-t border-gray-100 pt-6">
                            <FileText size={16}/> MotivaÃ§Ã£o
                        </h4>
                        <label className="block text-xs font-bold text-gray-500 mb-1">Por que vocÃª quer esta vaga?</label>
                        <textarea className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" rows="4" 
                            value={formData.motivation} onChange={e => handleInputChange('motivation', e.target.value)} />
                    </section>

                    <div className="pt-4">
                        <button 
                            disabled={submitting}
                            className="w-full bg-blue-600 text-white font-bold py-4 rounded-lg hover:bg-blue-700 transition flex justify-center items-center gap-2 shadow-lg disabled:opacity-70"
                        >
                           {submitting ? 'Enviando...' : <><Send size={18}/> Confirmar Candidatura</>}
                        </button>
                    </div>
                </form>
            </div>
        </div>
      </div>
    </div>
  );
}

==================================================
ARQUIVO: src\pages\Dashboard.jsx
==================================================
import React, { useState, useEffect, useMemo } from 'react';
import { supabase } from '../supabase/client';
import { useNavigate } from 'react-router-dom';
import CreateJobModal from '../components/jobs/CreateJobModal';
import { Briefcase, Users, Plus, Settings as SettingsIcon, Clock } from 'lucide-react';
import { differenceInDays, parseISO } from 'date-fns';

export default function Dashboard() {
  const navigate = useNavigate();
  const [profile, setProfile] = useState(null);
  const [jobs, setJobs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [deptFilter, setDeptFilter] = useState('all');
  const [fixing, setFixing] = useState(false);

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    setLoading(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      // 1. Busca Perfil
      const { data: userProfile } = await supabase
        .from('user_profiles')
        .select('*')
        .eq('id', user.id)
        .single();

      setProfile(userProfile);

      // 2. Se tiver Tenant, busca vagas
      if (userProfile?.tenantId) {
        const [jobsResult, deptsResult] = await Promise.all([
          // Busca vagas e jÃ¡ conta os candidatos na query (count)
          supabase.from('jobs').select('*, applications(count)').eq('tenantId', userProfile.tenantId),
          supabase.from('company_departments').select('*').eq('tenantId', userProfile.tenantId)
        ]);

        const rawJobs = jobsResult.data || [];
        const depts = deptsResult.data || [];
        
        const deptMap = {};
        depts.forEach(d => deptMap[d.id] = d.name);

        const processed = rawJobs.map(j => ({
          ...j,
          deptName: j.company_department_id ? (deptMap[j.company_department_id] || 'Geral') : 'Geral',
          // MÃ©trica 1: Quantidade de Inscritos
          candidateCount: j.applications?.[0]?.count || 0,
          // MÃ©trica 2: Dias em Aberto
          daysOpen: differenceInDays(new Date(), parseISO(j.created_at))
        }));

        // Ordena por data (mais recente primeiro)
        processed.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        setJobs(processed);
      }
    } catch (error) {
      console.error("Erro ao carregar:", error);
    } finally {
      setLoading(false);
    }
  };

  // FunÃ§Ã£o para corrigir contas sem tenant (Mantida do original para seguranÃ§a)
  const fixAccount = async () => {
    setFixing(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      
      const { data: newTenant, error: tError } = await supabase
        .from('tenants')
        .insert({ "companyName": "Minha Empresa" })
        .select()
        .single();
      if (tError) throw tError;

      const { error: pError } = await supabase
        .from('user_profiles')
        .upsert({
          id: user.id,
          name: user.email.split('@')[0],
          "tenantId": newTenant.id,
          role: 'admin'
        });
      if (pError) throw pError;

      alert("Conta configurada com sucesso!");
      fetchData();
    } catch (err) {
      alert("Erro ao configurar: " + err.message);
    } finally {
      setFixing(false);
    }
  };

  const filteredJobs = useMemo(() => {
    if (deptFilter === 'all') return jobs;
    return jobs.filter(j => j.deptName === deptFilter);
  }, [jobs, deptFilter]);

  const uniqueDepts = [...new Set(jobs.map(j => j.deptName))].sort();

  if (loading) return <div className="p-10 text-center">Carregando Dashboard...</div>;

  return (
    <div className="p-8 max-w-7xl mx-auto">
      {/* Header */}
      <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b pb-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Dashboard</h1>
          <div className="flex items-center gap-2 text-sm text-gray-500 mt-1">
            <span className="bg-gray-100 px-2 py-0.5 rounded text-gray-600">
              {profile?.name || 'UsuÃ¡rio'}
            </span>
            <span className="text-gray-300">|</span>
            <button onClick={() => navigate('/settings')} className="text-gray-600 hover:text-blue-600 flex items-center gap-1">
               <SettingsIcon size={14} /> ConfiguraÃ§Ãµes
            </button>
            <span className="text-gray-300">|</span>
            <button onClick={() => supabase.auth.signOut()} className="text-red-500 hover:underline">
              Sair
            </button>
          </div>
        </div>
        
        {profile?.tenantId && (
          <button 
            onClick={() => setIsModalOpen(true)}
            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center shadow transition"
          >
            <Plus className="w-4 h-4 mr-2" /> Nova Vaga
          </button>
        )}
      </div>

      {!profile?.tenantId ? (
        <div className="bg-yellow-50 border border-yellow-200 p-8 rounded-lg text-center shadow-sm max-w-2xl mx-auto">
          <h2 className="text-xl font-bold text-yellow-800 mb-2">Finalizar ConfiguraÃ§Ã£o da Conta</h2>
          <p className="text-yellow-700 mb-6">
            Bem-vindo ao Novva R&S! Para comeÃ§ar, precisamos configurar sua empresa.
          </p>
          <button 
            onClick={fixAccount} 
            disabled={fixing}
            className="bg-yellow-600 text-white px-6 py-3 rounded-md font-bold hover:bg-yellow-700 shadow transition"
          >
            {fixing ? 'Configurando...' : 'âš™ï¸ Configurar Minha Empresa Agora'}
          </button>
        </div>
      ) : (
        <>
          {/* KPI Cards */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div className="bg-white p-6 rounded shadow border border-gray-100 flex items-center gap-4">
              <div className="p-3 bg-blue-100 text-blue-600 rounded-full"><Briefcase size={24}/></div>
              <div>
                <p className="text-sm text-gray-500">Vagas Ativas</p>
                <p className="text-2xl font-bold">{jobs.filter(j => j.status === 'active').length}</p>
              </div>
            </div>
            <div className="bg-white p-6 rounded shadow border border-gray-100 flex items-center gap-4">
              <div className="p-3 bg-green-100 text-green-600 rounded-full"><Users size={24}/></div>
              <div>
                <p className="text-sm text-gray-500">Total Candidatos</p>
                <p className="text-2xl font-bold">{jobs.reduce((acc, j) => acc + j.candidateCount, 0)}</p>
              </div>
            </div>
          </div>

          {/* Tabela de Vagas */}
          <div className="bg-white rounded shadow border overflow-hidden">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
              <h2 className="font-semibold text-gray-700">Listagem de Vagas</h2>
              <div className="flex items-center gap-2">
                <span className="text-sm text-gray-500">Filtrar:</span>
                <select 
                  className="border p-1 rounded text-sm bg-white outline-none"
                  value={deptFilter}
                  onChange={e => setDeptFilter(e.target.value)}
                >
                  <option value="all">Todas as Ãreas</option>
                  {uniqueDepts.map(d => <option key={d} value={d}>{d}</option>)}
                </select>
              </div>
            </div>

            <table className="w-full text-left text-sm">
              <thead className="bg-gray-50 text-gray-500 border-b">
                <tr>
                  <th className="p-4 font-medium">Ãrea / Depto</th>
                  <th className="p-4 font-medium">TÃ­tulo</th>
                  {/* NOVAS COLUNAS */}
                  <th className="p-4 font-medium text-center">Inscritos</th>
                  <th className="p-4 font-medium text-center">Tempo</th>
                  <th className="p-4 font-medium">Status</th>
                  <th className="p-4 font-medium text-right">AÃ§Ã£o</th>
                </tr>
              </thead>
              <tbody>
                {filteredJobs.length === 0 ? (
                  <tr><td colSpan="6" className="p-8 text-center text-gray-500">Nenhuma vaga encontrada.</td></tr>
                ) : (
                  filteredJobs.map(job => (
                    <tr 
                      key={job.id} 
                      onClick={() => navigate(`/jobs/${job.id}`)}
                      className="border-b hover:bg-blue-50 transition cursor-pointer group"
                    >
                      <td className="p-4 text-gray-600">{job.deptName}</td>
                      <td className="p-4 font-bold text-gray-800 group-hover:text-blue-600">{job.title}</td>
                      
                      {/* DADOS ADICIONADOS */}
                      <td className="p-4 text-center">
                          <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-bold text-xs">{job.candidateCount}</span>
                      </td>
                      <td className="p-4 text-center text-gray-500 flex items-center justify-center gap-1">
                          <Clock size={14}/> {job.daysOpen} dias
                      </td>

                      <td className="p-4">
                        <span className={`px-2 py-1 rounded text-xs font-semibold ${job.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}`}>
                          {job.status === 'active' ? 'Ativa' : 'Inativa'}
                        </span>
                      </td>
                      <td className="p-4 text-right text-blue-600 font-medium">
                        Gerenciar â†’
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </>
      )}

      <CreateJobModal 
        open={isModalOpen} 
        onClose={() => setIsModalOpen(false)} 
        onSuccess={fetchData} 
      />
    </div>
  );
}

==================================================
ARQUIVO: src\pages\JobDetails.jsx
==================================================
import React, { useState, useEffect, useMemo } from 'react';
import { useParams, Link as RouterLink, useNavigate } from 'react-router-dom';
import { supabase } from '../supabase/client';
import { 
    Container, Typography, Box, AppBar, Toolbar, Button, CircularProgress, 
    Paper, Tabs, Tab, TextField, IconButton, Snackbar,
    List, ListItem, ListItemText, Divider, Grid,
    Table, TableHead, TableRow, TableCell, TableBody, Checkbox,
    FormControl, InputLabel, Select, MenuItem, Chip, Modal, Alert
} from '@mui/material';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine, LabelList } from 'recharts';
import { Delete as DeleteIcon, ContentCopy as ContentCopyIcon } from '@mui/icons-material';
import { processEvaluation } from '../utils/evaluationLogic';

// --- COMPONENTES AUXILIARES ---
const modalStyle = { position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 500, bgcolor: 'background.paper', boxShadow: 24, p: 4, borderRadius: 2 };

const CopyParametersModal = ({ open, onClose, currentJobId, onCopy }) => {
  const [jobs, setJobs] = useState([]);
  const [selectedJobId, setSelectedJobId] = useState('');
  useEffect(() => { if (open) { const f = async () => { const { data } = await supabase.from('jobs').select('id, title').neq('id', currentJobId).eq('status', 'active'); setJobs(data || []); }; f(); } }, [open, currentJobId]);
  const handleConfirm = async () => { if (!selectedJobId) return; const { data } = await supabase.from('jobs').select('parameters').eq('id', selectedJobId).single(); if (data?.parameters) onCopy(data.parameters); onClose(); };
  return ( <Modal open={open} onClose={onClose}><Box sx={modalStyle}><Typography variant="h6">Copiar de Vaga</Typography><FormControl fullWidth margin="normal"><InputLabel>Vaga</InputLabel><Select value={selectedJobId} onChange={e=>setSelectedJobId(e.target.value)} label="Vaga">{jobs.map(j=><MenuItem key={j.id} value={j.id}>{j.title}</MenuItem>)}</Select></FormControl><Box sx={{ mt: 3, display: 'flex', justifyContent: 'flex-end', gap: 1 }}><Button onClick={onClose}>Cancelar</Button><Button onClick={handleConfirm} variant="contained" disabled={!selectedJobId}>Copiar</Button></Box></Box></Modal> );
};

const ParametersSection = ({ criteria = [], onCriteriaChange }) => {
  const handleChange = (i, f, v) => { const n = [...criteria]; n[i] = { ...n[i], [f]: f==='weight'?Number(v):v }; onCriteriaChange(n); };
  const total = criteria.reduce((acc, c) => acc + (Number(c.weight)||0), 0);
  return (
    <Box sx={{mt:2}}>{criteria.map((c, i) => <Box key={i} display="flex" gap={2} mb={1}><TextField value={c.name} onChange={e=>handleChange(i,'name',e.target.value)} fullWidth size="small" label="CritÃ©rio" /><TextField type="number" value={c.weight} onChange={e=>handleChange(i,'weight',e.target.value)} sx={{width:100}} size="small" label="Peso %" /><IconButton onClick={()=>onCriteriaChange(criteria.filter((_,idx)=>idx!==i))} color="error"><DeleteIcon/></IconButton></Box>)}<Button onClick={()=>onCriteriaChange([...criteria, {name:'', weight:0}])} variant="outlined" size="small">Adicionar</Button><Typography color={total===100?'green':'red'} variant="caption" display="block" sx={{mt:1, fontWeight:'bold'}}>Total: {total}%</Typography></Box>
  );
};

export default function JobDetails() {
  const { jobId } = useParams();
  const [job, setJob] = useState(null);
  const [parameters, setParameters] = useState(null);
  const [loading, setLoading] = useState(true);
  const [tabValue, setTabValue] = useState(0);
  const [applicants, setApplicants] = useState([]);
  const [allEvaluations, setAllEvaluations] = useState([]);
  const [usersMap, setUsersMap] = useState({});
  const [evaluatorFilter, setEvaluatorFilter] = useState('all');
  const [isCopyModalOpen, setIsCopyModalOpen] = useState(false);
  const [feedback, setFeedback] = useState({ open: false, message: '', severity: 'success' });

  useEffect(() => {
    const fetchAllData = async () => {
      setLoading(true);
      try {
        const { data: jobData } = await supabase.from('jobs').select('*').eq('id', jobId).single();
        setJob(jobData);
        setParameters(jobData.parameters || { triagem: [], cultura: [], tecnico: [], notas: [] });

        const { data: appsData } = await supabase.from('applications').select('*, candidate:candidates(name, email)').eq('jobId', jobId);
        setApplicants(appsData || []);

        const appIds = (appsData || []).map(a => a.id);
        if (appIds.length > 0) {
            const { data: evalsData } = await supabase.from('evaluations').select('*').in('application_id', appIds);
            setAllEvaluations(evalsData || []);

            const userIds = [...new Set((evalsData || []).map(e => e.evaluator_id))];
            if (userIds.length > 0) {
                const { data: usersData } = await supabase.from('users').select('id, name, email').in('id', userIds);
                const map = {};
                usersData?.forEach(u => map[u.id] = u.name || u.email);
                setUsersMap(map);
            }
        }
      } catch (err) { console.error(err); } finally { setLoading(false); }
    };
    fetchAllData();
  }, [jobId]);

  const processedData = useMemo(() => {
    if (!parameters) return { chartData: [], evaluators: [] };

    const evaluators = Object.keys(usersMap).map(id => ({ id, name: usersMap[id] || 'Desconhecido' }));

    const chartData = applicants.map(app => {
        const appEvals = allEvaluations.filter(e => 
            String(e.application_id) === String(app.id) && 
            (evaluatorFilter === 'all' || e.evaluator_id === evaluatorFilter)
        );

        let sumT = 0, sumC = 0, sumTc = 0, count = 0, sumTotal = 0;
        appEvals.forEach(ev => {
            const scores = processEvaluation(ev, parameters);
            if (scores.total > 0 || scores.triagem > 0 || scores.cultura > 0 || scores.tecnico > 0) {
                sumT += scores.triagem; sumC += scores.cultura; sumTc += scores.tecnico; sumTotal += scores.total; count++;
            }
        });

        const avgT = count > 0 ? sumT / count : 0;
        const avgC = count > 0 ? sumC / count : 0;
        const avgTc = count > 0 ? sumTc / count : 0;
        const general = count > 0 ? sumTotal / count : 0;

        return {
            appId: app.id,
            name: app.candidate?.name || 'Sem Nome',
            email: app.candidate?.email,
            triagem: Number(avgT.toFixed(1)),
            cultura: Number(avgC.toFixed(1)),
            tecnico: Number(avgTc.toFixed(1)),
            total: Number(general.toFixed(1)),
            count: count,
            hired: app.isHired
        };
    }).sort((a, b) => b.total - a.total);

    return { chartData, evaluators };
  }, [applicants, allEvaluations, evaluatorFilter, parameters, usersMap]);

  const handleHireToggle = async (appId, currentStatus) => {
      const newStatus = !currentStatus;
      setApplicants(prev => prev.map(a => a.id === appId ? {...a, isHired: newStatus} : a));
      await supabase.from('applications').update({ isHired: newStatus }).eq('id', appId);
  };
  const handleSaveParameters = async () => {
      await supabase.from('jobs').update({ parameters }).eq('id', jobId);
      setFeedback({ open: true, message: 'Salvo!', severity: 'success' });
  };

  if (loading) return <Box p={5} display="flex" justifyContent="center"><CircularProgress /></Box>;

  return (
    <Box>
        <AppBar position="static" color="default" elevation={1}><Toolbar><Typography variant="h6" sx={{flexGrow:1}}>{job?.title}</Typography><Button color="inherit" component={RouterLink} to="/">Voltar</Button></Toolbar></AppBar>
        <Container maxWidth="xl" sx={{ mt: 4, mb: 4 }}>
            <Paper sx={{ mb: 3 }}><Tabs value={tabValue} onChange={(e, v) => setTabValue(v)} centered><Tab label="Candidatos" /><Tab label="ClassificaÃ§Ã£o" /><Tab label="ConfiguraÃ§Ãµes da Vaga" /></Tabs></Paper>
            
            {tabValue === 0 && (
                <Paper sx={{ p: 0 }}>
                    <Table>
                        <TableHead sx={{ bgcolor: '#f5f5f5' }}><TableRow><TableCell><strong>Nome</strong></TableCell><TableCell><strong>Email</strong></TableCell><TableCell align="center"><strong>AvaliaÃ§Ãµes</strong></TableCell><TableCell align="center"><strong>Nota Geral</strong></TableCell></TableRow></TableHead>
                        <TableBody>{processedData.chartData.map(d => (
                            <TableRow key={d.appId} hover component={RouterLink} to={`/applications/${d.appId}`} style={{textDecoration:'none', cursor:'pointer'}}>
                                <TableCell>{d.name}</TableCell>
                                <TableCell>{d.email}</TableCell>
                                <TableCell align="center"><Chip label={d.count} size="small" /></TableCell>
                                <TableCell align="center"><Chip label={d.total.toFixed(1)} color={d.total >= 8 ? 'success' : d.total >= 5 ? 'warning' : 'default'} variant={d.count > 0 ? 'filled' : 'outlined'}/></TableCell>
                            </TableRow>
                        ))}</TableBody>
                    </Table>
                </Paper>
            )}

            {tabValue === 1 && (
                <Grid container spacing={3}>
                    <Grid item xs={12} md={8}>
                        <Paper sx={{ p: 3, height: '600px', display: 'flex', flexDirection: 'column' }} elevation={3}>
                            {/* CABEÃ‡ALHO DO GRÃFICO MELHORADO */}
                            <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 3, pb: 2, borderBottom: '1px solid #f0f0f0' }}>
                                <Typography variant="h6" color="text.primary" fontWeight="bold">Comparativo de Desempenho</Typography>
                                <FormControl size="small" sx={{ minWidth: 220 }}>
                                    <InputLabel>Filtrar por Avaliador</InputLabel>
                                    <Select value={evaluatorFilter} label="Filtrar por Avaliador" onChange={(e) => setEvaluatorFilter(e.target.value)}>
                                        <MenuItem value="all">VisÃ£o Geral (MÃ©dia da Equipe)</MenuItem>
                                        {processedData.evaluators.map(ev => <MenuItem key={ev.id} value={ev.id}>{ev.name}</MenuItem>)}
                                    </Select>
                                </FormControl>
                            </Box>
                            
                            {processedData.chartData.some(d => d.total > 0) ? (
                                <Box sx={{ flex: 1, width: '100%', minHeight: 0 }}>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart 
                                            data={processedData.chartData} 
                                            layout="vertical" 
                                            margin={{ top: 10, right: 30, left: 10, bottom: 5 }} 
                                            barGap={4}
                                        >
                                            <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={true} stroke="#eee" />
                                            <XAxis type="number" domain={[0, 10]} ticks={[0, 2, 4, 6, 8, 10]} stroke="#999" />
                                            <YAxis 
                                                dataKey="name" 
                                                type="category" 
                                                width={150} // AUMENTADO PARA NÃƒO CORTAR NOMES
                                                style={{fontSize: '0.8rem', fontWeight: 500, fill: '#444'}} 
                                            />
                                            <Tooltip 
                                                cursor={{fill: '#f5f5f5'}}
                                                contentStyle={{ borderRadius: 8, border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}
                                                formatter={(val, name) => [val, name]} 
                                            />
                                            <Legend verticalAlign="top" height={40} iconType="circle" />
                                            
                                            <Bar dataKey="triagem" name="Triagem" fill="#90caf9" barSize={20} radius={[0, 4, 4, 0]}>
                                                <LabelList dataKey="triagem" position="right" style={{fontSize:'0.7rem', fill:'#666'}} formatter={(v)=>v>0?v:''}/>
                                            </Bar>
                                            <Bar dataKey="cultura" name="Fit Cultural" fill="#a5d6a7" barSize={20} radius={[0, 4, 4, 0]}>
                                                <LabelList dataKey="cultura" position="right" style={{fontSize:'0.7rem', fill:'#666'}} formatter={(v)=>v>0?v:''}/>
                                            </Bar>
                                            <Bar dataKey="tecnico" name="TÃ©cnico" fill="#ffcc80" barSize={20} radius={[0, 4, 4, 0]}>
                                                <LabelList dataKey="tecnico" position="right" style={{fontSize:'0.7rem', fill:'#666'}} formatter={(v)=>v>0?v:''}/>
                                            </Bar>
                                            
                                            {/* BARRA DE MÃ‰DIA GERAL DESTACADA */}
                                            <Bar dataKey="total" name="MÃ©dia Geral" fill="#4caf50" barSize={20} radius={[0, 4, 4, 0]}>
                                                <LabelList dataKey="total" position="right" style={{fontSize:'0.8rem', fontWeight:'bold', fill:'#2e7d32'}} />
                                            </Bar>
                                            
                                            <ReferenceLine x={5} stroke="red" strokeDasharray="3 3" />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </Box>
                            ) : (
                                <Box sx={{ flex: 1, display: 'flex', flexDirection:'column', alignItems: 'center', justifyContent: 'center', color: 'text.secondary', bgcolor:'#fafafa', borderRadius:2 }}>
                                    <Typography variant="body1">Ainda nÃ£o hÃ¡ dados suficientes.</Typography>
                                    <Typography variant="caption">Realize avaliaÃ§Ãµes para visualizar o grÃ¡fico.</Typography>
                                </Box>
                            )}
                        </Paper>
                    </Grid>
                    <Grid item xs={12} md={4}>
                        <Paper sx={{ height: '600px', display: 'flex', flexDirection: 'column' }} elevation={3}>
                            <Box sx={{ p: 2, bgcolor: '#f5f5f5', borderBottom: '1px solid #e0e0e0' }}><Typography variant="subtitle1" fontWeight="bold">Ranking Final</Typography></Box>
                            <List sx={{ overflowY: 'auto', flex: 1 }}>
                                {processedData.chartData.map((d, index) => (
                                    <React.Fragment key={d.appId}>
                                        <ListItem secondaryAction={<Checkbox checked={d.hired || false} onChange={() => handleHireToggle(d.appId, d.hired)} color="success" />}>
                                            <ListItemText 
                                                primary={<Typography variant="body2" fontWeight="bold">#{index + 1} {d.name}</Typography>} 
                                                secondary={<Typography variant="caption" color="text.secondary">MÃ©dia: <strong style={{color:'#2e7d32', fontSize:'0.9rem'}}>{d.total.toFixed(1)}</strong></Typography>} 
                                            />
                                        </ListItem>
                                        <Divider component="li" />
                                    </React.Fragment>
                                ))}
                            </List>
                        </Paper>
                    </Grid>
                </Grid>
            )}

            {tabValue === 2 && (
                <Box p={3} sx={{ bgcolor: 'white', borderRadius: 1, boxShadow: 1 }}>
                    <Paper variant="outlined" sx={{p:3, mb:3}}><Typography variant="subtitle1" fontWeight="bold" gutterBottom>1. Triagem</Typography><ParametersSection criteria={parameters?.triagem || []} onCriteriaChange={(c) => setParameters({...parameters, triagem: c})} /></Paper>
                    <Paper variant="outlined" sx={{p:3, mb:3}}><Typography variant="subtitle1" fontWeight="bold" gutterBottom>2. Fit Cultural</Typography><ParametersSection criteria={parameters?.cultura || []} onCriteriaChange={(c) => setParameters({...parameters, cultura: c})} /></Paper>
                    <Paper variant="outlined" sx={{p:3, mb:3}}><Typography variant="subtitle1" fontWeight="bold" gutterBottom>3. Teste TÃ©cnico</Typography><ParametersSection criteria={parameters?.tecnico || parameters?.['tÃ©cnico'] || []} onCriteriaChange={(c) => setParameters({...parameters, tecnico: c})} /></Paper>
                    <Box display="flex" justifyContent="flex-end"><Button variant="contained" color="primary" onClick={handleSaveParameters}>Salvar ConfiguraÃ§Ãµes</Button></Box>
                </Box>
            )}
        </Container>
        <CopyParametersModal open={isCopyModalOpen} onClose={() => setIsCopyModalOpen(false)} currentJobId={jobId} onCopy={(p) => { setParameters(p); setFeedback({open:true, message:'Copiado!', severity:'info'}); }} />
        <Snackbar open={feedback.open} autoHideDuration={4000} onClose={() => setFeedback({...feedback, open:false})}><Alert severity={feedback.severity} variant="filled">{feedback.message}</Alert></Snackbar>
    </Box>
  );
}

==================================================
ARQUIVO: src\pages\Login.jsx
==================================================
import React, { useState } from 'react';
import { supabase } from '../supabase/client';

export default function Login() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) alert(error.message);
    setLoading(false);
  };

  return (
    <div className="flex h-screen items-center justify-center bg-gray-100">
      <form onSubmit={handleLogin} className="p-8 bg-white rounded shadow-md w-96 border border-gray-200">
        <h1 className="text-2xl font-bold mb-6 text-center text-blue-600">Novva R&S 2.0</h1>
        <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input 
              className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
              placeholder="seu@email.com" 
              value={email} 
              onChange={e => setEmail(e.target.value)} 
            />
        </div>
        <div className="mb-6">
            <label className="block text-sm font-medium text-gray-700 mb-1">Senha</label>
            <input 
              className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
              type="password" 
              placeholder="********" 
              value={password} 
              onChange={e => setPassword(e.target.value)} 
            />
        </div>
        <button disabled={loading} className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition">
          {loading ? 'Entrando...' : 'Entrar'}
        </button>
      </form>
    </div>
  );
}

==================================================
ARQUIVO: src\pages\Register.jsx
==================================================
import React, { useState } from 'react';
import { supabase } from '../supabase/client';
import { Link, useNavigate } from 'react-router-dom';

export default function Register() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [companyId, setCompanyId] = useState('');
  const [loading, setLoading] = useState(false);
  const navigate = useNavigate();

  const handleRegister = async (e) => {
    e.preventDefault();
    setLoading(true);
    
    try {
      let tenantIdToUse = null;

      // 1. ValidaÃ§Ã£o PRÃ‰VIA do CÃ³digo da Empresa
      if (companyId.trim()) {
        const { data: tenant, error: tError } = await supabase
            .from('tenants')
            .select('id, planId')
            .eq('id', companyId.trim())
            .single();
        
        if (tError || !tenant) {
            setLoading(false);
            return alert("CÃ³digo da empresa invÃ¡lido.");
        }

        // Busca o plano usando user_limit
        const { data: plan } = await supabase
            .from('plans')
            .select('user_limit')
            .eq('id', tenant.planId || 'freemium')
            .single();
            
        const limit = plan?.user_limit || 1;
        const isUnlimited = limit === -1;

        // Conta usuÃ¡rios ativos
        const { count } = await supabase
            .from('user_profiles')
            .select('*', { count: 'exact', head: true })
            .eq('tenantId', tenant.id)
            .eq('active', true);

        if (!isUnlimited && count >= limit) {
            setLoading(false);
            return alert(`Esta empresa atingiu o limite de ${limit} usuÃ¡rios do plano. NÃ£o Ã© possÃ­vel entrar.`);
        }
        
        tenantIdToUse = tenant.id;
      }

      // 2. Cria usuÃ¡rio Auth
      const { data: authData, error: authError } = await supabase.auth.signUp({ email, password });
      if (authError) throw authError;

      const user = authData.user;
      if (user) {
        if (!tenantIdToUse) {
           // Cria nova empresa (Plano FREEMIUM padrÃ£o)
           const { data: newTenant } = await supabase
             .from('tenants')
             .insert({ "companyName": "Minha Nova Empresa", "planId": "freemium" })
             .select()
             .single();
           tenantIdToUse = newTenant?.id;
        }

        // 3. Cria Perfil
        if (tenantIdToUse) {
           await supabase.from('user_profiles').upsert({
             id: user.id,
             name: email.split('@')[0],
             "tenantId": tenantIdToUse,
             role: companyId.trim() ? 'user' : 'admin',
             active: true
           });
        }
      }

      alert("Cadastro realizado!");
      navigate('/');

    } catch (error) {
      alert("Erro: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="flex h-screen items-center justify-center bg-gray-100">
      <form onSubmit={handleRegister} className="p-8 bg-white rounded shadow-md w-96 border border-gray-200">
        <h1 className="text-2xl font-bold mb-2 text-center text-green-600">Criar Conta</h1>
        <p className="text-center text-gray-500 text-sm mb-6">Novva R&S 2.0</p>
        
        <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
            <input 
              className="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-green-500" 
              placeholder="seu@email.com" 
              value={email} 
              onChange={e => setEmail(e.target.value)}
              required 
            />
        </div>
        <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-1">Senha *</label>
            <input 
              className="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-green-500" 
              type="password" 
              placeholder="Min. 6 caracteres" 
              value={password} 
              onChange={e => setPassword(e.target.value)}
              required 
            />
        </div>
        
        <div className="mb-6 pt-4 border-t">
            <label className="block text-sm font-bold text-gray-700 mb-1">CÃ³digo de Convite</label>
            <input 
              className="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" 
              placeholder="Cole o ID da empresa (Opcional)" 
              value={companyId} 
              onChange={e => setCompanyId(e.target.value)}
            />
        </div>
        
        <button disabled={loading} className="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700 transition font-medium">
          {loading ? 'Validando...' : 'Cadastrar'}
        </button>
        <div className="mt-4 text-center text-sm">
          <Link to="/login" className="text-blue-600 hover:underline">Voltar para Login</Link>
        </div>
      </form>
    </div>
  );
}

==================================================
ARQUIVO: src\pages\Settings.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '../supabase/client';
import { Building, Users, Save, Shield, CheckCircle, XCircle, Trash2, ArrowLeft } from 'lucide-react';

export default function Settings() {
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState('company');
  const [loading, setLoading] = useState(true);
  const [currentUser, setCurrentUser] = useState(null);
  const [tenant, setTenant] = useState({ name: '', planId: '', planName: 'Carregando...', userLimit: 1 });
  const [team, setTeam] = useState([]);

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    setLoading(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { setLoading(false); return; }

      // Tenta buscar usuÃ¡rio
      const { data: userData } = await supabase.from('users').select('*').eq('id', user.id).maybeSingle();
      
      if (!userData) {
          // Se nÃ£o achar o usuÃ¡rio, nÃ£o trava a tela, apenas avisa no console
          console.warn("UsuÃ¡rio nÃ£o encontrado na tabela 'public.users'. Verifique o SQL.");
          setLoading(false);
          return;
      }

      setCurrentUser(userData);

      if (userData.tenantId) {
        const { data: tenantData } = await supabase.from('tenants').select('companyName, planId').eq('id', userData.tenantId).maybeSingle();
        
        if (tenantData) {
            let planInfo = { name: 'Desconhecido', limit: 1 };
            if (tenantData.planId) {
                const { data: plan } = await supabase.from('plans').select('name, user_limit').eq('id', tenantData.planId).maybeSingle();
                if(plan) planInfo = { name: plan.name, limit: plan.user_limit };
            }
            setTenant({ name: tenantData.companyName, planId: tenantData.planId, planName: planInfo.name, userLimit: planInfo.limit });
        }

        if (userData.isAdmin) {
            const { data: teamData } = await supabase.from('users').select('*').eq('tenantId', userData.tenantId).order('email');
            setTeam(teamData || []);
        }
      }
    } catch (error) {
      console.error("Erro silencioso:", error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) return <div className="p-10 text-center">Carregando...</div>;

  return (
    <div className="p-8 max-w-5xl mx-auto">
      <button onClick={() => navigate('/')} className="flex items-center text-gray-500 mb-6"><ArrowLeft className="mr-2"/> Voltar</button>
      <h1 className="text-3xl font-bold mb-6">ConfiguraÃ§Ãµes</h1>
      <div className="flex gap-6 border-b mb-6">
        <button onClick={() => setActiveTab('company')} className={`pb-3 px-1 border-b-2 ${activeTab === 'company' ? 'border-blue-600 text-blue-600' : 'border-transparent'}`}><Building className="inline mr-2"/> Minha Empresa</button>
        <button onClick={() => setActiveTab('team')} className={`pb-3 px-1 border-b-2 ${activeTab === 'team' ? 'border-blue-600 text-blue-600' : 'border-transparent'}`}><Users className="inline mr-2"/> Equipe</button>
      </div>
      
      {activeTab === 'company' && (
        <div className="bg-white p-6 rounded shadow border max-w-2xl">
            <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">Nome da Empresa</label>
                <input className="w-full border p-2 rounded" value={tenant.name} disabled />
            </div>
            <div className="bg-blue-50 p-4 rounded border border-blue-100">
                <p className="text-sm text-blue-900"><strong>Plano:</strong> {tenant.planName}</p>
            </div>
        </div>
      )}

      {activeTab === 'team' && (
        <div>
            {!currentUser?.isAdmin ? <p className="text-red-500">Acesso restrito.</p> : (
                <div className="bg-white rounded shadow border">
                    <table className="w-full text-left">
                        <thead><tr className="border-b bg-gray-50"><th className="p-4">Nome</th><th className="p-4">Email</th></tr></thead>
                        <tbody>
                            {team.map(u => <tr key={u.id} className="border-b"><td className="p-4">{u.name}</td><td className="p-4">{u.email}</td></tr>)}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
      )}
    </div>
  );
}

==================================================
ARQUIVO: src\supabase\client.js
==================================================
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Chaves do Supabase ausentes no arquivo .env');
}

export const supabase = createClient(supabaseUrl, supabaseAnonKey);

==================================================
ARQUIVO: src\utils\evaluationLogic.js
==================================================
// src/utils/evaluationLogic.js

export const calculatePillarScore = (sectionName, criteriaList, answers, ratingScale) => {
    // Se nÃ£o houver critÃ©rios ou respostas, retorna null (neutro)
    if (!criteriaList || !Array.isArray(criteriaList) || criteriaList.length === 0) return null;
    if (!answers) return null;
    
    let totalScore = 0;
    let totalWeightAnswered = 0;
    let hasAnswers = false;

    criteriaList.forEach(criterion => {
        // Tenta achar a resposta (suporta estrutura v2 aninhada ou v1 plana)
        const noteId = answers?.[sectionName]?.[criterion.name] || answers?.[criterion.name];
        
        // Ignora 'NA', null ou undefined
        if (noteId && noteId !== 'NA') {
            // CORREÃ‡ÃƒO CRÃTICA: Converte ambos para String para garantir o match (1 vs "1")
            const noteObj = ratingScale.find(n => String(n.id) === String(noteId));
            
            if (noteObj) {
                hasAnswers = true;
                const weight = Number(criterion.weight) || 0;
                
                // CÃ¡lculo: Valor da Nota * Peso
                totalScore += (Number(noteObj.valor) * weight);
                totalWeightAnswered += weight;
            }
        }
    });

    if (!hasAnswers || totalWeightAnswered === 0) return null;

    // Normaliza para escala 0-10
    return (totalScore / totalWeightAnswered);
};

export const processEvaluation = (evaluationObj, parameters) => {
    if (!evaluationObj || !parameters) {
        return { triagem: 0, cultura: 0, tecnico: 0, total: 0 };
    }

    const answers = evaluationObj.scores || evaluationObj; 
    const ratingScale = parameters.notas || [];
    
    const pTriagem = parameters.triagem || [];
    const pCultura = parameters.cultura || [];
    const pTecnico = parameters.tecnico || parameters['tÃ©cnico'] || parameters['tÃƒÂ©cnico'] || [];

    // Calcula parciais
    const triagem = calculatePillarScore('triagem', pTriagem, answers, ratingScale);
    const cultura = calculatePillarScore('cultura', pCultura, answers, ratingScale);
    const tecnico = calculatePillarScore('tecnico', pTecnico, answers, ratingScale);

    // MÃ©dia AritmÃ©tica Simples dos pilares respondidos
    let sum = 0;
    let count = 0;

    if (triagem !== null) { sum += triagem; count++; }
    if (cultura !== null) { sum += cultura; count++; }
    if (tecnico !== null) { sum += tecnico; count++; }

    // Se count for 0 (nenhum pilar avaliado), nota Ã© 0.
    const total = count > 0 ? (sum / count) : 0;

    return {
        triagem: triagem !== null ? Number(triagem) : 0,
        cultura: cultura !== null ? Number(cultura) : 0,
        tecnico: tecnico !== null ? Number(tecnico) : 0,
        total: Number(total)
    };
};

==================================================
ARQUIVO: src\utils\formatters.js
==================================================
import { format, parseISO } from 'date-fns';

export const formatStatus = (status) => {
  const statusMap = {
    active: 'Ativa',
    inactive: 'Inativa',
    filled: 'Preenchida',
  };
  return statusMap[status] || status;
};

export const formatPhone = (phone) => {
  if (!phone) return 'NÃ£o informado';
  const cleaned = phone.replace(/\D/g, '');
  if (cleaned.length === 11) {
    return `(${cleaned.substring(0, 2)}) ${cleaned.substring(2, 7)}-${cleaned.substring(7)}`;
  }
  if (cleaned.length === 10) {
    return `(${cleaned.substring(0, 2)}) ${cleaned.substring(2, 6)}-${cleaned.substring(6)}`;
  }
  return phone;
};

export const formatUrl = (url) => {
  if (!url) return '#';
  if (url.startsWith('http://') || url.startsWith('https://')) { return url; }
  return `//${url}`;
};

export const formatDate = (dateStr) => {
    if (!dateStr) return 'NÃ£o informado';
    try {
        return format(parseISO(dateStr), 'dd/MM/yyyy');
    } catch (error) {
        console.error("Erro ao formatar data:", dateStr, error);
        return 'Data invÃ¡lida';
    }
};

==================================================
ARQUIVO: src_old\App.jsx
==================================================
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider } from './context/AuthContext';
import PrivateRoute from './components/PrivateRoute';
import Layout from './components/Layout';

import Login from './pages/Login';
import Register from './pages/Register';
import Dashboard from './pages/Dashboard';
import JobDetails from './pages/JobDetails';
import ApplyPage from './pages/ApplyPage';
import Jobs from './pages/Jobs';
import Candidates from './pages/Candidates';
import CompanySettings from './pages/CompanySettings';
import Evaluation from './pages/Evaluation';

function App() {
  return (
    <Router>
      <AuthProvider>
        <Routes>
          {/* Rotas PÃºblicas */}
          <Route path="/login" element={<Login />} />
          <Route path="/register" element={<Register />} />
          <Route path="/vagas/:id/candidatar" element={<ApplyPage />} />

          {/* Rotas Privadas (Protegidas) */}
          <Route element={<PrivateRoute />}>
            {/* O Layout envolve todas as pÃ¡ginas internas */}
            <Route element={<Layout />}>
              <Route path="/" element={<Navigate to="/dashboard" replace />} />
              <Route path="/dashboard" element={<Dashboard />} />
              
              <Route path="/jobs" element={<Jobs />} />
              <Route path="/jobs/:id" element={<JobDetails />} />
              
              <Route path="/candidates" element={<Candidates />} />
              <Route path="/settings" element={<CompanySettings />} />
              <Route path="/evaluations/:applicationId" element={<Evaluation />} />
            </Route>
          </Route>

          <Route path="*" element={<Navigate to="/login" replace />} />
        </Routes>
      </AuthProvider>
    </Router>
  );
}

export default App;

==================================================
ARQUIVO: src_old\index.css
==================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Seus estilos globais extras aqui, se houver */
body {
  @apply bg-gray-50;
}

==================================================
ARQUIVO: src_old\main.jsx
==================================================
import React from 'react'
import ReactDOM from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom';
import App from './App.jsx'
import { AuthProvider } from './context/AuthContext.jsx';
import './index.css'

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <AuthProvider>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </AuthProvider>
  </React.StrictMode>,
)

==================================================
ARQUIVO: src_old\components\AreaSelect.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { supabase } from '../supabase/client';
import { Input } from './ui/input';
import { Button } from './ui/button';
import { Label } from './ui/label';
import { Loader2, Plus, X } from 'lucide-react';

export default function AreaSelect({ currentTenantId, selectedAreaId, onSelectArea, error }) {
  const [departments, setDepartments] = useState([]);
  const [isCreatingNew, setIsCreatingNew] = useState(false);
  const [newDeptName, setNewDeptName] = useState('');
  const [loading, setLoading] = useState(false);

  // Busca Ã¡reas da empresa atual
  useEffect(() => {
    if (!currentTenantId) return;

    async function fetchDepartments() {
      setLoading(true);
      try {
        const { data, error } = await supabase
          .from('company_departments')
          .select('id, name')
          .eq('tenantId', currentTenantId)
          .order('name', { ascending: true });

        if (error) throw error;
        setDepartments(data || []);
      } catch (error) {
        console.error('Erro ao buscar Ã¡reas:', error.message);
      } finally {
        setLoading(false);
      }
    }

    fetchDepartments();
  }, [currentTenantId]);

  // Salva nova Ã¡rea
  const handleSaveNew = async () => {
    if (!newDeptName.trim()) return;
    try {
      setLoading(true);
      const { data, error } = await supabase
        .from('company_departments')
        .insert([{ 
          name: newDeptName.trim(), 
          tenantId: currentTenantId 
        }])
        .select()
        .single();

      if (error) throw error;

      setDepartments([...departments, data]);
      onSelectArea(data.id);
      setIsCreatingNew(false);
      setNewDeptName('');
    } catch (error) {
      alert('Erro ao criar Ã¡rea: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  if (loading && departments.length === 0) {
    return <div className="text-sm text-gray-500 flex items-center"><Loader2 className="w-3 h-3 animate-spin mr-2"/> Carregando Ã¡reas...</div>;
  }

  // Modo de CriaÃ§Ã£o (Input de Texto)
  if (isCreatingNew) {
    return (
      <div className="mb-4 p-4 border border-blue-100 bg-blue-50 rounded-md">
        <Label>Nome da Nova Ãrea</Label>
        <div className="flex gap-2">
          <Input
            value={newDeptName}
            onChange={(e) => setNewDeptName(e.target.value)}
            placeholder="Ex: Marketing, TI..."
            autoFocus
          />
        </div>
        <div className="flex justify-end gap-2 mt-3">
            <Button 
                type="button"
                variant="ghost" 
                size="sm"
                onClick={() => setIsCreatingNew(false)}
            >
                Cancelar
            </Button>
            <Button 
                type="button"
                size="sm"
                onClick={handleSaveNew}
                disabled={!newDeptName.trim() || loading}
            >
                {loading ? <Loader2 className="w-4 h-4 animate-spin"/> : 'Salvar'}
            </Button>
        </div>
      </div>
    );
  }

  // Modo de SeleÃ§Ã£o (Dropdown Nativo Estilizado)
  return (
    <div className="mb-4">
      <Label>Ãrea / Departamento</Label>
      <select
        className="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
        value={selectedAreaId || ''}
        onChange={(e) => {
          if (e.target.value === 'NEW') setIsCreatingNew(true);
          else onSelectArea(e.target.value);
        }}
      >
        <option value="">Selecione uma Ã¡rea...</option>
        {departments.map((dept) => (
          <option key={dept.id} value={dept.id}>
            {dept.name}
          </option>
        ))}
        <option value="NEW" className="font-bold text-blue-600 bg-blue-50">
          + Cadastrar Nova Ãrea
        </option>
      </select>
      {error && <p className="text-sm text-red-500 mt-1">{error}</p>}
    </div>
  );
}

==================================================
ARQUIVO: src_old\components\Layout.jsx
==================================================
import { useState } from 'react';
import { Outlet, Link, useLocation, useNavigate } from 'react-router-dom';
import { supabase } from '../supabase/client';
import { 
  LayoutDashboard, 
  Briefcase, 
  Users, 
  Settings, 
  LogOut, 
  Menu, 
  X 
} from 'lucide-react';
import { Button } from './ui/button';

export default function Layout() {
  const location = useLocation();
  const navigate = useNavigate();
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);

  const navigation = [
    { name: 'Dashboard', href: '/dashboard', icon: LayoutDashboard },
    { name: 'Vagas', href: '/jobs', icon: Briefcase },
    { name: 'Candidatos', href: '/candidates', icon: Users },
    { name: 'ConfiguraÃ§Ãµes', href: '/settings', icon: Settings },
  ];

  const handleLogout = async () => {
    await supabase.auth.signOut();
    navigate('/login');
  };

  const NavItem = ({ item }) => {
    const isActive = location.pathname.startsWith(item.href);
    return (
      <Link
        to={item.href}
        onClick={() => setIsSidebarOpen(false)}
        className={`flex items-center px-4 py-3 text-sm font-medium rounded-md transition-colors ${
          isActive 
            ? 'bg-blue-50 text-blue-700' 
            : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'
        }`}
      >
        <item.icon className={`mr-3 h-5 w-5 ${isActive ? 'text-blue-700' : 'text-gray-400'}`} />
        {item.name}
      </Link>
    );
  };

  return (
    <div className="min-h-screen bg-gray-50 flex">
      {/* Sidebar Mobile Overlay */}
      {isSidebarOpen && (
        <div 
          className="fixed inset-0 z-40 bg-gray-600 bg-opacity-75 lg:hidden"
          onClick={() => setIsSidebarOpen(false)}
        />
      )}

      {/* Sidebar Navigation */}
      <div className={`
        fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 transform transition-transform duration-200 ease-in-out lg:translate-x-0 lg:static lg:inset-0
        ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}
      `}>
        <div className="flex items-center justify-between h-16 px-6 border-b border-gray-200">
          <span className="text-xl font-bold text-blue-600 tracking-tight">Novva R&S</span>
          <button onClick={() => setIsSidebarOpen(false)} className="lg:hidden">
            <X className="h-6 w-6 text-gray-500" />
          </button>
        </div>
        
        <nav className="p-4 space-y-1">
          {navigation.map((item) => (
            <NavItem key={item.name} item={item} />
          ))}
        </nav>

        <div className="absolute bottom-0 w-full p-4 border-t border-gray-200">
          <Button 
            variant="ghost" 
            className="w-full justify-start text-red-600 hover:text-red-700 hover:bg-red-50"
            onClick={handleLogout}
          >
            <LogOut className="mr-3 h-5 w-5" />
            Sair
          </Button>
        </div>
      </div>

      {/* Main Content Area */}
      <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
        {/* Mobile Header */}
        <div className="lg:hidden flex items-center justify-between bg-white border-b border-gray-200 px-4 py-2">
          <span className="font-semibold text-gray-700">Menu</span>
          <button 
            onClick={() => setIsSidebarOpen(true)}
            className="p-2 -mr-2 text-gray-500 hover:text-gray-700"
          >
            <Menu className="h-6 w-6" />
          </button>
        </div>

        {/* Page Content */}
        <main className="flex-1 overflow-y-auto p-4 sm:p-8">
          <Outlet />
        </main>
      </div>
    </div>
  );
}

==================================================
ARQUIVO: src_old\components\PrivateRoute.jsx
==================================================
import { Navigate, Outlet } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import LoadingSpinner from './common/LoadingSpinner';

export default function PrivateRoute() {
  // CORREÃ‡ÃƒO: Mudado de 'user' para 'currentUser' para bater com o AuthContext
  const { currentUser, loading } = useAuth();

  if (loading) {
    return <LoadingSpinner />;
  }

  // Se tem usuÃ¡rio, libera. Se nÃ£o, manda pro login.
  return currentUser ? <Outlet /> : <Navigate to="/login" replace />;
}

==================================================
ARQUIVO: src_old\components\charts\ClassificationChart.jsx
==================================================
import React from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LabelList } from 'recharts';

const ClassificationChart = ({ data }) => {
  return (
    <div className="w-full h-[300px] mt-4">
      <ResponsiveContainer>
        <BarChart
          layout="vertical"
          data={data}
          margin={{ top: 5, right: 30, left: 100, bottom: 5 }}
        >
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis type="number" />
          <YAxis dataKey="candidateName" type="category" width={150} />
          <Tooltip />
          <Legend />
          <Bar dataKey="notaTriagem" stackId="a" fill="#3f51b5" name="Nota Triagem">
            <LabelList dataKey="notaTriagem" position="center" fill="#fff" formatter={(value) => value.toFixed(1)} />
          </Bar>
          <Bar dataKey="notaCultura" stackId="a" fill="#8884d8" name="Nota Cultura">
             <LabelList dataKey="notaCultura" position="center" fill="#fff" formatter={(value) => value.toFixed(1)} />
          </Bar>
          <Bar dataKey="notaTecnico" stackId="a" fill="#82ca9d" name="Nota TÃ©cnico">
             <LabelList dataKey="notaTecnico" position="center" fill="#fff" formatter={(value) => value.toFixed(1)} />
          </Bar>
        </BarChart>
      </ResponsiveContainer>
    </div>
  );
};

export default ClassificationChart;

==================================================
ARQUIVO: src_old\components\common\LoadingSpinner.jsx
==================================================
import React from 'react';
import { Loader2 } from 'lucide-react';

const LoadingSpinner = () => {
    return (
        <div className="flex h-screen w-screen items-center justify-center bg-gray-50">
            <Loader2 className="h-10 w-10 animate-spin text-blue-600" />
        </div>
    );
};

export default LoadingSpinner;

==================================================
ARQUIVO: src_old\components\evaluation_v2\EvaluationDashboardV2.jsx
==================================================
import React, { useEffect, useState } from 'react';
import { prepareEvaluationV2, getEvaluationSummaryV2 } from '../../services/evaluationService';
import { supabase } from '../../supabase/client';

export default function EvaluationDashboardV2({ applicationId, jobId, currentUser }) {
  const [loading, setLoading] = useState(true);
  const [summary, setSummary] = useState(null);
  const [viewMode, setViewMode] = useState('summary'); // 'summary' ou 'evaluate'

  useEffect(() => {
    const init = async () => {
      try {
        setLoading(true);
        // Garante que o banco estÃ¡ pronto
        await prepareEvaluationV2(jobId);
        // Carrega dados
        const data = await getEvaluationSummaryV2(applicationId);
        setSummary(data);
      } catch (error) {
        console.error("Erro ao carregar V2:", error);
      } finally {
        setLoading(false);
      }
    };
    if (jobId && applicationId) init();
  }, [applicationId, jobId]);

  if (loading) return <div className="p-4 text-center">Carregando AvaliaÃ§Ã£o 360Âº...</div>;

  return (
    <div className="bg-white rounded-lg shadow p-6 mt-6">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-2xl font-bold text-gray-800">AvaliaÃ§Ã£o 360Âº</h2>
        <button 
          onClick={() => setViewMode(viewMode === 'summary' ? 'evaluate' : 'summary')}
          className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
        >
          {viewMode === 'summary' ? 'Minha AvaliaÃ§Ã£o' : 'Voltar ao Resumo'}
        </button>
      </div>

      {viewMode === 'summary' ? (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {/* Card da Nota Final */}
          <div className="bg-gray-50 p-6 rounded-xl border border-gray-200 text-center">
            <span className="block text-gray-500 text-sm uppercase tracking-wide">MÃ©dia Geral</span>
            <span className="block text-5xl font-extrabold text-blue-600 mt-2">
              {summary?.final_score || '-'}
            </span>
          </div>
          
          {/* Lista de Avaliadores */}
          <div className="col-span-2">
            <h3 className="font-semibold text-gray-700 mb-3">Avaliadores Participantes</h3>
            <div className="flex gap-2">
              {summary?.evaluators?.map(ev => (
                <span key={ev.id} className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                  {ev.name}
                </span>
              ))}
              {(!summary?.evaluators || summary.evaluators.length === 0) && (
                <span className="text-gray-400 italic">Nenhuma avaliaÃ§Ã£o concluÃ­da ainda.</span>
              )}
            </div>
          </div>
        </div>
      ) : (
        <div className="p-4 bg-yellow-50 border border-yellow-200 rounded text-yellow-800">
          {/* AQUI ENTRARÃ O FORMULÃRIO DE NOTAS NO PRÃ“XIMO PASSO */}
          <p>O formulÃ¡rio de avaliaÃ§Ã£o individual serÃ¡ carregado aqui.</p>
        </div>
      )}
    </div>
  );
}

==================================================
ARQUIVO: src_old\components\evaluation_v2\EvaluationForm.jsx
==================================================
import React, { useState } from 'react';
import { supabase } from '../supabase/client';
import { useAuth } from '../context/AuthContext';

export default function EvaluationForm({ applicationId, jobParameters, initialData, onSaved }) {
  const { user } = useAuth();
  const [scores, setScores] = useState(initialData?.scores || {});
  const [notes, setNotes] = useState(initialData?.notes || '');
  const [isSaving, setIsSaving] = useState(false);

  // CÃ¡lculo de Nota no Frontend (Regra 3: Ignora N/A)
  const calculateScore = () => {
    let total = 0;
    let max = 0;
    const notesMap = new Map((jobParameters.notas || []).map(n => [n.id, Number(n.valor)]));

    ['triagem', 'cultura', 'tecnico'].forEach(section => {
      const criteria = jobParameters[section] || [];
      criteria.forEach(crit => {
        const vote = scores[section]?.[crit.name];
        if (vote && vote !== 'NA') {
          const val = notesMap.get(vote) || 0;
          const weight = Number(crit.weight) || 1;
          total += val * weight;
          max += 100 * weight;
        }
      });
    });

    return max === 0 ? 0 : Number(((total / max) * 100).toFixed(1));
  };

  const handleSave = async () => {
    setIsSaving(true);
    try {
      const finalScore = calculateScore();
      
      const { error } = await supabase.from('evaluations').upsert({
        application_id: applicationId,
        evaluator_id: user.id,
        scores,
        notes,
        final_score: finalScore,
        created_at: new Date() // Atualiza timestamp
      }, { onConflict: 'application_id, evaluator_id' });

      if (error) throw error;
      alert(`Salvo! Sua nota: ${finalScore}`);
      if (onSaved) onSaved();

    } catch (err) {
      alert("Erro ao salvar: " + err.message);
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <div className="bg-white p-6 border rounded-lg space-y-6">
      <h3 className="font-bold text-lg border-b pb-2">Minha AvaliaÃ§Ã£o (V2.0)</h3>
      
      {['triagem', 'cultura', 'tecnico'].map(section => (
        <div key={section} className="p-4 bg-gray-50 rounded">
          <h4 className="font-semibold capitalize mb-3 text-blue-800">{section}</h4>
          <div className="grid gap-4 md:grid-cols-2">
            {jobParameters[section]?.map(crit => (
              <div key={crit.name}>
                <label className="block text-xs font-medium text-gray-500 mb-1">{crit.name}</label>
                <select 
                  className="w-full border rounded p-2 text-sm"
                  value={scores[section]?.[crit.name] || ''}
                  onChange={e => setScores({
                    ...scores, 
                    [section]: { ...scores[section], [crit.name]: e.target.value }
                  })}
                >
                  <option value="">Selecione...</option>
                  <option value="NA">N/A (NÃ£o Avaliar)</option>
                  <optgroup label="Notas">
                    {jobParameters.notas.map(n => (
                      <option key={n.id} value={n.id}>{n.nome}</option>
                    ))}
                  </optgroup>
                </select>
              </div>
            ))}
          </div>
        </div>
      ))}

      <div>
        <label className="block font-medium mb-1">ObservaÃ§Ãµes</label>
        <textarea 
          className="w-full border rounded p-2" 
          rows="4"
          value={notes}
          onChange={e => setNotes(e.target.value)}
          placeholder="ComentÃ¡rios sobre o candidato..."
        />
      </div>

      <div className="flex justify-end">
        <button 
          onClick={handleSave} 
          disabled={isSaving}
          className="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 disabled:opacity-50"
        >
          {isSaving ? 'Salvando...' : 'Salvar AvaliaÃ§Ã£o'}
        </button>
      </div>
    </div>
  );
}

==================================================
ARQUIVO: src_old\components\inputs\StateSelect.jsx
==================================================
import React from 'react';
import { Label } from '../ui/label';
import { estados } from '../../data/brazil-locations'; 

const StateSelect = ({ value, onChange, error, disabled }) => {
  return (
    <div className="mb-4">
      <Label htmlFor="state">Em que estado vocÃª mora?</Label>
      <select
        id="state"
        name="state"
        value={value || ''}
        onChange={onChange}
        disabled={disabled}
        className="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
      >
        <option value="" disabled>Selecione uma opÃ§Ã£o</option>
        {estados.map((estado) => (
          <option key={estado.sigla} value={estado.sigla}>
            {estado.nome}
          </option>
        ))}
      </select>
      {error && <p className="text-sm text-red-500 mt-1">{error}</p>}
    </div>
  );
};

export default StateSelect;

==================================================
ARQUIVO: src_old\components\jobs\CreateJobModal.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { supabase } from '../../supabase/client';
import { Modal } from '../ui/modal';
import { Button } from '../ui/button';
import { Input } from '../ui/input';
import { Textarea } from '../ui/textarea';
import { Label } from '../ui/label';
import AreaSelect from '../AreaSelect';
import { Loader2, AlertCircle } from 'lucide-react';

const CreateJobModal = ({ open, handleClose, onJobCreated }) => {
  const initialState = {
    title: '', description: '', requirements: '', type: 'CLT',
    location_type: 'HÃ­brido', company_department_id: null
  };
  const [formData, setFormData] = useState(initialState);
  const [tenantId, setTenantId] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  useEffect(() => {
    if (open) {
      const fetchTenant = async () => {
        const { data: { user } } = await supabase.auth.getUser();
        if(user) {
            const { data } = await supabase.from('user_profiles').select('tenantId').eq('id', user.id).single();
            if(data) setTenantId(data.tenantId);
        }
      };
      fetchTenant();
    }
  }, [open]);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      if (!formData.title) throw new Error("TÃ­tulo Ã© obrigatÃ³rio.");

      // InserÃ§Ã£o direta no Supabase
      const { error: insertError } = await supabase.from('jobs').insert({
        ...formData,
        tenantId: tenantId,
        status: 'active',
        company_department_id: formData.company_department_id || null,
        parameters: { 
            triagem: [], cultura: [], tecnico: [], 
            notas: [{id:'1',nome:'Abaixo',valor:0},{id:'2',nome:'Atende',valor:50},{id:'3',nome:'Supera',valor:100}] 
        }
      });

      if (insertError) throw insertError;

      setFormData(initialState);
      onJobCreated();
      handleClose();
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));

  return (
    <Modal isOpen={open} onClose={handleClose} title="Nova Vaga">
      <form onSubmit={handleSubmit} className="space-y-4 max-h-[80vh] overflow-y-auto px-1">
        <div><Label>TÃ­tulo *</Label><Input name="title" value={formData.title} onChange={handleChange} required /></div>
        {tenantId && <AreaSelect currentTenantId={tenantId} selectedAreaId={formData.company_department_id} onSelectArea={(id) => setFormData(p => ({...p, company_department_id: id}))} />}
        <div className="grid grid-cols-2 gap-4">
            <div><Label>Modelo</Label><select name="location_type" className="w-full border rounded h-10 px-2" value={formData.location_type} onChange={handleChange}><option>Presencial</option><option>HÃ­brido</option><option>Remoto</option></select></div>
            <div><Label>Contrato</Label><select name="type" className="w-full border rounded h-10 px-2" value={formData.type} onChange={handleChange}><option>CLT</option><option>PJ</option><option>EstÃ¡gio</option></select></div>
        </div>
        <div><Label>DescriÃ§Ã£o</Label><Textarea name="description" value={formData.description} onChange={handleChange} /></div>
        <div><Label>Requisitos</Label><Textarea name="requirements" value={formData.requirements} onChange={handleChange} /></div>
        {error && <div className="text-red-500 text-sm">{error}</div>}
        <div className="flex justify-end gap-2 pt-2 border-t"><Button variant="outline" onClick={handleClose}>Cancelar</Button><Button type="submit" disabled={loading}>{loading ? <Loader2 className="animate-spin"/> : 'Criar'}</Button></div>
      </form>
    </Modal>
  );
};

export default CreateJobModal;

==================================================
ARQUIVO: src_old\components\ui\badge.jsx
==================================================
import * as React from "react"
import { cva } from "class-variance-authority"
import { cn } from "../../lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default: "border-transparent bg-blue-600 text-white hover:bg-blue-700",
        secondary: "border-transparent bg-gray-100 text-gray-900 hover:bg-gray-200",
        destructive: "border-transparent bg-red-500 text-white hover:bg-red-600",
        outline: "text-gray-900 border-gray-200",
        success: "border-transparent bg-green-100 text-green-800 hover:bg-green-200",
        warning: "border-transparent bg-yellow-100 text-yellow-800 hover:bg-yellow-200",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({ className, variant, ...props }) {
  return (<div className={cn(badgeVariants({ variant }), className)} {...props} />)
}

export { Badge, badgeVariants }

==================================================
ARQUIVO: src_old\components\ui\button.jsx
==================================================
import * as React from "react"
import { cva } from "class-variance-authority"
import { cn } from "../../lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
  {
    variants: {
      variant: {
        default: "bg-blue-600 text-white hover:bg-blue-700 shadow-sm",
        destructive: "bg-red-500 text-white hover:bg-red-600 shadow-sm",
        outline: "border border-gray-200 bg-white hover:bg-gray-100 hover:text-gray-900",
        secondary: "bg-gray-100 text-gray-900 hover:bg-gray-200",
        ghost: "hover:bg-gray-100 hover:text-gray-900",
        link: "text-blue-600 underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const Button = React.forwardRef(({ className, variant, size, ...props }, ref) => {
  return (
    <button
      className={cn(buttonVariants({ variant, size, className }))}
      ref={ref}
      {...props}
    />
  )
})
Button.displayName = "Button"

export { Button, buttonVariants }

==================================================
ARQUIVO: src_old\components\ui\button.test.jsx
==================================================
import { render, screen } from '@testing-library/react';
import { Button } from './button';
import { describe, it, expect } from 'vitest';

describe('Componente Button', () => {
  it('deve renderizar o texto corretamente', () => {
    render(<Button>Clique aqui</Button>);
    expect(screen.getByText('Clique aqui')).toBeInTheDocument();
  });

  it('deve aplicar a classe de variante destructive', () => {
    render(<Button variant="destructive">Excluir</Button>);
    const button = screen.getByText('Excluir');
    // Verifica se a classe do tailwind para background vermelho estÃ¡ presente
    expect(button).toHaveClass('bg-red-500');
  });
});

==================================================
ARQUIVO: src_old\components\ui\card.jsx
==================================================
import * as React from "react"
import { cn } from "../../lib/utils"

const Card = React.forwardRef(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("rounded-lg border bg-white text-gray-950 shadow-sm", className)} {...props} />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("flex flex-col space-y-1.5 p-6", className)} {...props} />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef(({ className, ...props }, ref) => (
  <h3 ref={ref} className={cn("text-2xl font-semibold leading-none tracking-tight", className)} {...props} />
))
CardTitle.displayName = "CardTitle"

const CardContent = React.forwardRef(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

export { Card, CardHeader, CardTitle, CardContent }

==================================================
ARQUIVO: src_old\components\ui\input.jsx
==================================================
import * as React from "react"
import { cn } from "../../lib/utils"

const Input = React.forwardRef(({ className, type, ...props }, ref) => {
  return (
    <input
      type={type}
      className={cn(
        "flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm ring-offset-white file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-gray-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      ref={ref}
      {...props}
    />
  )
})
Input.displayName = "Input"

export { Input }

==================================================
ARQUIVO: src_old\components\ui\label.jsx
==================================================
import * as React from "react"
import { cn } from "../../lib/utils"

const Label = React.forwardRef(({ className, ...props }, ref) => (
  <label
    ref={ref}
    className={cn(
      "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-gray-700 mb-2 block",
      className
    )}
    {...props}
  />
))
Label.displayName = "Label"

export { Label }

==================================================
ARQUIVO: src_old\components\ui\modal.jsx
==================================================
import React, { useEffect } from 'react';
import { X } from 'lucide-react';
import { createPortal } from 'react-dom';

export function Modal({ isOpen, onClose, title, children }) {
  // Fecha ao pressionar ESC
  useEffect(() => {
    const handleEsc = (e) => {
      if (e.key === 'Escape') onClose();
    };
    if (isOpen) window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return createPortal(
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="relative w-full max-w-md bg-white rounded-lg shadow-xl animate-in zoom-in-95 duration-200" onClick={(e) => e.stopPropagation()}>
        {/* Header */}
        <div className="flex items-center justify-between px-6 py-4 border-b">
          <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-500 transition-colors focus:outline-none"
          >
            <X className="w-5 h-5" />
          </button>
        </div>
        
        {/* Content */}
        <div className="p-6">
          {children}
        </div>
      </div>
    </div>,
    document.body
  );
}

==================================================
ARQUIVO: src_old\components\ui\textarea.jsx
==================================================
import * as React from "react"
import { cn } from "../../lib/utils"

const Textarea = React.forwardRef(({ className, ...props }, ref) => {
  return (
    <textarea
      className={cn(
        "flex min-h-[80px] w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm ring-offset-white placeholder:text-gray-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      ref={ref}
      {...props}
    />
  )
})
Textarea.displayName = "Textarea"

export { Textarea }

==================================================
ARQUIVO: src_old\context\AuthContext.jsx
==================================================
import { createContext, useContext, useEffect, useState } from 'react';
import { supabase } from '../supabase/client';

const AuthContext = createContext({});

export const useAuth = () => useContext(AuthContext);

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null); // Padronizado como 'user'
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const checkSession = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      setUser(session?.user ?? null);
      setLoading(false);
    };
    checkSession();

    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
      setUser(session?.user ?? null);
      setLoading(false);
    });

    return () => subscription.unsubscribe();
  }, []);

  return (
    <AuthContext.Provider value={{ user, loading, signUp: supabase.auth.signUp }}>
      {!loading && children}
    </AuthContext.Provider>
  );
};

==================================================
ARQUIVO: src_old\context\gerar_contexto.py
==================================================
import os

# ConfiguraÃ§Ãµes - Adicione ou remova extensÃµes/pastas conforme necessÃ¡rio
EXTENSOES_PERMITIDAS = {
    '.js', '.jsx', '.ts', '.tsx',  # Web / React / Node
    '.html', '.css', '.scss',      # Front-end
    '.py', '.java', '.cs', '.php', # Back-end
    '.sql', '.prisma',             # Banco de Dados
    '.json', '.xml', '.yml',       # ConfiguraÃ§Ãµes
    '.dart', '.swift', '.kt'       # Mobile
}

PASTAS_IGNORADAS = {
    'node_modules', '.git', '.idea', '.vscode', 
    'dist', 'build', 'coverage', 'venv', '__pycache__',
    'bin', 'obj', 'android', 'ios' # Ignorando pastas nativas pesadas se for React Native/Flutter (pode remover se precisar de configs nativas)
}

ARQUIVOS_IGNORADOS = {
    'package-lock.json', 'yarn.lock', 'gerar_contexto.py'
}

def deve_processar(caminho_arquivo):
    _, ext = os.path.splitext(caminho_arquivo)
    nome_arquivo = os.path.basename(caminho_arquivo)
    
    if nome_arquivo in ARQUIVOS_IGNORADOS:
        return False
    return ext in EXTENSOES_PERMITIDAS

def gerar_txt_projeto():
    saida = "projeto_completo.txt"
    
    with open(saida, 'w', encoding='utf-8') as f_out:
        # Adiciona a estrutura de pastas primeiro (TREE)
        f_out.write("--- ESTRUTURA DE DIRETÃ“RIOS ---\n")
        for root, dirs, files in os.walk('.'):
            # Filtra pastas ignoradas para nÃ£o descer nelas
            dirs[:] = [d for d in dirs if d not in PASTAS_IGNORADAS]
            level = root.replace('.', '', 1).count(os.sep)
            indent = ' ' * 4 * (level)
            f_out.write(f"{indent}{os.path.basename(root)}/\n")
            subindent = ' ' * 4 * (level + 1)
            for f in files:
                f_out.write(f"{subindent}{f}\n")
        
        f_out.write("\n\n--- CONTEÃšDO DOS ARQUIVOS ---\n\n")

        # Adiciona o conteÃºdo dos arquivos
        for root, dirs, files in os.walk('.'):
            dirs[:] = [d for d in dirs if d not in PASTAS_IGNORADAS]
            
            for file in files:
                caminho_completo = os.path.join(root, file)
                
                if deve_processar(caminho_completo):
                    f_out.write(f"\n{'='*50}\n")
                    f_out.write(f"CAMINHO: {caminho_completo}\n")
                    f_out.write(f"{'='*50}\n")
                    
                    try:
                        with open(caminho_completo, 'r', encoding='utf-8') as f_in:
                            f_out.write(f_in.read())
                    except Exception as e:
                        f_out.write(f"[Erro ao ler arquivo: {e}]\n")

    print(f"Sucesso! Arquivo '{saida}' gerado. Basta enviÃ¡-lo para a IA.")

if __name__ == "__main__":
    gerar_txt_projeto()

==================================================
ARQUIVO: src_old\data\brazil-locations.js
==================================================
// src/data/brazil-locations.js
export const estados = [
  { sigla: 'AC', nome: 'Acre' },
  { sigla: 'AL', nome: 'Alagoas' },
  { sigla: 'AP', nome: 'AmapÃ¡' },
  { sigla: 'AM', nome: 'Amazonas' },
  { sigla: 'BA', nome: 'Bahia' },
  { sigla: 'CE', nome: 'CearÃ¡' },
  { sigla: 'DF', nome: 'Distrito Federal' },
  { sigla: 'ES', nome: 'EspÃ­rito Santo' },
  { sigla: 'GO', nome: 'GoiÃ¡s' },
  { sigla: 'MA', nome: 'MaranhÃ£o' },
  { sigla: 'MT', nome: 'Mato Grosso' },
  { sigla: 'MS', nome: 'Mato Grosso do Sul' },
  { sigla: 'MG', nome: 'Minas Gerais' },
  { sigla: 'PA', nome: 'ParÃ¡' },
  { sigla: 'PB', nome: 'ParaÃ­ba' },
  { sigla: 'PR', nome: 'ParanÃ¡' },
  { sigla: 'PE', nome: 'Pernambuco' },
  { sigla: 'PI', nome: 'PiauÃ­' },
  { sigla: 'RJ', nome: 'Rio de Janeiro' },
  { sigla: 'RN', nome: 'Rio Grande do Norte' },
  { sigla: 'RS', nome: 'Rio Grande do Sul' },
  { sigla: 'RO', nome: 'RondÃ´nia' },
  { sigla: 'RR', nome: 'Roraima' },
  { sigla: 'SC', nome: 'Santa Catarina' },
  { sigla: 'SP', nome: 'SÃ£o Paulo' },
  { sigla: 'SE', nome: 'Sergipe' },
  { sigla: 'TO', nome: 'Tocantins' }
];

// No futuro, podemos substituir o campo de cidade por uma busca via API de CEP
// Por enquanto, usaremos um campo de texto simples para a cidade.

==================================================
ARQUIVO: src_old\lib\utils.js
==================================================
import { clsx } from "clsx"
import { twMerge } from "tailwind-merge"
 
export function cn(...inputs) {
  return twMerge(clsx(inputs))
}

==================================================
ARQUIVO: src_old\pages\AdminPage.jsx
==================================================
import React from 'react';
import { Link } from 'react-router-dom';
import { Button } from '../components/ui/button';
import { Card, CardHeader, CardTitle, CardContent } from '../components/ui/card';
import { ArrowLeft, ShieldCheck } from 'lucide-react';

const AdminPage = () => {
    return (
        <div className="min-h-screen bg-gray-50 p-8">
            <div className="max-w-4xl mx-auto">
                <div className="flex justify-between items-center mb-8">
                    <h1 className="text-3xl font-bold text-gray-900">Painel Administrativo</h1>
                    <Button variant="outline" asChild>
                        <Link to="/"><ArrowLeft className="mr-2 h-4 w-4"/> Voltar ao Dashboard</Link>
                    </Button>
                </div>

                <div className="grid gap-6 md:grid-cols-2">
                    <Card>
                        <CardHeader>
                            <CardTitle className="flex items-center gap-2">
                                <ShieldCheck className="h-5 w-5 text-blue-600"/>
                                GestÃ£o de Tenants
                            </CardTitle>
                        </CardHeader>
                        <CardContent>
                            <p className="text-gray-500 mb-4">Gerencie as empresas e planos do sistema.</p>
                            <div className="p-4 bg-yellow-50 text-yellow-800 rounded-md text-sm border border-yellow-200">
                                MÃ³dulo em migraÃ§Ã£o para V2.0
                            </div>
                        </CardContent>
                    </Card>
                </div>
            </div>
        </div>
    );
};

export default AdminPage;

==================================================
ARQUIVO: src_old\pages\AdminTenantPage.jsx
==================================================
import React from 'react';
import { Link } from 'react-router-dom';
import { Button } from '../components/ui/button';
import { Card, CardHeader, CardTitle, CardContent } from '../components/ui/card';
import { ArrowLeft, Construction } from 'lucide-react';

const AdminTenantPage = () => {
    return (
        <div className="flex h-screen items-center justify-center bg-gray-50 p-4">
            <Card className="max-w-md w-full text-center">
                <CardHeader>
                    <div className="mx-auto bg-blue-100 p-3 rounded-full w-fit mb-4">
                        <Construction className="h-8 w-8 text-blue-600" />
                    </div>
                    <CardTitle className="text-xl">GestÃ£o de UsuÃ¡rios</CardTitle>
                </CardHeader>
                <CardContent>
                    <p className="text-gray-500 mb-6">
                        Este mÃ³dulo estÃ¡ sendo atualizado para a nova versÃ£o 2.0. 
                        A gestÃ£o de usuÃ¡rios retornarÃ¡ em breve.
                    </p>
                    <Button asChild className="w-full">
                        <Link to="/admin">
                            <ArrowLeft className="mr-2 h-4 w-4" /> Voltar para Admin
                        </Link>
                    </Button>
                </CardContent>
            </Card>
        </div>
    );
};

export default AdminTenantPage;

==================================================
ARQUIVO: src_old\pages\ApplicationDetails.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { useParams, Link as RouterLink } from 'react-router-dom';
import { supabase } from '../supabase/client';
import { formatUrl, formatPhone } from '../utils/formatters';
import { 
    Container, Typography, Box, AppBar, Toolbar, Button, CircularProgress, 
    Alert, Paper, Grid, Divider, Tabs, Tab
} from '@mui/material';
import EvaluationForm from '../components/evaluation_v2/EvaluationForm'; // Importa o novo form

const ApplicationDetails = () => {
  const { jobId, applicationId } = useParams();
  const [application, setApplication] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [resumeUrl, setResumeUrl] = useState('');
  const [tabValue, setTabValue] = useState(0); 
  const [myEvaluation, setMyEvaluation] = useState(null);

  useEffect(() => {
    const fetchDetails = async () => {
      setLoading(true);
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) throw new Error("SessÃ£o nÃ£o encontrada.");

        // 1. Busca Detalhes da AplicaÃ§Ã£o
        // Note: Usando a API getApplicationDetails que jÃ¡ existia ou fazendo direto. 
        // Vamos fazer fetch direto para garantir que pegamos os parÃ¢metros da vaga atualizados.
        const { data: appData, error: appError } = await supabase
            .from('applications')
            .select(`
                *,
                candidate:candidates(*),
                job:jobs(parameters, title)
            `)
            .eq('id', applicationId)
            .single();
        
        if (appError) throw appError;
        setApplication(appData);

        // 2. Busca Minha AvaliaÃ§Ã£o Existente (Se houver)
        const { data: evalData } = await supabase
            .from('evaluations')
            .select('*')
            .eq('application_id', applicationId)
            .eq('evaluator_id', session.user.id)
            .maybeSingle();
            
        if (evalData) setMyEvaluation(evalData);

        // 3. URL do CurrÃ­culo
        if (appData.resumeUrl) {
            const urlResponse = await fetch(`/api/getResumeSignedUrl?filePath=${appData.resumeUrl}`, { 
                headers: { 'Authorization': `Bearer ${session.access_token}` } 
            });
            const urlData = await urlResponse.json();
            if (urlData.signedUrl) setResumeUrl(urlData.signedUrl);
        }

      } catch (err) {
        console.error(err);
        setError(err.message || "Erro ao carregar.");
      } finally {
        setLoading(false);
      }
    };
    fetchDetails();
  }, [applicationId]);

  const handleTabChange = (event, newValue) => setTabValue(newValue);

  const renderContent = () => {
    if (loading) return <Box sx={{ display: 'flex', justifyContent: 'center', my: 5 }}><CircularProgress /></Box>;
    if (error) return <Alert severity="error">{error}</Alert>;
    if (!application) return null;

    const { candidate, job, formData } = application;

    return (
        <Grid container spacing={3}>
          {/* Coluna Esquerda: Info do Candidato */}
          <Grid item xs={12} md={4}>
            <Paper sx={{ p: 3, height: '100%' }}>
              <Typography variant="h5" gutterBottom>{candidate.name}</Typography>
              <Typography variant="body2" color="textSecondary" gutterBottom>{candidate.email}</Typography>
              <Typography variant="body2" color="textSecondary" gutterBottom>{formatPhone(formData?.phone)}</Typography>
              
              <Divider sx={{ my: 2 }} />
              
              <Typography variant="subtitle2">Cidade</Typography>
              <Typography variant="body2" gutterBottom>{formData?.city || candidate.city} - {formData?.state || candidate.state}</Typography>

              {formData?.linkedinProfile && (
                  <Button sx={{mt: 1, justifyContent: 'flex-start'}} fullWidth href={formatUrl(formData.linkedinProfile)} target="_blank">LinkedIn</Button>
              )}
              
              <Box mt={3}>
                <Button variant="contained" fullWidth href={resumeUrl} target="_blank" disabled={!resumeUrl}>
                    Ver CurrÃ­culo (PDF)
                </Button>
              </Box>
            </Paper>
          </Grid>

          {/* Coluna Direita: Abas de Dados e AvaliaÃ§Ã£o */}
          <Grid item xs={12} md={8}>
            <Paper sx={{ width: '100%', minHeight: '500px' }}>
                <Tabs value={tabValue} onChange={handleTabChange} sx={{ borderBottom: 1, borderColor: 'divider', bgcolor: '#f9fafb' }}>
                    <Tab label="Dados do FormulÃ¡rio" />
                    <Tab label="Minha AvaliaÃ§Ã£o (V2.0)" />
                </Tabs>

                {/* Aba 0: Dados do FormulÃ¡rio */}
                <Box p={3} hidden={tabValue !== 0}>
                    <Grid container spacing={2}>
                        {Object.entries(formData || {}).map(([key, value]) => {
                            if(key === 'linkedinProfile' || key === 'githubProfile') return null;
                            return (
                                <Grid item xs={12} sm={6} key={key}>
                                    <Typography variant="caption" display="block" color="textSecondary" sx={{textTransform:'capitalize', fontWeight: 'bold'}}>
                                        {key.replace(/([A-Z])/g, ' $1').trim()}
                                    </Typography>
                                    <Typography variant="body1" sx={{mb: 1}}>{String(value)}</Typography>
                                </Grid>
                            )
                        })}
                    </Grid>
                </Box>

                {/* Aba 1: FormulÃ¡rio de AvaliaÃ§Ã£o */}
                <Box p={3} hidden={tabValue !== 1}>
                    <EvaluationForm 
                        applicationId={application.id}
                        jobParameters={job.parameters || {}}
                        initialData={myEvaluation}
                        onSaved={() => alert('AvaliaÃ§Ã£o salva com sucesso!')} 
                    />
                </Box>
            </Paper>
          </Grid>
        </Grid>
    );
  };
  
  return (
    <Box>
      <AppBar position="static" color="default" elevation={1}>
        <Toolbar>
          <Typography variant="h6" sx={{ flexGrow: 1 }}>
            AvaliaÃ§Ã£o de Candidato
          </Typography>
          <Button color="inherit" component={RouterLink} to={`/jobs/${jobId}`}>Voltar para Vaga</Button>
        </Toolbar>
      </AppBar>
      <Container sx={{ mt: 4, mb: 4 }}>
        {renderContent()}
      </Container>
    </Box>
  );
};

export default ApplicationDetails;

==================================================
ARQUIVO: src_old\pages\ApplyPage.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import { Button } from '../components/ui/button';
import { Input } from '../components/ui/input';
import { Textarea } from '../components/ui/textarea';
import { Label } from '../components/ui/label';
import StateSelect from '../components/inputs/StateSelect';
import { Loader2, UploadCloud, CheckCircle, AlertCircle } from 'lucide-react';

const ApplyPage = () => {
  // CORREÃ‡ÃƒO AQUI: O Router passa 'id', nÃ£o 'jobId'
  const { id } = useParams(); 
  // Para facilitar, vamos renomear internamente para jobId
  const jobId = id;

  // Estados de controle
  const [jobTitle, setJobTitle] = useState('');
  const [isVagaClosed, setIsVagaClosed] = useState(false);
  const [loadingPage, setLoadingPage] = useState(true);
  const [errorPage, setErrorPage] = useState('');

  // FormulÃ¡rio
  const [formState, setFormState] = useState({
    name: '', preferredName: '', email: '', phone: '', birthDate: '',
    state: '', city: '', hasGraduated: '', studyPeriod: '', course: '',
    institution: '', completionYear: '', englishLevel: '', spanishLevel: '',
    source: '', motivation: '', linkedinProfile: '', githubProfile: ''
  });
  
  const [resumeFile, setResumeFile] = useState(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [feedback, setFeedback] = useState({ type: '', message: '' });

  useEffect(() => {
    const fetchJobData = async () => {
      if (!jobId) {
        setErrorPage('ID da vaga nÃ£o especificado.');
        setLoadingPage(false);
        return;
      }
      try {
        const response = await fetch(`/api/getPublicJobData?id=${jobId}`);
        if (!response.ok) throw new Error('Vaga nÃ£o encontrada.');
        const data = await response.json();
        
        if (data.job) {
          if (data.job.planId === 'freemium' && data.job.candidateCount >= 3) {
            setIsVagaClosed(true);
          }
          setJobTitle(data.job.title);
        } else {
            throw new Error('Dados da vaga nÃ£o encontrados.');
        }
      } catch (error) {
        setErrorPage(error.message);
      } finally {
        setLoadingPage(false);
      }
    };
    fetchJobData();
  }, [jobId]);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormState(prev => ({ ...prev, [name]: value }));
  };

  const handleFileChange = (e) => {
    if (e.target.files && e.target.files.length > 0) {
      setResumeFile(e.target.files[0]);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsSubmitting(true);
    setFeedback({ type: '', message: '' });

    if (!resumeFile) {
      setFeedback({ type: 'error', message: 'Por favor, anexe seu currÃ­culo.' });
      setIsSubmitting(false);
      return;
    }

    const formData = new FormData();
    formData.append('jobId', jobId);
    
    Object.keys(formState).forEach(key => {
        if (formState[key]) formData.append(key, formState[key]);
    });
    
    formData.append('resume', resumeFile);

    try {
      const response = await fetch('/api/apply', { method: 'POST', body: formData });
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Erro ao enviar candidatura.');
      }
      setFeedback({ type: 'success', message: 'Candidatura enviada com sucesso!' });
    } catch (error) {
      setFeedback({ type: 'error', message: error.message });
    } finally {
      setIsSubmitting(false);
    }
  };

  if (loadingPage) return <div className="flex justify-center my-20"><Loader2 className="w-8 h-8 animate-spin text-blue-600"/></div>;
  
  if (errorPage) return <div className="max-w-md mx-auto mt-10 p-4 bg-red-50 text-red-700 rounded border border-red-200">{errorPage}</div>;
  
  if (feedback.type === 'success') {
    return (
        <div className="max-w-md mx-auto mt-20 text-center p-8 bg-green-50 rounded-lg border border-green-100">
            <CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
            <h1 className="text-2xl font-bold text-green-800 mb-2">Sucesso!</h1>
            <p className="text-green-700">{feedback.message}</p>
        </div>
    );
  }
  
  if (isVagaClosed) {
    return (
        <div className="max-w-md mx-auto mt-20 text-center p-8 bg-yellow-50 rounded-lg border border-yellow-100">
            <AlertCircle className="w-16 h-16 text-yellow-500 mx-auto mb-4" />
            <h1 className="text-2xl font-bold text-yellow-800 mb-2">Vaga Encerrada</h1>
            <p className="text-yellow-700">Esta vaga jÃ¡ atingiu o limite de candidaturas.</p>
        </div>
    );
  }

  return (
    <div className="max-w-3xl mx-auto px-4 py-10">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Candidatura Ã  Vaga</h1>
        <p className="text-lg text-blue-600 font-medium mt-1">{jobTitle}</p>
      </div>
      
      <form onSubmit={handleSubmit} className="space-y-6 bg-white p-6 md:p-8 rounded-xl shadow-sm border border-gray-100">
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <Label htmlFor="name">Nome Completo</Label>
                <Input name="name" id="name" required onChange={handleInputChange} />
            </div>
            <div>
                <Label htmlFor="preferredName">Nome Social / Como prefere ser chamado</Label>
                <Input name="preferredName" id="preferredName" onChange={handleInputChange} />
            </div>
            
            <div>
                <Label htmlFor="email">E-mail</Label>
                <Input name="email" id="email" type="email" required onChange={handleInputChange} />
            </div>
            <div>
                <Label htmlFor="phone">Telefone (Celular)</Label>
                <Input name="phone" id="phone" type="tel" required onChange={handleInputChange} />
            </div>
            
            <div>
                <Label htmlFor="birthDate">Data de Nascimento</Label>
                <Input name="birthDate" id="birthDate" type="date" required value={formState.birthDate} onChange={handleInputChange} />
            </div>
        </div>

        <StateSelect value={formState.state} onChange={handleInputChange} />
        
        <div>
            <Label htmlFor="city">Cidade</Label>
            <Input name="city" id="city" required onChange={handleInputChange} />
        </div>

        <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
            <Label className="mb-3">VocÃª jÃ¡ concluiu curso superior?</Label>
            <div className="flex gap-6">
                <label className="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="hasGraduated" value="sim" onChange={handleInputChange} className="w-4 h-4 text-blue-600" />
                    <span className="text-sm text-gray-700">Sim, jÃ¡ concluÃ­</span>
                </label>
                <label className="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="hasGraduated" value="nao" onChange={handleInputChange} className="w-4 h-4 text-blue-600" />
                    <span className="text-sm text-gray-700">NÃ£o, estou cursando</span>
                </label>
            </div>
        </div>

        {formState.hasGraduated === 'nao' && (
             <div><Label>PerÃ­odo/Ano</Label><Input name="studyPeriod" onChange={handleInputChange} /></div>
        )}
        
        {formState.hasGraduated && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><Label>Curso</Label><Input name="course" required onChange={handleInputChange} /></div>
                <div><Label>InstituiÃ§Ã£o</Label><Input name="institution" required onChange={handleInputChange} /></div>
                {formState.hasGraduated === 'sim' && ( 
                     <div><Label>Ano de ConclusÃ£o</Label><Input name="completionYear" type="number" onChange={handleInputChange} /></div>
                )}
            </div>
        )}

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {['englishLevel', 'spanishLevel'].map(lang => (
                <div key={lang}>
                    <Label>{lang === 'englishLevel' ? 'InglÃªs' : 'Espanhol'}</Label>
                    <select name={lang} onChange={handleInputChange} className="flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm">
                        <option value="">Selecione...</option>
                        <option value="basico">BÃ¡sico</option>
                        <option value="intermediario">IntermediÃ¡rio</option>
                        <option value="avancado">AvanÃ§ado</option>
                        <option value="fluente">Fluente/Nativo</option>
                    </select>
                </div>
            ))}
        </div>

        <div>
            <Label htmlFor="motivation">Por que vocÃª deseja esta vaga?</Label>
            <Textarea name="motivation" id="motivation" required rows={4} onChange={handleInputChange} />
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><Label>LinkedIn (Opcional)</Label><Input name="linkedinProfile" onChange={handleInputChange} /></div>
            <div><Label>GitHub (Opcional)</Label><Input name="githubProfile" onChange={handleInputChange} /></div>
        </div>

        <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors">
            <Label htmlFor="resume" className="cursor-pointer">
                <div className="flex flex-col items-center gap-2">
                    <UploadCloud className="w-8 h-8 text-gray-400" />
                    <span className="text-sm font-medium text-blue-600">Clique para enviar seu currÃ­culo (PDF/DOC)</span>
                    {resumeFile && <span className="text-xs text-green-600 font-bold">Arquivo selecionado: {resumeFile.name}</span>}
                </div>
                <input id="resume" type="file" hidden required accept=".pdf,.doc,.docx" onChange={handleFileChange} />
            </Label>
        </div>

        {feedback.type === 'error' && <div className="text-red-600 text-sm bg-red-50 p-3 rounded">{feedback.message}</div>}

        <Button type="submit" className="w-full" size="lg" disabled={isSubmitting}>
            {isSubmitting ? <><Loader2 className="w-4 h-4 mr-2 animate-spin"/> Enviando...</> : 'Enviar Candidatura'}
        </Button>
      </form>
    </div>
  );
};

export default ApplyPage;

==================================================
ARQUIVO: src_old\pages\Candidates.jsx
==================================================
export default function Candidates() {
  return (
    <div className="p-8">
      <h1 className="text-2xl font-bold mb-4">Banco de Talentos</h1>
      <p>PÃ¡gina em construÃ§Ã£o. Aqui aparecerÃ£o todos os candidatos.</p>
    </div>
  );
}

==================================================
ARQUIVO: src_old\pages\CompanySettings.jsx
==================================================
export default function CompanySettings() {
  return (
    <div className="p-8">
      <h1 className="text-2xl font-bold mb-4">ConfiguraÃ§Ãµes da Empresa</h1>
      <p>PÃ¡gina em construÃ§Ã£o.</p>
    </div>
  );
}

==================================================
ARQUIVO: src_old\pages\Dashboard.jsx
==================================================
import React, { useState, useEffect, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '../supabase/client';
import { useAuth } from '../context/AuthContext';
import { Plus, Briefcase, Users, Building } from 'lucide-react';
import { Button } from '../components/ui/button'; // Se nÃ£o tiver, use HTML button normal temporariamente
import CreateJobModal from '../components/jobs/CreateJobModal';

export default function Dashboard() {
  const { user } = useAuth();
  const navigate = useNavigate();
  const [jobs, setJobs] = useState([]);
  const [departments, setDepartments] = useState({});
  const [loading, setLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);
  
  // Filtros
  const [deptFilter, setDeptFilter] = useState('all');

  const fetchData = async () => {
    try {
      setLoading(true);
      if (!user) return;

      // 1. Busca Tenant ID
      const { data: profile } = await supabase
        .from('user_profiles')
        .select('tenantId')
        .eq('id', user.id)
        .single();

      if (!profile) return;

      // 2. Busca Departamentos (Para mapear ID -> Nome)
      const { data: depts } = await supabase
        .from('company_departments')
        .select('id, name')
        .eq('tenantId', profile.tenantId);
      
      const deptMap = {};
      depts?.forEach(d => deptMap[d.id] = d.name);
      setDepartments(deptMap);

      // 3. Busca Vagas
      const { data: jobsData } = await supabase
        .from('jobs')
        .select('*, applications(count)')
        .eq('tenantId', profile.tenantId);

      // Processa e Ordena (Regra 5)
      const processed = (jobsData || []).map(j => ({
        ...j,
        deptName: deptMap[j.company_department_id] || 'Geral',
        candidateCount: j.applications?.[0]?.count || 0
      })).sort((a, b) => {
        // Ordem: Depto (A-Z) -> Data (Desc)
        const deptCompare = a.deptName.localeCompare(b.deptName);
        if (deptCompare !== 0) return deptCompare;
        return new Date(b.created_at) - new Date(a.created_at);
      });

      setJobs(processed);

    } catch (error) {
      console.error("Erro Dashboard:", error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { fetchData(); }, [user]);

  const filteredJobs = useMemo(() => {
    return deptFilter === 'all' 
      ? jobs 
      : jobs.filter(j => j.deptName === deptFilter);
  }, [jobs, deptFilter]);

  const uniqueDepts = [...new Set(Object.values(departments))].sort();

  if (loading) return <div className="p-10 text-center">Carregando...</div>;

  return (
    <div className="p-8 max-w-7xl mx-auto">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Painel de Vagas</h1>
        <button 
          onClick={() => setIsModalOpen(true)}
          className="bg-blue-600 text-white px-4 py-2 rounded-md flex items-center hover:bg-blue-700"
        >
          <Plus className="w-4 h-4 mr-2"/> Nova Vaga
        </button>
      </div>

      {/* Filtros e KPIs */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div className="bg-white p-4 rounded shadow border">
          <p className="text-sm text-gray-500">Vagas Ativas</p>
          <p className="text-2xl font-bold">{jobs.filter(j => j.status === 'active').length}</p>
        </div>
        <div className="bg-white p-4 rounded shadow border">
          <p className="text-sm text-gray-500">Total Candidatos</p>
          <p className="text-2xl font-bold">{jobs.reduce((acc, j) => acc + j.candidateCount, 0)}</p>
        </div>
      </div>

      <div className="bg-white rounded-lg shadow border overflow-hidden">
        <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
          <h2 className="font-semibold text-gray-700">Listagem</h2>
          <select 
            className="border rounded p-1 text-sm"
            value={deptFilter}
            onChange={(e) => setDeptFilter(e.target.value)}
          >
            <option value="all">Todos Departamentos</option>
            {uniqueDepts.map(d => <option key={d} value={d}>{d}</option>)}
          </select>
        </div>
        
        <table className="w-full text-left text-sm">
          <thead className="bg-gray-50 text-gray-500 border-b">
            <tr>
              <th className="p-4">Empresa / Ãrea</th>
              <th className="p-4">Vaga</th>
              <th className="p-4">Status</th>
              <th className="p-4 text-center">Candidatos</th>
            </tr>
          </thead>
          <tbody>
            {filteredJobs.map(job => (
              <tr 
                key={job.id} 
                className="border-b hover:bg-gray-50 cursor-pointer transition"
                onClick={() => navigate(`/jobs/${job.id}`)}
              >
                <td className="p-4 text-gray-600 font-medium">
                  {/* Assumindo nome fixo da empresa por enquanto para simplificar */}
                  Novva <span className="text-gray-300 mx-1">/</span> {job.deptName}
                </td>
                <td className="p-4 font-semibold text-blue-600">{job.title}</td>
                <td className="p-4">
                  <span className={`px-2 py-1 rounded-full text-xs ${job.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100'}`}>
                    {job.status === 'active' ? 'Ativa' : 'Fechada'}
                  </span>
                </td>
                <td className="p-4 text-center">
                  <span className="bg-gray-100 px-2 py-1 rounded text-xs">{job.candidateCount}</span>
                </td>
              </tr>
            ))}
            {filteredJobs.length === 0 && (
              <tr><td colSpan="4" className="p-8 text-center text-gray-500">Nenhuma vaga encontrada.</td></tr>
            )}
          </tbody>
        </table>
      </div>

      <CreateJobModal 
        open={isModalOpen} 
        handleClose={() => setIsModalOpen(false)} 
        onJobCreated={fetchData} 
      />
    </div>
  );
}

==================================================
ARQUIVO: src_old\pages\Evaluation.jsx
==================================================
import { useParams } from 'react-router-dom';

export default function Evaluation() {
  const { applicationId } = useParams();
  return (
    <div className="p-8">
      <h1 className="text-2xl font-bold mb-4">AvaliaÃ§Ã£o do Candidato</h1>
      <p>Avaliando candidatura ID: {applicationId}</p>
    </div>
  );
}

==================================================
ARQUIVO: src_old\pages\HiredPage.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { Link as RouterLink } from 'react-router-dom';
import { supabase } from '../supabase/client';
import { format, parseISO } from 'date-fns';
import { Button } from '../components/ui/button';
import { Card } from '../components/ui/card';
import { Loader2, ArrowLeft } from 'lucide-react';

const HiredPage = () => {
    const [hiredData, setHiredData] = useState({});
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState('');

    useEffect(() => {
        const fetchHired = async () => {
            setLoading(true);
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return; // AuthContext lida com redirect
       
                const response = await fetch('/api/getHiredApplicants', {
                    headers: { 'Authorization': `Bearer ${session.access_token}` },
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Erro ao buscar aprovados.");
                }
                const data = await response.json();
                
                // Agrupa por Vaga
                const groupedByJob = (data.hired || []).reduce((acc, application) => {
                    const jobTitle = application.job.title;
                    if (!acc[jobTitle]) acc[jobTitle] = [];
                    acc[jobTitle].push(application);
                    return acc;
                }, {});
                
                setHiredData(groupedByJob);
            } catch (err) {
                console.error("Erro:", err);
                setError(err.message);
            } finally {
                setLoading(false);
            }
        };
        fetchHired();
    }, []);

    const formatPhone = (phone) => {
        if (!phone) return 'NÃ£o informado';
        const cleaned = phone.replace(/\D/g, '');
        if (cleaned.length === 11) return `(${cleaned.substring(0, 2)}) ${cleaned.substring(2, 7)}-${cleaned.substring(7)}`;
        if (cleaned.length === 10) return `(${cleaned.substring(0, 2)}) ${cleaned.substring(2, 6)}-${cleaned.substring(6)}`;
        return phone;
    };

    if (loading) return <div className="flex justify-center p-10"><Loader2 className="h-8 w-8 animate-spin text-blue-600"/></div>;

    return (
        <div className="max-w-5xl mx-auto px-4 py-8">
            <div className="flex items-center justify-between mb-6">
                <h1 className="text-2xl font-bold text-gray-900">Candidatos Aprovados</h1>
                <Button variant="outline" asChild>
                    <RouterLink to="/"><ArrowLeft className="mr-2 h-4 w-4"/> Voltar ao Painel</RouterLink>
                </Button>
            </div>

            {error && <div className="p-4 bg-red-50 text-red-700 rounded border border-red-200">{error}</div>}

            {Object.keys(hiredData).length === 0 && !error && (
                <div className="text-center py-10 text-gray-500 bg-white rounded border border-dashed">
                    Nenhum candidato aprovado ainda.
                </div>
            )}

            <div className="space-y-6">
                {Object.entries(hiredData).map(([jobTitle, applications]) => (
                    <Card key={jobTitle} className="p-6">
                        <h2 className="text-lg font-semibold border-b pb-2 mb-4 text-gray-800">{jobTitle}</h2>
                        <ul className="space-y-4">
                            {applications.map((app) => (
                                <li key={app.id} className="flex flex-col sm:flex-row sm:items-center justify-between p-3 bg-gray-50 rounded-md hover:bg-gray-100 transition">
                                    <div>
                                        <p className="font-medium text-gray-900">{app.candidate.name}</p>
                                        <p className="text-sm text-gray-600">{app.candidate.email} â€¢ {formatPhone(app.formData.phone)}</p>
                                    </div>
                                    <div className="mt-2 sm:mt-0 text-sm text-green-700 bg-green-100 px-3 py-1 rounded-full font-medium">
                                        Aprovado em: {app.hiredAt ? format(parseISO(app.hiredAt), 'dd/MM/yyyy') : 'N/A'}
                                    </div>
                                </li>
                            ))}
                        </ul>
                    </Card>
                ))}
            </div>
        </div>
    );
};

export default HiredPage;

==================================================
ARQUIVO: src_old\pages\JobDetails.jsx
==================================================
import React, { useState, useEffect } from 'react';
import { useParams, Link } from 'react-router-dom';
import { supabase } from '../supabase/client';
import { Button } from '../components/ui/button';
import { Badge } from '../components/ui/badge';
import { Loader2, ArrowLeft, MapPin, Briefcase, Calendar, Share2, User, Download, Plus, Trash2, Save, Copy } from 'lucide-react';

export default function JobDetails() {
  const { id } = useParams();
  const [job, setJob] = useState(null);
  const [candidates, setCandidates] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('details');
  const [savingParams, setSavingParams] = useState(false);
  
  // Estado inicial garantido para as 3 seÃ§Ãµes
  const [evalParams, setEvalParams] = useState({ 
      triagem: [], 
      cultura: [], 
      tecnico: [],
      notas: [
        {id: '1', nome: 'Abaixo', valor: 0}, 
        {id: '2', nome: 'Atende', valor: 50}, 
        {id: '3', nome: 'Supera', valor: 100}
      ]
  });

  useEffect(() => {
    const fetchJobDetails = async () => {
      try {
        setLoading(true);
        const { data: jobData, error: jobError } = await supabase.from('jobs').select('*').eq('id', id).single();
        if (jobError) throw jobError;
        setJob(jobData);
        
        // Carrega parÃ¢metros existentes ou mantÃ©m o padrÃ£o
        if (jobData.parameters) {
          setEvalParams(prev => ({ ...prev, ...jobData.parameters }));
        }

        const { data: appsData } = await supabase
          .from('applications')
          .select(`*, candidate:candidates(name, email, city, resume_url)`)
          .eq('jobId', id)
          .order('created_at', { ascending: false });
        
        setCandidates(appsData || []);
      } catch (error) {
        console.error('Erro:', error);
      } finally {
        setLoading(false);
      }
    };
    fetchJobDetails();
  }, [id]);

  const handleCopyLink = () => {
    navigator.clipboard.writeText(`${window.location.origin}/vagas/${id}/candidatar`);
    alert('Link copiado!');
  };

  const handleSaveParameters = async () => {
    setSavingParams(true);
    try {
        await supabase.from('jobs').update({ parameters: evalParams }).eq('id', id);
        alert('ConfiguraÃ§Ãµes salvas!');
    } catch(e) { console.error(e); }
    finally { setSavingParams(false); }
  };

  const addCriteria = (type) => {
    const text = prompt(`Novo critÃ©rio para ${type.toUpperCase()}:`);
    if(text) {
        setEvalParams(p => ({
            ...p, 
            [type]: [...(p[type] || []), {id: crypto.randomUUID(), text, weight: 1}]
        }));
    }
  };

  const removeCriteria = (type, id) => {
      setEvalParams(p => ({
          ...p, 
          [type]: p[type].filter(x => x.id !== id)
      }));
  };

  if (loading) return <div className="flex justify-center p-10"><Loader2 className="animate-spin w-8 h-8 text-blue-600"/></div>;
  if (!job) return <div className="text-center p-10">Vaga nÃ£o encontrada</div>;

  return (
    <div className="max-w-7xl mx-auto px-4 py-8">
      <div className="mb-8">
        <Link to="/jobs" className="inline-flex items-center text-gray-500 hover:text-gray-900 mb-4"><ArrowLeft className="w-4 h-4 mr-2"/> Voltar</Link>
        <div className="flex justify-between items-start">
            <div>
                <h1 className="text-3xl font-bold text-gray-900">{job.title}</h1>
                <div className="flex gap-4 mt-2 text-sm text-gray-500">
                    <span className="flex items-center"><MapPin className="w-4 h-4 mr-1"/> {job.location_type || 'Remoto'}</span>
                    <span className="flex items-center"><Briefcase className="w-4 h-4 mr-1"/> {job.type || 'CLT'}</span>
                    <span className="flex items-center"><Calendar className="w-4 h-4 mr-1"/> {new Date(job.created_at).toLocaleDateString()}</span>
                </div>
            </div>
            <Button variant="outline" onClick={handleCopyLink}>
                <Share2 className="w-4 h-4 mr-2"/> Compartilhar FormulÃ¡rio
            </Button>
        </div>
      </div>

      {/* NavegaÃ§Ã£o de Abas */}
      <div className="border-b border-gray-200 mb-6 flex gap-8">
        {['details', 'candidates', 'evaluation'].map(tab => (
            <button 
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`py-4 px-1 border-b-2 font-medium text-sm capitalize ${activeTab === tab ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
            >
                {tab === 'details' ? 'Detalhes' : tab === 'candidates' ? `Candidatos (${candidates.length})` : 'ConfiguraÃ§Ã£o da AvaliaÃ§Ã£o'}
            </button>
        ))}
      </div>

      {/* ABA: Detalhes */}
      {activeTab === 'details' && (
        <div className="bg-white p-6 rounded-lg shadow-sm border space-y-6">
            <div><h3 className="font-medium text-gray-900">DescriÃ§Ã£o</h3><p className="mt-2 text-gray-600 whitespace-pre-wrap">{job.description || 'Sem descriÃ§Ã£o.'}</p></div>
            <div><h3 className="font-medium text-gray-900">Requisitos</h3><p className="mt-2 text-gray-600 whitespace-pre-wrap">{job.requirements || 'Sem requisitos.'}</p></div>
        </div>
      )}

      {/* ABA: Candidatos */}
      {activeTab === 'candidates' && (
        <div className="space-y-4">
            {candidates.map(app => (
                <div key={app.id} className="bg-white p-4 rounded-lg border shadow-sm flex justify-between items-center">
                    <div className="flex items-center gap-4">
                        <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">{app.candidate?.name?.[0]}</div>
                        <div>
                            <p className="font-medium text-gray-900">{app.candidate?.name}</p>
                            <p className="text-sm text-gray-500">{app.candidate?.email}</p>
                        </div>
                    </div>
                    <div className="flex gap-2">
                        {app.resumeUrl && <a href={app.resumeUrl} target="_blank" className="p-2 text-gray-500 border rounded-full hover:bg-gray-50"><Download className="w-4 h-4"/></a>}
                        <Link to={`/vaga/${id}/candidato/${app.id}`}><Button size="sm" variant="outline">Avaliar</Button></Link>
                    </div>
                </div>
            ))}
            {candidates.length === 0 && <div className="text-center py-10 text-gray-500">Nenhum candidato ainda.</div>}
        </div>
      )}

      {/* ABA: ConfiguraÃ§Ã£o da AvaliaÃ§Ã£o (CORRIGIDA) */}
      {activeTab === 'evaluation' && (
        <div className="bg-white p-6 rounded-lg border shadow-sm space-y-8">
            <div className="flex justify-between items-center border-b pb-4">
                <div>
                    <h2 className="text-lg font-semibold">CritÃ©rios de AvaliaÃ§Ã£o</h2>
                    <p className="text-sm text-gray-500">Defina o que serÃ¡ avaliado. O peso padrÃ£o Ã© 1.</p>
                </div>
                <Button onClick={handleSaveParameters} disabled={savingParams}>
                    {savingParams ? <Loader2 className="animate-spin w-4 h-4"/> : <><Save className="w-4 h-4 mr-2"/> Salvar Tudo</>}
                </Button>
            </div>

            {/* SEÃ‡ÃƒO 1: TRIAGEM */}
            <div className="p-4 bg-purple-50 rounded-md border border-purple-100">
                <div className="flex justify-between items-center mb-3">
                    <h3 className="font-semibold text-purple-800 flex items-center"><User className="w-4 h-4 mr-2"/> Triagem (Requisitos BÃ¡sicos)</h3>
                    <Button size="sm" variant="ghost" onClick={() => addCriteria('triagem')} className="text-purple-700 hover:bg-purple-100"><Plus className="w-4 h-4 mr-1"/> Adicionar</Button>
                </div>
                {(!evalParams.triagem || evalParams.triagem.length === 0) && <p className="text-sm text-purple-400 italic">Nenhum critÃ©rio de triagem definido.</p>}
                {evalParams.triagem?.map(item => (
                    <div key={item.id} className="flex justify-between items-center bg-white p-2 rounded mb-2 border shadow-sm">
                        <span className="text-sm">{item.text}</span>
                        <button onClick={() => removeCriteria('triagem', item.id)} className="text-red-400 hover:text-red-600"><Trash2 className="w-4 h-4"/></button>
                    </div>
                ))}
            </div>

            {/* SEÃ‡ÃƒO 2: FIT CULTURAL */}
            <div className="p-4 bg-green-50 rounded-md border border-green-100">
                <div className="flex justify-between items-center mb-3">
                    <h3 className="font-semibold text-green-800 flex items-center"><User className="w-4 h-4 mr-2"/> Fit Cultural (Comportamental)</h3>
                    <Button size="sm" variant="ghost" onClick={() => addCriteria('cultura')} className="text-green-700 hover:bg-green-100"><Plus className="w-4 h-4 mr-1"/> Adicionar</Button>
                </div>
                {(!evalParams.cultura || evalParams.cultura.length === 0) && <p className="text-sm text-green-400 italic">Nenhum critÃ©rio cultural definido.</p>}
                {evalParams.cultura?.map(item => (
                    <div key={item.id} className="flex justify-between items-center bg-white p-2 rounded mb-2 border shadow-sm">
                        <span className="text-sm">{item.text}</span>
                        <button onClick={() => removeCriteria('cultura', item.id)} className="text-red-400 hover:text-red-600"><Trash2 className="w-4 h-4"/></button>
                    </div>
                ))}
            </div>

            {/* SEÃ‡ÃƒO 3: TÃ‰CNICO */}
            <div className="p-4 bg-blue-50 rounded-md border border-blue-100">
                <div className="flex justify-between items-center mb-3">
                    <h3 className="font-semibold text-blue-800 flex items-center"><Briefcase className="w-4 h-4 mr-2"/> CritÃ©rios TÃ©cnicos (Hard Skills)</h3>
                    <Button size="sm" variant="ghost" onClick={() => addCriteria('tecnico')} className="text-blue-700 hover:bg-blue-100"><Plus className="w-4 h-4 mr-1"/> Adicionar</Button>
                </div>
                {(!evalParams.tecnico || evalParams.tecnico.length === 0) && <p className="text-sm text-blue-400 italic">Nenhum critÃ©rio tÃ©cnico definido.</p>}
                {evalParams.tecnico?.map(item => (
                    <div key={item.id} className="flex justify-between items-center bg-white p-2 rounded mb-2 border shadow-sm">
                        <span className="text-sm">{item.text}</span>
                        <button onClick={() => removeCriteria('tecnico', item.id)} className="text-red-400 hover:text-red-600"><Trash2 className="w-4 h-4"/></button>
                    </div>
                ))}
            </div>
        </div>
      )}
    </div>
  );
}

==================================================
ARQUIVO: src_old\pages\Jobs.jsx
==================================================
import { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { supabase } from '../supabase/client';
import { Plus, MapPin, Loader2, AlertCircle } from 'lucide-react';
import CreateJobModal from '../components/jobs/CreateJobModal';
import { Badge } from '../components/ui/badge';
import { Button } from '../components/ui/button';
import { formatStatus } from '../utils/formatters';

export default function Jobs() {
  const [jobs, setJobs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [isModalOpen, setIsModalOpen] = useState(false);

  const fetchJobs = async () => {
    setLoading(true);
    try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return; 

        // Usa a API que acabamos de blindar
        const response = await fetch('/api/jobs', { 
            headers: { 'Authorization': `Bearer ${session.access_token}` } 
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);
        
        setJobs(data.jobs || []);
    } catch (err) {
        setError(err.message);
    } finally {
        setLoading(false);
    }
  };

  useEffect(() => { fetchJobs(); }, []);

  if (loading) return <div className="flex justify-center p-10"><Loader2 className="w-8 h-8 animate-spin text-blue-600"/></div>;

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-900">Gerenciar Vagas</h1>
        <Button onClick={() => setIsModalOpen(true)}>
          <Plus className="w-4 h-4 mr-2" /> Nova Vaga
        </Button>
      </div>

      {error && <div className="p-4 bg-red-50 text-red-700 rounded border border-red-200 mb-4">{error}</div>}

      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {jobs.map((job) => (
          <Link key={job.id} to={`/jobs/${job.id}`} className="block p-6 bg-white rounded-lg border hover:shadow-md transition">
            <div className="flex justify-between items-start mb-2">
                <h3 className="text-lg font-medium text-gray-900">{job.title}</h3>
                <Badge variant={job.status === 'active' ? 'success' : 'secondary'}>{formatStatus(job.status)}</Badge>
            </div>
            <div className="flex items-center text-sm text-gray-500 mb-2">
                <MapPin className="w-4 h-4 mr-1"/> {job.location_type}
            </div>
            <div className="text-xs text-gray-400 font-medium">{job.deptName}</div>
          </Link>
        ))}
      </div>

      <CreateJobModal open={isModalOpen} handleClose={() => setIsModalOpen(false)} onJobCreated={fetchJobs} />
    </div>
  );
}

==================================================
ARQUIVO: src_old\pages\Login.jsx
==================================================
import { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { supabase } from '../supabase/client';
import { Button } from '../components/ui/button';
import { Input } from '../components/ui/input';
import { Label } from '../components/ui/label';
import { Loader2, LayoutDashboard } from 'lucide-react';

export default function Login() {
  const navigate = useNavigate();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const { error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });
      if (error) throw error;
      // AuthContext detecta a mudanÃ§a e o Router redireciona
      navigate('/dashboard');
    } catch (error) {
      setError('E-mail ou senha incorretos.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
      <div className="max-w-md w-full space-y-8 bg-white p-8 rounded-lg shadow-sm border">
        <div className="text-center">
          <div className="mx-auto h-12 w-12 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 mb-4">
            <LayoutDashboard size={24} />
          </div>
          <h2 className="text-3xl font-extrabold text-gray-900">Novva R&S</h2>
          <p className="mt-2 text-sm text-gray-600">Acesse sua conta</p>
        </div>
        
        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
          <div className="space-y-4">
            <div>
              <Label htmlFor="email">E-mail</Label>
              <Input
                id="email"
                type="email"
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                autoComplete="email"
              />
            </div>
            <div>
              <Label htmlFor="password">Senha</Label>
              <Input
                id="password"
                type="password"
                required
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                autoComplete="current-password"
              />
            </div>
          </div>

          {error && (
            <div className="p-3 rounded-md bg-red-50 text-red-700 text-sm border border-red-200">
              {error}
            </div>
          )}

          <Button type="submit" disabled={loading} className="w-full">
            {loading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : 'Entrar'}
          </Button>

          <div className="text-center text-sm">
            <Link to="/register" className="font-medium text-blue-600 hover:text-blue-500">
              Criar conta gratuita
            </Link>
          </div>
        </form>
      </div>
    </div>
  );
}

==================================================
ARQUIVO: src_old\pages\Register.jsx
==================================================
import { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import { Button } from '../components/ui/button';
import { Input } from '../components/ui/input';
import { Label } from '../components/ui/label';
import { Loader2, UserPlus } from 'lucide-react';

export default function Register() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const { signUp } = useAuth();
  const navigate = useNavigate();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    
    try {
      const { error } = await signUp({ email, password });
      if (error) throw error;
      alert('Cadastro realizado! FaÃ§a login.');
      navigate('/login');
    } catch (error) {
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
      <div className="max-w-md w-full space-y-8 bg-white p-8 rounded-lg shadow-sm border">
        <div className="text-center">
          <div className="mx-auto h-12 w-12 bg-green-100 rounded-lg flex items-center justify-center text-green-600 mb-4">
            <UserPlus size={24} />
          </div>
          <h2 className="text-3xl font-extrabold text-gray-900">Criar Conta</h2>
          <p className="mt-2 text-sm text-gray-600">Comece a usar o Novva R&S</p>
        </div>
        
        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div className="space-y-4">
            <div>
              <Label htmlFor="email">E-mail</Label>
              <Input
                id="email"
                type="email"
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
              />
            </div>
            <div>
              <Label htmlFor="password">Senha</Label>
              <Input
                id="password"
                type="password"
                required
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
            </div>
          </div>

          {error && <div className="text-red-500 text-sm">{error}</div>}

          <Button type="submit" disabled={loading} className="w-full bg-green-600 hover:bg-green-700">
            {loading ? <Loader2 className="animate-spin mr-2 h-4 w-4"/> : 'Cadastrar'}
          </Button>

          <div className="text-center text-sm">
            <Link to="/login" className="font-medium text-blue-600 hover:text-blue-500">
              JÃ¡ tem conta? Login
            </Link>
          </div>
        </form>
      </div>
    </div>
  );
}

==================================================
ARQUIVO: src_old\services\evaluationService.js
==================================================
// src/services/evaluationService.js
import { supabase } from '../supabase/client';

// 1. Prepara o banco (Cria critÃ©rios se nÃ£o existirem)
export const prepareEvaluationV2 = async (jobId) => {
  const { data, error } = await supabase
    .rpc('initialize_job_criteria_v2', { target_job_id: jobId });
  if (error) throw error;
  return data;
};

// 2. Busca o resumo consolidado (MÃ©dias)
export const getEvaluationSummaryV2 = async (applicationId) => {
  const { data, error } = await supabase
    .rpc('get_candidate_summary_v2', { target_app_id: applicationId });
  if (error) throw error;
  return data;
};

// 3. Busca/Cria a sessÃ£o do usuÃ¡rio atual
export const getMyEvaluationSession = async (applicationId, userId) => {
  // Tenta buscar existente
  let { data: session, error } = await supabase
    .from('evaluation_assignments_v2')
    .select('id, status')
    .eq('application_id', applicationId)
    .eq('evaluator_id', userId)
    .maybeSingle();

  // Se nÃ£o existir, cria
  if (!session) {
    const { data: newSession, error: createError } = await supabase
      .from('evaluation_assignments_v2')
      .insert({ application_id: applicationId, evaluator_id: userId })
      .select()
      .single();
    
    if (createError) throw createError;
    session = newSession;
  }
  
  return session;
};

==================================================
ARQUIVO: src_old\supabase\client.js
==================================================
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Chaves do Supabase ausentes no .env');
}

export const supabase = createClient(supabaseUrl, supabaseAnonKey);

==================================================
ARQUIVO: src_old\utils\formatters.js
==================================================
// src/utils/formatters.js
import { format, parseISO } from 'date-fns';

// Nossa nova funÃ§Ã£o de traduÃ§Ã£o
export const formatStatus = (status) => {
  const statusMap = {
    active: 'Ativa',
    inactive: 'Inativa',
    filled: 'Preenchida',
  };
  return statusMap[status] || status;
};

// Movi as outras funÃ§Ãµes de formataÃ§Ã£o para cÃ¡ para centralizar
export const formatPhone = (phone) => {
  if (!phone) return 'NÃ£o informado';
  const cleaned = phone.replace(/\D/g, '');
  if (cleaned.length === 11) {
    return `(${cleaned.substring(0, 2)}) ${cleaned.substring(2, 7)}-${cleaned.substring(7)}`;
  }
  if (cleaned.length === 10) {
    return `(${cleaned.substring(0, 2)}) ${cleaned.substring(2, 6)}-${cleaned.substring(6)}`;
  }
  return phone;
};

export const formatUrl = (url) => {
  if (!url) return '#';
  if (url.startsWith('http://') || url.startsWith('https://')) { return url; }
  return `//${url}`;
};

export const formatDate = (dateStr) => {
    if (!dateStr) return 'NÃ£o informado';
    try {
        return format(parseISO(dateStr), 'dd/MM/yyyy');
    } catch (error) {
        console.error("Erro ao formatar data:", dateStr, error);
        return 'Data invÃ¡lida';
    }
};



------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\components\jobs\CreateJobModal.jsx
------------------------------------------------
import React, { useState, useEffect } from 'react';
import { supabase } from '../../supabase/client';
import AreaSelect from '../AreaSelect';
import { AlertTriangle, Copy } from 'lucide-react';

export default function CreateJobModal({ open, onClose, onSuccess }) {
  const [tenantId, setTenantId] = useState(null);
  const [loading, setLoading] = useState(false);
  const [limitError, setLimitError] = useState(null);
  const [previousJobs, setPreviousJobs] = useState([]); // Lista de vagas para cÃ³pia
  const [copyFromId, setCopyFromId] = useState(''); // ID da vaga selecionada para cÃ³pia

  const [formData, setFormData] = useState({
    title: '', description: '', requirements: '', type: 'CLT', location_type: 'HÃ­brido', company_department_id: ''
  });

  useEffect(() => {
    if (open) {
      initialize();
    }
  }, [open]);

  const initialize = async () => {
    setLimitError(null);
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    // 1. Pega Tenant
    const { data: profile } = await supabase.from('user_profiles').select('tenantId').eq('id', user.id).single();
    if (!profile?.tenantId) return;
    setTenantId(profile.tenantId);

    // 2. Verifica Limites
    const { data: tenant } = await supabase.from('tenants').select('planId').eq('id', profile.tenantId).single();
    const { data: plan } = await supabase.from('plans').select('job_limit').eq('id', tenant.planId || 'freemium').single();
    
    const limit = plan?.job_limit || 2;
    const isUnlimited = limit === -1;

    const { count } = await supabase
        .from('jobs')
        .select('*', { count: 'exact', head: true })
        .eq('tenantId', profile.tenantId)
        .eq('status', 'active');

    if (!isUnlimited && count >= limit) {
        setLimitError(`Limite de vagas ativas atingido (${limit}).`);
    }

    // 3. Busca vagas anteriores para permitir cÃ³pia de critÃ©rios
    const { data: jobs } = await supabase
        .from('jobs')
        .select('id, title')
        .eq('tenantId', profile.tenantId)
        .order('created_at', { ascending: false });
    setPreviousJobs(jobs || []);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (limitError) return;
    
    setLoading(true);
    
    let parameters = {}; // PadrÃ£o vazio

    // Se escolheu copiar, busca os parÃ¢metros da vaga origem
    if (copyFromId) {
        const { data } = await supabase.from('jobs').select('parameters').eq('id', copyFromId).single();
        if (data?.parameters) {
            parameters = data.parameters;
        }
    } else {
        // ParÃ¢metros Default
        parameters = {
            triagem: [], cultura: [], tecnico: [],
            notas: [{id:'1',nome:'Abaixo',valor:0}, {id:'2',nome:'Atende',valor:50}, {id:'3',nome:'Supera',valor:100}]
        };
    }

    const payload = {
      ...formData,
      tenantId: tenantId,
      status: 'active',
      company_department_id: formData.company_department_id ? parseInt(formData.company_department_id) : null,
      parameters: parameters // Salva os critÃ©rios copiados ou padrÃ£o
    };

    const { error } = await supabase.from('jobs').insert(payload);

    if (error) alert('Erro: ' + error.message);
    else {
      setFormData({ title: '', description: '', requirements: '', type: 'CLT', location_type: 'HÃ­brido', company_department_id: '' });
      setCopyFromId('');
      onSuccess();
      onClose();
    }
    setLoading(false);
  };

  if (!open) return null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
      <div className="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div className="p-6 border-b flex justify-between items-center">
          <h2 className="text-xl font-bold">Nova Vaga</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">âœ•</button>
        </div>
        
        {limitError ? (
            <div className="p-6 text-center">
                <div className="bg-red-50 text-red-700 p-4 rounded border border-red-200 mb-4 flex items-start gap-3 text-left">
                    <AlertTriangle className="w-6 h-6 shrink-0" />
                    <div>
                        <p className="font-bold">Limite Atingido</p>
                        <p className="text-sm mt-1">{limitError}</p>
                    </div>
                </div>
                <button onClick={onClose} className="bg-gray-200 px-4 py-2 rounded">Fechar</button>
            </div>
        ) : (
            <form onSubmit={handleSubmit} className="p-6 space-y-4">
            
            {/* Seletor de CÃ³pia - NOVIDADE */}
            {previousJobs.length > 0 && (
                <div className="bg-blue-50 p-3 rounded border border-blue-100 mb-4">
                    <label className="block text-xs font-bold text-blue-800 mb-1 flex items-center gap-1">
                        <Copy size={12}/> Copiar critÃ©rios de avaliaÃ§Ã£o de:
                    </label>
                    <select 
                        className="w-full border p-2 rounded text-sm bg-white"
                        value={copyFromId}
                        onChange={e => setCopyFromId(e.target.value)}
                    >
                        <option value="">-- ComeÃ§ar do Zero --</option>
                        {previousJobs.map(j => (
                            <option key={j.id} value={j.id}>{j.title}</option>
                        ))}
                    </select>
                </div>
            )}

            <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">TÃ­tulo da Vaga *</label>
                <input required className="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-blue-500" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} />
            </div>

            {tenantId && <AreaSelect tenantId={tenantId} value={formData.company_department_id} onChange={val => setFormData({...formData, company_department_id: val})} />}

            <div className="grid grid-cols-2 gap-4">
                <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Modelo</label>
                <select className="w-full border p-2 rounded bg-white" value={formData.location_type} onChange={e => setFormData({...formData, location_type: e.target.value})}>
                    <option>Presencial</option><option>HÃ­brido</option><option>Remoto</option>
                </select>
                </div>
                <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Contrato</label>
                <select className="w-full border p-2 rounded bg-white" value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})}>
                    <option>CLT</option><option>PJ</option><option>EstÃ¡gio</option>
                </select>
                </div>
            </div>

            <div><label className="block text-sm font-medium text-gray-700 mb-1">DescriÃ§Ã£o</label><textarea className="w-full border p-2 rounded outline-none" rows="3" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} /></div>
            <div><label className="block text-sm font-medium text-gray-700 mb-1">Requisitos</label><textarea className="w-full border p-2 rounded outline-none" rows="3" value={formData.requirements} onChange={e => setFormData({...formData, requirements: e.target.value})} /></div>

            <div className="flex justify-end gap-2 pt-4">
                <button type="button" onClick={onClose} className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded">Cancelar</button>
                <button type="submit" disabled={loading} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50">{loading ? 'Criando...' : 'Criar Vaga'}</button>
            </div>
            </form>
        )}
      </div>
    </div>
  );
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\components\jobs\JobCriteria.jsx
------------------------------------------------
import React, { useState, useEffect } from 'react';
import { supabase } from '../../supabase/client';
import { Save, Plus, Trash2, Copy, AlertCircle, CheckCircle2 } from 'lucide-react';

export default function JobCriteria({ job, onUpdate }) {
  const defaultParams = {
    triagem: [],
    cultura: [],
    tecnico: [],
    notas: [
      { id: '1', nome: 'Abaixo', valor: 0 },
      { id: '2', nome: 'Atende', valor: 5 },
      { id: '3', nome: 'Supera', valor: 10 }
    ]
  };

  const [params, setParams] = useState(job.parameters || defaultParams);
  const [loading, setLoading] = useState(false);
  const [importJobId, setImportJobId] = useState('');
  const [allJobs, setAllJobs] = useState([]);

  useEffect(() => {
    const fetchJobs = async () => {
      const { data } = await supabase
        .from('jobs')
        .select('id, title')
        .neq('id', job.id)
        .order('created_at', { ascending: false });
      setAllJobs(data || []);
    };
    fetchJobs();
  }, [job.id]);

  // --- LÃ“GICA DE CRITÃ‰RIOS (PESOS) ---
  const getSectionTotal = (sectionKey) => {
    const items = params[sectionKey] || [];
    return items.reduce((acc, item) => acc + (Number(item.weight) || 0), 0);
  };

  const addItem = (section) => {
    const newItem = { name: '', weight: 0 };
    setParams({ ...params, [section]: [...(params[section] || []), newItem] });
  };

  const removeItem = (section, index) => {
    const newList = [...params[section]];
    newList.splice(index, 1);
    setParams({ ...params, [section]: newList });
  };

  const updateItem = (section, index, field, value) => {
    const newList = [...params[section]];
    newList[index][field] = value;
    setParams({ ...params, [section]: newList });
  };

  // --- LÃ“GICA DA RÃ‰GUA DE NOTAS (NOVA) ---
  const addNoteLevel = () => {
    const newNote = { id: crypto.randomUUID(), nome: '', valor: 0 };
    setParams({ ...params, notas: [...(params.notas || []), newNote] });
  };

  const removeNoteLevel = (index) => {
    const newNotas = [...params.notas];
    newNotas.splice(index, 1);
    setParams({ ...params, notas: newNotas });
  };

  const updateNoteLevel = (index, field, value) => {
    const newNotas = [...params.notas];
    newNotas[index][field] = value;
    setParams({ ...params, notas: newNotas });
  };

  // --- SALVAR E IMPORTAR ---
  const handleSave = async () => {
    // 1. ValidaÃ§Ã£o de Pesos
    const sections = ['triagem', 'cultura', 'tecnico'];
    const errors = [];

    sections.forEach(sec => {
      const total = getSectionTotal(sec);
      if ((params[sec] && params[sec].length > 0) && total !== 100) {
        errors.push(`A seÃ§Ã£o ${sec.toUpperCase()} soma ${total}% (deve ser 100%).`);
      }
    });

    // 2. ValidaÃ§Ã£o da RÃ©gua de Notas
    if (!params.notas || params.notas.length < 2) {
      errors.push("A RÃ©gua de Notas deve ter pelo menos 2 nÃ­veis (ex: Min e Max).");
    }

    if (errors.length > 0) {
      alert(`Erro de ValidaÃ§Ã£o:\n\n${errors.join('\n')}\n\nAjuste antes de salvar.`);
      return;
    }

    setLoading(true);
    const { error } = await supabase
      .from('jobs')
      .update({ parameters: params })
      .eq('id', job.id);

    if (error) alert("Erro ao salvar: " + error.message);
    else {
      alert("CritÃ©rios atualizados com sucesso!");
      if (onUpdate) onUpdate();
    }
    setLoading(false);
  };

  const importCriteria = async () => {
    if (!importJobId) return;
    const { data } = await supabase.from('jobs').select('parameters').eq('id', importJobId).single();
    if (data?.parameters) {
      setParams(data.parameters);
      alert("CritÃ©rios importados! Verifique os pesos e salve.");
    }
  };

  // --- RENDERIZADORES ---
  const renderSection = (title, key, color) => {
    const totalWeight = getSectionTotal(key);
    const isValid = totalWeight === 100;
    const isEmpty = !params[key] || params[key].length === 0;

    let statusColor = "text-gray-400";
    let statusIcon = null;
    let statusText = "Vazio (0%)";

    if (!isEmpty) {
      if (isValid) {
        statusColor = "text-green-600";
        statusIcon = <CheckCircle2 size={16} />;
        statusText = "Total: 100% (OK)";
      } else {
        statusColor = "text-red-600";
        statusIcon = <AlertCircle size={16} />;
        statusText = `Total: ${totalWeight}% (Faltam ${100 - totalWeight}%)`;
      }
    }

    return (
      <div className={`bg-gray-50 p-4 rounded border mb-4 ${!isEmpty && !isValid ? 'border-red-200 bg-red-50' : ''}`}>
        <div className="flex justify-between items-center mb-3">
          <div className="flex flex-col">
            <h3 className={`font-bold uppercase text-sm ${color}`}>{title}</h3>
            <div className={`text-xs font-bold flex items-center gap-1 mt-1 ${statusColor}`}>
              {statusIcon} {statusText}
            </div>
          </div>
          <button onClick={() => addItem(key)} className="text-xs flex items-center gap-1 text-blue-600 font-bold hover:underline">
            <Plus size={14}/> Adicionar CritÃ©rio
          </button>
        </div>
        
        {isEmpty && <p className="text-sm text-gray-400 italic">Nenhum critÃ©rio definido.</p>}

        <div className="space-y-2">
          {(params[key] || []).map((item, idx) => (
            <div key={idx} className="flex gap-2 items-center">
              <input 
                className="flex-1 border p-1 rounded text-sm outline-none focus:ring-1 focus:ring-blue-500"
                placeholder="Nome do CritÃ©rio (Ex: ComunicaÃ§Ã£o)"
                value={item.name}
                onChange={e => updateItem(key, idx, 'name', e.target.value)}
              />
              <div className="w-24 relative">
                <input 
                  type="number"
                  className="w-full border p-1 rounded text-sm text-center pr-6 outline-none focus:ring-1 focus:ring-blue-500"
                  placeholder="%"
                  value={item.weight}
                  onChange={e => updateItem(key, idx, 'weight', e.target.value)}
                />
                <span className="absolute right-2 top-1 text-gray-400 text-xs">%</span>
              </div>
              <button onClick={() => removeItem(key, idx)} className="text-red-500 hover:bg-red-100 p-1 rounded">
                <Trash2 size={14}/>
              </button>
            </div>
          ))}
        </div>
      </div>
    );
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-end border-b pb-4">
        <div>
          <h2 className="text-lg font-bold text-gray-800">ConfiguraÃ§Ã£o da AvaliaÃ§Ã£o</h2>
          <p className="text-sm text-gray-500">Defina os critÃ©rios e seus pesos (Soma deve ser 100%).</p>
        </div>
        
        <div className="flex gap-2 items-center">
          <select 
            className="border p-2 rounded text-sm max-w-[200px]"
            value={importJobId}
            onChange={e => setImportJobId(e.target.value)}
          >
            <option value="">Copiar de outra vaga...</option>
            {allJobs.map(j => <option key={j.id} value={j.id}>{j.title}</option>)}
          </select>
          <button onClick={importCriteria} disabled={!importJobId} className="bg-gray-200 p-2 rounded hover:bg-gray-300" title="Copiar">
            <Copy size={16}/>
          </button>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          {renderSection('Triagem (RH)', 'triagem', 'text-purple-600')}
          {renderSection('Fit Cultural', 'cultura', 'text-green-600')}
        </div>
        
        <div>
          {renderSection('TÃ©cnico / Hard Skills', 'tecnico', 'text-blue-600')}
          
          {/* CONFIGURAÃ‡ÃƒO DA RÃ‰GUA DE NOTAS (DINÃ‚MICA) */}
          <div className="bg-white p-4 rounded border shadow-sm border-l-4 border-l-orange-400">
            <div className="flex justify-between items-center mb-3">
              <div>
                <h3 className="font-bold uppercase text-sm text-gray-800">RÃ©gua de Notas</h3>
                <p className="text-xs text-gray-500">Defina os nÃ­veis e valores para o cÃ¡lculo.</p>
              </div>
              <button onClick={addNoteLevel} className="text-xs flex items-center gap-1 text-orange-600 font-bold hover:underline">
                <Plus size={14}/> Novo NÃ­vel
              </button>
            </div>

            <div className="space-y-2">
              <div className="flex gap-2 text-xs font-bold text-gray-400 px-1">
                <span className="flex-1">Nome do NÃ­vel</span>
                <span className="w-20 text-center">Nota</span>
                <span className="w-6"></span>
              </div>
              
              {(params.notas || []).map((nota, idx) => (
                <div key={idx} className="flex gap-2 items-center">
                  <input 
                    className="flex-1 border p-1 rounded text-sm outline-none focus:ring-1 focus:ring-orange-500"
                    value={nota.nome}
                    placeholder="Ex: Atende"
                    onChange={e => updateNoteLevel(idx, 'nome', e.target.value)}
                  />
                  <input 
                    type="number"
                    className="w-20 border p-1 rounded text-sm text-center outline-none focus:ring-1 focus:ring-orange-500"
                    value={nota.valor}
                    placeholder="0"
                    onChange={e => updateNoteLevel(idx, 'valor', e.target.value)}
                  />
                  <button onClick={() => removeNoteLevel(idx)} className="text-red-400 hover:text-red-600 p-1">
                    <Trash2 size={14}/>
                  </button>
                </div>
              ))}
              
              {(!params.notas || params.notas.length === 0) && (
                <p className="text-sm text-red-500 italic py-2 text-center bg-red-50 rounded">
                  Defina pelo menos 2 nÃ­veis de nota.
                </p>
              )}
            </div>
          </div>
        </div>
      </div>

      <div className="flex justify-end pt-4 border-t">
        <button 
          onClick={handleSave} 
          disabled={loading}
          className="bg-blue-600 text-white px-6 py-2 rounded flex items-center gap-2 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium shadow-sm"
        >
          <Save size={18}/> {loading ? 'Salvando...' : 'Salvar ConfiguraÃ§Ã£o'}
        </button>
      </div>
    </div>
  );
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\components\AreaSelect.jsx
------------------------------------------------
import React, { useState, useEffect } from 'react';
import { supabase } from '../supabase/client';

export default function AreaSelect({ tenantId, value, onChange }) {
  const [departments, setDepartments] = useState([]);
  const [loading, setLoading] = useState(false);
  const [isCreating, setIsCreating] = useState(false);
  const [newName, setNewName] = useState('');

  useEffect(() => {
    if (tenantId) fetchDepts();
  }, [tenantId]);

  const fetchDepts = async () => {
    const { data } = await supabase
      .from('company_departments')
      .select('*')
      .eq('tenantId', tenantId)
      .order('name');
    setDepartments(data || []);
  };

  const handleCreate = async () => {
    if (!newName.trim()) return;
    setLoading(true);
    // Insere direto na tabela criada no SQL anterior
    const { data, error } = await supabase
      .from('company_departments')
      .insert({ name: newName, tenantId })
      .select()
      .single();
    
    if (!error && data) {
      setDepartments([...departments, data]);
      onChange(data.id); // Seleciona o novo
      setIsCreating(false);
      setNewName('');
    } else {
      alert('Erro ao criar departamento.');
    }
    setLoading(false);
  };

  if (isCreating) {
    return (
      <div className="flex gap-2 items-end">
        <div className="flex-1">
          <label className="block text-sm font-medium text-gray-700 mb-1">Nome da Nova Ãrea</label>
          <input 
            className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none"
            value={newName}
            onChange={e => setNewName(e.target.value)}
            placeholder="Ex: Financeiro"
            autoFocus
          />
        </div>
        <button 
          type="button"
          onClick={handleCreate} 
          disabled={loading}
          className="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 h-[42px]"
        >
          {loading ? '...' : 'Salvar'}
        </button>
        <button 
          type="button"
          onClick={() => setIsCreating(false)} 
          className="bg-gray-200 text-gray-700 px-3 py-2 rounded hover:bg-gray-300 h-[42px]"
        >
          X
        </button>
      </div>
    );
  }

  return (
    <div>
      <label className="block text-sm font-medium text-gray-700 mb-1">Departamento / Ãrea</label>
      <select 
        className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white"
        value={value || ''}
        onChange={e => {
          if (e.target.value === 'NEW') setIsCreating(true);
          else onChange(e.target.value);
        }}
      >
        <option value="">Selecione...</option>
        {departments.map(d => (
          <option key={d.id} value={d.id}>{d.name}</option>
        ))}
        <option value="NEW" className="font-bold text-blue-600">+ Criar Nova Ãrea</option>
      </select>
    </div>
  );
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\components\EvaluationForm.jsx
------------------------------------------------
import React, { useState, useEffect } from 'react';
import { supabase } from '../supabase/client';
import { Save, UserCheck, MessageSquare } from 'lucide-react';
import { Box, Typography, Paper, Grid, Button, TextField, Alert } from '@mui/material';
import { processEvaluation } from '../utils/evaluationLogic';

export default function EvaluationForm({ applicationId, jobParameters, initialData, allEvaluations, onSaved }) {
  const [answers, setAnswers] = useState({ triagem: {}, cultura: {}, tecnico: {} });
  const [notes, setNotes] = useState('');
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    if (initialData) {
        setAnswers({
            triagem: initialData.triagem || {},
            cultura: initialData.cultura || {},
            tecnico: initialData.tecnico || {}
        });
        setNotes(initialData.anotacoes_gerais || '');
    }
  }, [initialData]);

  const currentScores = processEvaluation({ scores: answers }, jobParameters);

  const handleSelection = (section, criteriaName, noteId) => {
      setAnswers(prev => {
          const newSection = { ...prev[section] };
          if (newSection[criteriaName] === noteId) delete newSection[criteriaName];
          else newSection[criteriaName] = noteId;
          return { ...prev, [section]: newSection };
      });
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("UsuÃ¡rio nÃ£o logado");

      const finalCalc = processEvaluation({ scores: answers }, jobParameters);

      const payload = {
        triagem: answers.triagem,
        cultura: answers.cultura,
        tecnico: answers.tecnico,
        anotacoes_gerais: notes,
        pillar_scores: finalCalc,
        evaluator_name: user.email,
        updated_at: new Date()
      };

      const { error: evalError } = await supabase.from('evaluations').upsert({
            application_id: applicationId,
            evaluator_id: user.id,
            scores: payload, 
            notes: notes,
            final_score: finalCalc.total
        }, { onConflict: 'application_id, evaluator_id' });

      if (evalError) throw evalError;
      alert("Salvo!");
      if (onSaved) onSaved();
    } catch (error) { alert("Erro: " + error.message); } finally { setSaving(false); }
  };

  const renderSectionCompact = (key, title, criteria) => {
    if (!criteria?.length) return null;
    const ratingScale = jobParameters.notas || [];
    const tempScores = processEvaluation({ scores: answers }, jobParameters);
    
    return (
      <Paper variant="outlined" sx={{ p: 1.5, mb: 2, borderColor: '#e0e0e0', bgcolor: '#fff' }}>
        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 1 }}>
            <Typography variant="subtitle2" sx={{ fontWeight: 'bold', fontSize: '0.85rem', color: '#1976d2' }}>{title}</Typography>
            <Typography variant="caption" sx={{ fontWeight: 'bold', bgcolor: '#e3f2fd', px: 1, py: 0.5, borderRadius: 1 }}>Nota: {tempScores[key].toFixed(1)}</Typography>
        </Box>
        {criteria.map((crit, idx) => (
            <Box key={idx} sx={{ mb: 1.5, borderBottom: '1px dashed #eee', pb: 1 }}>
                <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 0.5 }}>
                    <Typography variant="caption" sx={{ fontWeight: 500, width: '80%', lineHeight: 1.2 }}>{crit.name}</Typography>
                    <Typography variant="caption" color="text.secondary">{crit.weight}%</Typography>
                </Box>
                <Box sx={{ display: 'flex', gap: 0.5, flexWrap: 'wrap' }}>
                    {ratingScale.map(option => (
                        <Button key={option.id} size="small" onClick={() => handleSelection(key, crit.name, option.id)}
                                sx={{ minWidth: '30px', height: '24px', fontSize: '0.65rem', p: '0 8px', textTransform: 'none', bgcolor: answers[key]?.[crit.name] === option.id ? '#1976d2' : '#f5f5f5', color: answers[key]?.[crit.name] === option.id ? '#fff' : '#666', '&:hover': { bgcolor: answers[key]?.[crit.name] === option.id ? '#1565c0' : '#eeeeee' } }}>
                            {option.nome}
                        </Button>
                    ))}
                </Box>
            </Box>
        ))}
      </Paper>
    );
  };

  if (!jobParameters) return <Typography variant="caption">Carregando...</Typography>;

  return (
    <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
      <Box sx={{ mb: 2, display: 'flex', justifyContent: 'space-between', alignItems: 'center', bgcolor: '#fff', p: 1.5, borderRadius: 1, border: '1px solid #e0e0e0' }}>
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <UserCheck size={16} color="#666" />
            <Typography variant="body2" sx={{ fontWeight: 'bold' }}>Minha AvaliaÃ§Ã£o</Typography>
        </Box>
        <Typography variant="h6" sx={{ fontWeight: 'bold', color: '#1976d2' }}>
            {currentScores.total.toFixed(1)} <Typography component="span" variant="caption" color="text.secondary">/10</Typography>
        </Typography>
      </Box>

      <Box sx={{ flex: 1, overflowY: 'auto', pr: 1 }}>
          <Grid container spacing={1}>
              <Grid item xs={12} md={4}>{renderSectionCompact("triagem", "Triagem", jobParameters.triagem)}</Grid>
              <Grid item xs={12} md={4}>{renderSectionCompact("cultura", "Fit Cultural", jobParameters.cultura)}</Grid>
              <Grid item xs={12} md={4}>{renderSectionCompact("tecnico", "TÃ©cnico", jobParameters.tecnico || jobParameters['tÃ©cnico'])}</Grid>
          </Grid>
          
          <Paper variant="outlined" sx={{ p: 2, mt: 1 }}>
            <Typography variant="caption" fontWeight="bold" color="text.secondary" sx={{ textTransform: 'uppercase', mb: 1, display: 'block' }}>Minhas AnotaÃ§Ãµes</Typography>
            <TextField multiline rows={2} fullWidth variant="outlined" size="small" value={notes} onChange={e => setNotes(e.target.value)} placeholder="ComentÃ¡rios..." sx={{ bgcolor: '#fff' }} InputProps={{ style: { fontSize: '0.8rem' } }} />
          </Paper>

          {/* HISTÃ“RICO DE TODAS AS ANOTAÃ‡Ã•ES */}
          <Box sx={{ mt: 3, borderTop: '1px solid #eee', pt: 2 }}>
              <Typography variant="caption" fontWeight="bold" color="text.secondary" sx={{ textTransform: 'uppercase', mb: 1, display: 'flex', alignItems: 'center', gap: 1 }}>
                  <MessageSquare size={14} /> HistÃ³rico de ObservaÃ§Ãµes ({allEvaluations?.length || 0})
              </Typography>
              {allEvaluations && allEvaluations.length > 0 ? allEvaluations.map((ev, i) => (
                  <Box key={i} sx={{ mb: 1, p: 1.5, bgcolor: '#f9fafb', borderRadius: 1, border: '1px solid #eee' }}>
                      <Box display="flex" justifyContent="space-between" mb={0.5}>
                          {/* Usa o nome mapeado ou fallback */}
                          <Typography variant="caption" fontWeight="bold" color="primary">{ev.evaluator_name || 'UsuÃ¡rio'}</Typography>
                          <Typography variant="caption" color="text.secondary">Nota: {Number(ev.final_score).toFixed(1)}</Typography>
                      </Box>
                      <Typography variant="body2" sx={{ fontSize: '0.8rem', color: '#444' }}>{ev.notes || ev.scores?.anotacoes_gerais || 'Sem comentÃ¡rios.'}</Typography>
                  </Box>
              )) : <Typography variant="caption" color="text.secondary">Nenhuma avaliaÃ§Ã£o registrada ainda.</Typography>}
          </Box>
      </Box>

      <Box sx={{ mt: 2, pt: 1, borderTop: '1px solid #eee' }}>
        <Button onClick={handleSave} disabled={saving} variant="contained" fullWidth color="primary" startIcon={<Save size={16}/>} sx={{ textTransform: 'none', fontWeight: 'bold' }}>{saving ? "Salvando..." : "Salvar Minha Nota"}</Button>
      </Box>
    </Box>
  );
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\pages\ApplicationDetails.jsx
------------------------------------------------
import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { supabase } from '../supabase/client';
import EvaluationForm from '../components/EvaluationForm';
import { ArrowLeft, Mail, MapPin, BookOpen, FileText, Download, Linkedin, Github, Phone, Calendar } from 'lucide-react';
import { Box, Grid, Paper, Typography, Button, CircularProgress, Divider, Avatar } from '@mui/material';
import { processEvaluation } from '../utils/evaluationLogic';
import { formatPhone, formatUrl } from '../utils/formatters';

export default function ApplicationDetails() {
  const { appId } = useParams();
  const navigate = useNavigate();
  
  const [appData, setAppData] = useState(null);
  const [job, setJob] = useState(null);
  const [currentUserEvaluation, setCurrentUserEvaluation] = useState(null);
  const [globalScore, setGlobalScore] = useState(0);
  const [evaluatorsCount, setEvaluatorsCount] = useState(0);
  const [allEvaluations, setAllEvaluations] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchData();
  }, [appId]);

  const fetchData = async () => {
    setLoading(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      const { data: application } = await supabase.from('applications').select('*, candidates(*)').eq('id', appId).single();
      const candidateObj = Array.isArray(application.candidates) ? application.candidates[0] : application.candidates;
      
      // Parse Seguro do formData
      let safeFormData = application.formData;
      if (typeof safeFormData === 'string') {
          try { safeFormData = JSON.parse(safeFormData); } catch(e) { console.log('Erro parse formData', e); }
      }
      
      setAppData({ ...application, formData: safeFormData, candidate: candidateObj });

      let jobParams = {};
      if (application.jobId) {
        const { data: jobData } = await supabase.from('jobs').select('*').eq('id', application.jobId).single();
        setJob(jobData);
        jobParams = jobData.parameters || {};
      }

      const { data: allEvals } = await supabase.from('evaluations').select('*').eq('application_id', appId);
      if (allEvals) {
          const userIds = [...new Set(allEvals.map(e => e.evaluator_id))];
          let usersMap = {};
          if (userIds.length > 0) {
              const { data: users } = await supabase.from('users').select('id, name, email').in('id', userIds);
              users?.forEach(u => usersMap[u.id] = u.name || u.email);
          }
          const evalsWithNames = allEvals.map(e => ({ ...e, evaluator_name: usersMap[e.evaluator_id] || 'Avaliador' }));
          setAllEvaluations(evalsWithNames);
          setEvaluatorsCount(evalsWithNames.length);
          
          let sumTotal = 0, validCount = 0;
          evalsWithNames.forEach(ev => {
              const scores = processEvaluation(ev, jobParams);
              if (scores.total > 0) { sumTotal += scores.total; validCount++; }
          });
          setGlobalScore(validCount > 0 ? (sumTotal / validCount) : 0);

          if (user) {
              const myEval = allEvals.find(e => e.evaluator_id === user.id);
              if (myEval) {
                  const myScores = processEvaluation(myEval, jobParams);
                  setCurrentUserEvaluation({ ...myEval.scores, anotacoes_gerais: myEval.notes || myEval.scores?.anotacoes_gerais, final_score: myScores.total });
              } else { setCurrentUserEvaluation(null); }
          }
      }
    } catch (err) { console.error(err); } finally { setLoading(false); }
  };

  const renderInfo = (data) => {
    if (!data) return null;
    
    // Suporte para estrutura plana (novo JSON) ou aninhada (antigo)
    const course = data.course || data.education?.course;
    const institution = data.institution || data.education?.institution;
    const year = data.completionYear || data.education?.date;
    const birth = data.birthDate;
    const eng = data.englishLevel;

    return (
        <>
            {/* Bloco FormaÃ§Ã£o */}
            <Box sx={{ mt: 3 }}>
                <Typography variant="caption" fontWeight="bold" sx={{textTransform: 'uppercase', color: 'text.secondary', display:'flex', alignItems:'center', gap:1}}>
                    <BookOpen size={14}/> FormaÃ§Ã£o
                </Typography>
                <Box sx={{ bgcolor: '#f9fafb', p: 1.5, borderRadius: 1, border: '1px solid #eee', mt: 0.5 }}>
                    <Typography variant="caption" display="block" fontWeight="bold">{course || 'Curso nÃ£o informado'}</Typography>
                    <Typography variant="caption" display="block" color="text.secondary">{institution || 'InstituiÃ§Ã£o nÃ£o informada'}</Typography>
                    {year && <Typography variant="caption" display="block" color="text.secondary">ConclusÃ£o: {year}</Typography>}
                </Box>
            </Box>

            {/* Bloco Extras (InglÃªs, Nasc) */}
            {(birth || eng) && (
                <Box sx={{ mt: 2 }}>
                    <Typography variant="caption" fontWeight="bold" sx={{textTransform: 'uppercase', color: 'text.secondary', display:'flex', alignItems:'center', gap:1}}>
                        <Calendar size={14}/> Detalhes
                    </Typography>
                    <Box sx={{ bgcolor: '#f9fafb', p: 1.5, borderRadius: 1, border: '1px solid #eee', mt: 0.5 }}>
                        {birth && <Typography variant="caption" display="block">Nascimento: {birth}</Typography>}
                        {eng && <Typography variant="caption" display="block">InglÃªs: {eng}</Typography>}
                    </Box>
                </Box>
            )}
        </>
    );
  };

  const renderScoreBadges = (gScore, myScore, count) => {
    const getBgColor = (s) => s >= 8 ? '#e8f5e9' : s >= 5 ? '#fff3e0' : '#ffebee';
    const getTextColor = (s) => s >= 8 ? '#2e7d32' : s >= 5 ? '#ef6c00' : '#c62828';
    return (
        <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 3, width: '100%' }}>
            <Paper elevation={0} sx={{ bgcolor: getBgColor(gScore), p: 2, borderRadius: 2, border: '1px solid', borderColor: 'divider', textAlign: 'center' }}>
                <Typography variant="subtitle2" sx={{ textTransform: 'uppercase', fontWeight: 'bold', color: 'text.secondary', fontSize: '0.75rem' }}>Nota Global</Typography>
                <Typography variant="caption" sx={{ display:'block', fontSize: '0.7rem', color: 'text.secondary', mb: 0.5 }}>({count} {count === 1 ? 'avaliaÃ§Ã£o' : 'avaliaÃ§Ãµes'})</Typography>
                <Typography variant="h3" sx={{ fontWeight: 800, color: getTextColor(gScore), lineHeight: 1 }}>{Number(gScore || 0).toFixed(1)}</Typography>
            </Paper>
            <Paper elevation={0} sx={{ bgcolor: '#f3f4f6', p: 2, borderRadius: 2, border: '1px solid', borderColor: 'divider', textAlign: 'center' }}>
                <Typography variant="subtitle2" sx={{ textTransform: 'uppercase', fontWeight: 'bold', color: 'text.secondary', fontSize: '0.75rem', mb: 1 }}>Minha Nota</Typography>
                <Typography variant="h3" sx={{ fontWeight: 800, color: '#374151', lineHeight: 1 }}>{Number(myScore || 0).toFixed(1)}</Typography>
            </Paper>
        </Box>
    );
  };

  if (loading) return <Box p={4} display="flex" justifyContent="center"><CircularProgress /></Box>;
  if (!appData) return <Box p={4} textAlign="center">Candidato nÃ£o encontrado.</Box>;

  const params = job?.parameters || {};
  const formData = appData.formData || {};
  const candidate = appData.candidate || {};
  
  // Mescla dados do formData com a tabela candidate
  const displayPhone = candidate.phone || formData.phone;
  const displayCity = candidate.city || formData.city;
  const displayState = candidate.state || formData.state;
  const linkedIn = candidate.linkedin_profile || formData.linkedinProfile || formData.linkedin_profile;
  const gitHub = candidate.github_profile || formData.githubProfile;

  return (
    <Box sx={{ bgcolor: '#f8f9fa', minHeight: '100vh', p: 2 }}>
      <Button onClick={() => navigate(-1)} startIcon={<ArrowLeft size={16}/>} sx={{ mb: 2, color: 'text.secondary' }}>Voltar</Button>
      <Grid container spacing={3}>
        <Grid item xs={12} md={3}>
          <Paper sx={{ p: 3, height: '100%' }} elevation={0} variant="outlined">
            <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', textAlign: 'center' }}>
              <Avatar sx={{ width: 80, height: 80, bgcolor: '#1976d2', fontSize: '2rem', mb: 2, fontWeight: 'bold' }}>{candidate.name?.[0]}</Avatar>
              <Typography variant="h6" sx={{ fontSize: '1.1rem', fontWeight: 'bold', lineHeight: 1.2 }}>{candidate.name}</Typography>
              <Typography variant="caption" color="text.secondary" sx={{ mb: 2 }}>{job?.title}</Typography>
              {renderScoreBadges(globalScore, currentUserEvaluation?.final_score, evaluatorsCount)}
            </Box>
            <Divider sx={{ my: 3 }} />
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5 }}>
                <Box display="flex" alignItems="center" gap={1.5}><Mail size={16} className="text-gray-400"/><Typography variant="body2" sx={{wordBreak: 'break-all'}}>{candidate.email || formData.email}</Typography></Box>
                <Box display="flex" alignItems="center" gap={1.5}><Phone size={16} className="text-gray-400"/><Typography variant="body2">{formatPhone(displayPhone)}</Typography></Box>
                <Box display="flex" alignItems="center" gap={1.5}><MapPin size={16} className="text-gray-400"/><Typography variant="body2">{displayCity} - {displayState}</Typography></Box>
            </Box>
            <Box sx={{ mt: 3, display: 'flex', flexDirection: 'column', gap: 1 }}>
                {candidate.resume_url && (<Button variant="contained" color="primary" fullWidth href={candidate.resume_url} target="_blank" startIcon={<Download size={18}/>} sx={{ mb: 1, textTransform: 'none', fontWeight: 'bold' }}>Ver CurrÃ­culo</Button>)}
                {linkedIn && (<Button variant="outlined" fullWidth href={formatUrl(linkedIn)} target="_blank" startIcon={<Linkedin size={16}/>} sx={{ textTransform: 'none', color: '#0077b5', borderColor: '#0077b5' }}>LinkedIn</Button>)}
                {gitHub && (<Button variant="outlined" fullWidth href={formatUrl(gitHub)} target="_blank" startIcon={<Github size={16}/>} sx={{ textTransform: 'none', color: '#333', borderColor: '#333' }}>GitHub</Button>)}
            </Box>
            <Divider sx={{ my: 3 }} />
            
            {renderInfo(formData)}

            <Box sx={{ mt: 3 }}>
               <Typography variant="caption" fontWeight="bold" sx={{textTransform: 'uppercase', color: 'text.secondary', display:'flex', alignItems:'center', gap:1}}><FileText size={14}/> MotivaÃ§Ã£o</Typography>
               <Typography variant="body2" paragraph sx={{ bgcolor: '#f9fafb', p: 1.5, borderRadius: 1, border: '1px solid #eee', mt: 1, whiteSpace: 'pre-line', fontSize: '0.85rem' }}>{formData.motivation || 'NÃ£o informada'}</Typography>
            </Box>
            <Box sx={{ mt: 2 }}><Typography variant="caption" color="text.secondary">Candidatou-se em: {new Date(appData.created_at).toLocaleDateString('pt-BR')}</Typography></Box>
          </Paper>
        </Grid>
        <Grid item xs={12} md={9}>
          <Paper sx={{ p: 0, height: '100%', overflow: 'hidden', bgcolor: 'transparent' }} elevation={0}>
             <EvaluationForm applicationId={appData.id} jobParameters={params} initialData={currentUserEvaluation} allEvaluations={allEvaluations} onSaved={fetchData} />
          </Paper>
        </Grid>
      </Grid>
    </Box>
  );
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\pages\ApplyJob.jsx
------------------------------------------------
import React, { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import { supabase } from '../supabase/client';
import { Building, MapPin, Briefcase, CheckCircle, Send, GraduationCap, User, Link as LinkIcon, FileText, Upload, Paperclip } from 'lucide-react';

export default function ApplyJob() {
  const { jobId } = useParams();
  const [job, setJob] = useState(null);
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [success, setSuccess] = useState(false);

  // Estados para Upload de Arquivo
  const [resumeType, setResumeType] = useState('file'); // 'file' ou 'link'
  const [resumeFile, setResumeFile] = useState(null);

  // Estado do FormulÃ¡rio
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    city: '',
    state: '',
    linkedin_profile: '',
    github_profile: '',
    resume_url: '', // SerÃ¡ preenchido automaticamente apÃ³s upload
    
    motivation: '',
    education_level: '',
    education_status: '',
    course_name: '',
    institution: '',
    conclusion_date: '',
    current_period: ''
  });

  useEffect(() => {
    fetchJobDetails();
  }, [jobId]);

  const fetchJobDetails = async () => {
    const { data, error } = await supabase
      .from('jobs')
      .select('title, description, requirements, location_type, type, status')
      .eq('id', jobId)
      .single();

    if (error || !data) {
      alert("Vaga nÃ£o encontrada ou encerrada.");
    } else {
      setJob(data);
    }
    setLoading(false);
  };

  const handleInputChange = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleFileChange = (e) => {
    if (e.target.files && e.target.files.length > 0) {
      setResumeFile(e.target.files[0]);
    }
  };

  const uploadResumeToStorage = async () => {
    if (!resumeFile) return null;

    const fileExt = resumeFile.name.split('.').pop();
    const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
    const filePath = `${fileName}`;

    // 1. Upload para o bucket 'resumes'
    const { error: uploadError } = await supabase.storage
      .from('resumes')
      .upload(filePath, resumeFile);

    if (uploadError) throw new Error("Erro no upload do arquivo: " + uploadError.message);

    // 2. Pegar URL pÃºblica
    const { data } = supabase.storage.from('resumes').getPublicUrl(filePath);
    return data.publicUrl;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setSubmitting(true);

    try {
      if (job.status !== 'active') throw new Error("Esta vaga nÃ£o estÃ¡ mais aceitando candidaturas.");
      
      let finalResumeUrl = formData.resume_url;

      // --- LÃ“GICA DE UPLOAD ---
      if (resumeType === 'file') {
        if (!resumeFile) throw new Error("Por favor, selecione um arquivo de currÃ­culo.");
        finalResumeUrl = await uploadResumeToStorage();
      } else {
        if (!formData.resume_url) throw new Error("Por favor, informe o link do currÃ­culo.");
      }

      // 1. Upsert Candidato
      const { data: candidate, error: candError } = await supabase
        .from('candidates')
        .upsert({
            email: formData.email,
            name: formData.name,
            phone: formData.phone,
            city: formData.city,
            state: formData.state,
            linkedin_profile: formData.linkedin_profile,
            github_profile: formData.github_profile,
            resume_url: finalResumeUrl, // Usa a URL gerada ou o link colado
            updated_at: new Date()
        }, { onConflict: 'email' }) // Isso agora vai funcionar com a constraint criada no SQL
        .select()
        .single();

      if (candError) throw candError;

      // 2. Prepara Application Data
      const appPayload = {
        motivation: formData.motivation,
        education: {
            level: formData.education_level,
            status: formData.education_status,
            course: formData.course_name,
            institution: formData.institution,
            date: formData.conclusion_date,
            period: formData.current_period
        },
        applied_at: new Date().toISOString()
      };

      // 3. Insert Application
      const { error: appError } = await supabase
        .from('applications')
        .insert({
            jobId: jobId,
            candidateId: candidate.id,
            status: 'new',
            formData: appPayload
        });

      if (appError) {
        if (appError.code === '23505') throw new Error("VocÃª jÃ¡ se candidatou para esta vaga.");
        throw appError;
      }

      setSuccess(true);

    } catch (err) {
      alert("Erro ao enviar: " + err.message);
    } finally {
      setSubmitting(false);
    }
  };

  const isSuperiorOrTech = ['tecnico', 'superior', 'pos', 'mestrado'].includes(formData.education_level);
  const isStudying = formData.education_status === 'cursando';
  const isCompleted = formData.education_status === 'completo';

  if (loading) return <div className="min-h-screen flex items-center justify-center bg-gray-50">Carregando...</div>;
  if (!job) return <div className="min-h-screen flex items-center justify-center bg-gray-50">Vaga indisponÃ­vel.</div>;

  if (success) {
    return (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
            <div className="bg-white p-8 rounded-lg shadow-md text-center max-w-md w-full border-t-4 border-green-500">
                <div className="flex justify-center mb-4">
                    <div className="bg-green-100 p-3 rounded-full">
                        <CheckCircle className="text-green-600 w-12 h-12" />
                    </div>
                </div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">Candidatura Enviada!</h2>
                <p className="text-gray-600 mb-6">
                    Seus dados foram enviados com sucesso para a vaga de <strong>{job.title}</strong>.
                </p>
                <button onClick={() => window.location.reload()} className="text-blue-600 font-medium hover:underline text-sm">
                    Voltar para a vaga
                </button>
            </div>
        </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-10 px-4 font-sans">
      <div className="max-w-5xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden border border-gray-100">
        
        {/* Header da Vaga */}
        <div className="bg-slate-800 p-8 text-white relative">
            <h1 className="text-3xl font-bold mb-3">{job.title}</h1>
            <div className="flex flex-wrap gap-4 text-slate-300 text-sm font-medium">
                <span className="flex items-center gap-1 bg-slate-700 px-3 py-1 rounded-full"><Briefcase size={14}/> {job.type}</span>
                <span className="flex items-center gap-1 bg-slate-700 px-3 py-1 rounded-full"><MapPin size={14}/> {job.location_type}</span>
                <span className="flex items-center gap-1 bg-slate-700 px-3 py-1 rounded-full"><Building size={14}/> Novva R&S</span>
            </div>
        </div>

        <div className="grid lg:grid-cols-12">
            <div className="lg:col-span-5 p-8 bg-gray-50 border-r border-gray-100 sticky top-0 h-fit">
                <div className="space-y-8">
                    <div>
                        <h3 className="font-bold text-slate-800 text-lg mb-3 flex items-center gap-2">
                            <FileText size={20} className="text-blue-600"/> DescriÃ§Ã£o
                        </h3>
                        <p className="text-slate-600 whitespace-pre-line text-sm leading-relaxed">{job.description || "Sem descriÃ§Ã£o."}</p>
                    </div>
                    {job.requirements && (
                        <div>
                            <h3 className="font-bold text-slate-800 text-lg mb-3 flex items-center gap-2">
                                <CheckCircle size={20} className="text-green-600"/> Requisitos
                            </h3>
                            <p className="text-slate-600 whitespace-pre-line text-sm leading-relaxed">{job.requirements}</p>
                        </div>
                    )}
                </div>
            </div>

            <div className="lg:col-span-7 p-8 bg-white">
                <h2 className="text-2xl font-bold text-slate-800 mb-6 pb-2 border-b border-gray-100">Ficha de InscriÃ§Ã£o</h2>
                
                <form onSubmit={handleSubmit} className="space-y-8">
                    
                    {/* DADOS PESSOAIS */}
                    <section>
                        <h4 className="flex items-center gap-2 text-sm font-bold text-blue-600 uppercase mb-4 tracking-wide">
                            <User size={16}/> Dados BÃ¡sicos
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div className="md:col-span-2">
                                <label className="block text-xs font-bold text-gray-500 mb-1">Nome Completo *</label>
                                <input required className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                    value={formData.name} onChange={e => handleInputChange('name', e.target.value)} />
                            </div>
                            <div className="md:col-span-2">
                                <label className="block text-xs font-bold text-gray-500 mb-1">Email *</label>
                                <input required type="email" className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                    value={formData.email} onChange={e => handleInputChange('email', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">Telefone / Celular *</label>
                                <input required className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                    value={formData.phone} onChange={e => handleInputChange('phone', e.target.value)} />
                            </div>
                            <div className="grid grid-cols-3 gap-2">
                                <div className="col-span-2">
                                    <label className="block text-xs font-bold text-gray-500 mb-1">Cidade</label>
                                    <input className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                        value={formData.city} onChange={e => handleInputChange('city', e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">UF</label>
                                    <select className="w-full border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-blue-100"
                                        value={formData.state} onChange={e => handleInputChange('state', e.target.value)}>
                                        <option value="">--</option>
                                        {['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'].map(uf => (
                                            <option key={uf} value={uf}>{uf}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </section>

                    {/* CURRÃCULO E LINKS (COM UPLOAD) */}
                    <section>
                        <h4 className="flex items-center gap-2 text-sm font-bold text-blue-600 uppercase mb-4 tracking-wide border-t border-gray-100 pt-6">
                            <Paperclip size={16}/> CurrÃ­culo e Links
                        </h4>
                        
                        {/* Toggle Tipo de CurrÃ­culo */}
                        <div className="bg-gray-50 p-4 rounded-lg border mb-4">
                            <label className="block text-xs font-bold text-gray-500 mb-2">Como deseja enviar seu currÃ­culo?</label>
                            <div className="flex gap-4 mb-4">
                                <label className="flex items-center gap-2 text-sm cursor-pointer">
                                    <input type="radio" name="resumeType" checked={resumeType === 'file'} onChange={() => setResumeType('file')} />
                                    <Upload size={16} className="text-gray-600"/> Enviar Arquivo (PDF/DOC)
                                </label>
                                <label className="flex items-center gap-2 text-sm cursor-pointer">
                                    <input type="radio" name="resumeType" checked={resumeType === 'link'} onChange={() => setResumeType('link')} />
                                    <LinkIcon size={16} className="text-gray-600"/> Colar Link (Drive/LinkedIn)
                                </label>
                            </div>

                            {resumeType === 'file' ? (
                                <div>
                                    <input 
                                      type="file" 
                                      accept=".pdf,.doc,.docx"
                                      onChange={handleFileChange}
                                      className="block w-full text-sm text-slate-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-full file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-blue-50 file:text-blue-700
                                        hover:file:bg-blue-100"
                                    />
                                    <p className="text-xs text-gray-400 mt-1">Formatos aceitos: PDF, DOC, DOCX. MÃ¡x 5MB.</p>
                                </div>
                            ) : (
                                <input 
                                    className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                    placeholder="Cole aqui o link do seu currÃ­culo..."
                                    value={formData.resume_url} 
                                    onChange={e => handleInputChange('resume_url', e.target.value)} 
                                />
                            )}
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">Linkedin (Opcional)</label>
                                <input className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                    placeholder="linkedin.com/in/..."
                                    value={formData.linkedin_profile} onChange={e => handleInputChange('linkedin_profile', e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">GitHub / PortfÃ³lio (Opcional)</label>
                                <input className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                    placeholder="github.com/..."
                                    value={formData.github_profile} onChange={e => handleInputChange('github_profile', e.target.value)} />
                            </div>
                        </div>
                    </section>

                    {/* ESCOLARIDADE (CONDICIONAL) */}
                    <section>
                        <h4 className="flex items-center gap-2 text-sm font-bold text-blue-600 uppercase mb-4 tracking-wide border-t border-gray-100 pt-6">
                            <GraduationCap size={16}/> FormaÃ§Ã£o
                        </h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">NÃ­vel de Escolaridade *</label>
                                <select required className="w-full border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-blue-100"
                                    value={formData.education_level} onChange={e => handleInputChange('education_level', e.target.value)}
                                >
                                    <option value="">Selecione...</option>
                                    <option value="medio">Ensino MÃ©dio</option>
                                    <option value="tecnico">Ensino TÃ©cnico</option>
                                    <option value="superior">Superior (GraduaÃ§Ã£o)</option>
                                    <option value="pos">PÃ³s-GraduaÃ§Ã£o / MBA</option>
                                    <option value="mestrado">Mestrado / Doutorado</option>
                                </select>
                            </div>

                            {formData.education_level && (
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">Status *</label>
                                    <select required className="w-full border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-blue-100"
                                        value={formData.education_status} onChange={e => handleInputChange('education_status', e.target.value)}
                                    >
                                        <option value="">Selecione...</option>
                                        <option value="completo">Completo</option>
                                        <option value="cursando">Cursando</option>
                                        <option value="incompleto">Incompleto / Trancado</option>
                                    </select>
                                </div>
                            )}

                            {isSuperiorOrTech && formData.education_status && (
                                <>
                                    <div className="md:col-span-2">
                                        <label className="block text-xs font-bold text-gray-500 mb-1">Nome do Curso *</label>
                                        <input required className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                            value={formData.course_name} onChange={e => handleInputChange('course_name', e.target.value)} />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-xs font-bold text-gray-500 mb-1">InstituiÃ§Ã£o de Ensino *</label>
                                        <input required className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" 
                                            value={formData.institution} onChange={e => handleInputChange('institution', e.target.value)} />
                                    </div>
                                </>
                            )}

                            {isSuperiorOrTech && isStudying && (
                                <>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">PrevisÃ£o de Formatura *</label>
                                        <input required type="month" className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100" 
                                            value={formData.conclusion_date} onChange={e => handleInputChange('conclusion_date', e.target.value)} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">PerÃ­odo Atual *</label>
                                        <select required className="w-full border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-blue-100"
                                            value={formData.current_period} onChange={e => handleInputChange('current_period', e.target.value)}
                                        >
                                            <option value="">Selecione...</option>
                                            {[1,2,3,4,5,6,7,8,9,10].map(n => <option key={n} value={`${n}Âº Semestre`}>{n}Âº Semestre</option>)}
                                        </select>
                                    </div>
                                </>
                            )}

                            {isSuperiorOrTech && isCompleted && (
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">Ano de ConclusÃ£o *</label>
                                    <input required type="number" min="1970" max="2030" className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100" 
                                        value={formData.conclusion_date} onChange={e => handleInputChange('conclusion_date', e.target.value)} />
                                </div>
                            )}
                        </div>
                    </section>

                    {/* MOTIVAÃ‡ÃƒO */}
                    <section>
                        <h4 className="flex items-center gap-2 text-sm font-bold text-blue-600 uppercase mb-4 tracking-wide border-t border-gray-100 pt-6">
                            <FileText size={16}/> MotivaÃ§Ã£o
                        </h4>
                        <label className="block text-xs font-bold text-gray-500 mb-1">Por que vocÃª quer esta vaga?</label>
                        <textarea className="w-full border p-2.5 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition" rows="4" 
                            value={formData.motivation} onChange={e => handleInputChange('motivation', e.target.value)} />
                    </section>

                    <div className="pt-4">
                        <button 
                            disabled={submitting}
                            className="w-full bg-blue-600 text-white font-bold py-4 rounded-lg hover:bg-blue-700 transition flex justify-center items-center gap-2 shadow-lg disabled:opacity-70"
                        >
                           {submitting ? 'Enviando...' : <><Send size={18}/> Confirmar Candidatura</>}
                        </button>
                    </div>
                </form>
            </div>
        </div>
      </div>
    </div>
  );
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\pages\Dashboard.jsx
------------------------------------------------
import React, { useState, useEffect, useMemo } from 'react';
import { supabase } from '../supabase/client';
import { useNavigate } from 'react-router-dom';
import CreateJobModal from '../components/jobs/CreateJobModal';
import { Briefcase, Users, Plus, Settings as SettingsIcon, Clock, Link as LinkIcon, CheckCircle } from 'lucide-react';
import { differenceInDays, parseISO } from 'date-fns';

export default function Dashboard() {
  const navigate = useNavigate();
  const [profile, setProfile] = useState(null);
  const [jobs, setJobs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [deptFilter, setDeptFilter] = useState('all');
  const [fixing, setFixing] = useState(false);
  const [copiedId, setCopiedId] = useState(null); // NOVO: Estado para feedback do botÃ£o copiar

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    setLoading(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      // 1. Busca Perfil
      const { data: userProfile } = await supabase
        .from('user_profiles')
        .select('*')
        .eq('id', user.id)
        .single();

      setProfile(userProfile);

      // 2. Se tiver Tenant, busca vagas
      if (userProfile?.tenantId) {
        const [jobsResult, deptsResult] = await Promise.all([
          // Busca vagas e jÃ¡ conta os candidatos na query (count)
          supabase.from('jobs').select('*, applications(count)').eq('tenantId', userProfile.tenantId),
          supabase.from('company_departments').select('*').eq('tenantId', userProfile.tenantId)
        ]);

        const rawJobs = jobsResult.data || [];
        const depts = deptsResult.data || [];
        
        const deptMap = {};
        depts.forEach(d => deptMap[d.id] = d.name);

        const processed = rawJobs.map(j => ({
          ...j,
          deptName: j.company_department_id ? (deptMap[j.company_department_id] || 'Geral') : 'Geral',
          // MÃ©trica 1: Quantidade de Inscritos
          candidateCount: j.applications?.[0]?.count || 0,
          // MÃ©trica 2: Dias em Aberto
          daysOpen: differenceInDays(new Date(), parseISO(j.created_at))
        }));

        // Ordena por data (mais recente primeiro)
        processed.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        setJobs(processed);
      }
    } catch (error) {
      console.error("Erro ao carregar:", error);
    } finally {
      setLoading(false);
    }
  };

  // FunÃ§Ã£o para corrigir contas sem tenant (Mantida do original para seguranÃ§a)
  const fixAccount = async () => {
    setFixing(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      
      const { data: newTenant, error: tError } = await supabase
        .from('tenants')
        .insert({ "companyName": "Minha Empresa" })
        .select()
        .single();
      if (tError) throw tError;

      const { error: pError } = await supabase
        .from('user_profiles')
        .upsert({
          id: user.id,
          name: user.email.split('@')[0],
          "tenantId": newTenant.id,
          role: 'admin'
        });
      if (pError) throw pError;

      alert("Conta configurada com sucesso!");
      fetchData();
    } catch (err) {
      alert("Erro ao configurar: " + err.message);
    } finally {
      setFixing(false);
    }
  };

  // NOVO: FunÃ§Ã£o para copiar link da vaga sem entrar nela
  const copyJobLink = (e, jobId) => {
    e.stopPropagation(); // Impede que o clique abra a pÃ¡gina da vaga
    const link = `${window.location.origin}/apply/${jobId}`;
    navigator.clipboard.writeText(link).then(() => {
      setCopiedId(jobId);
      setTimeout(() => setCopiedId(null), 2000);
    });
  };

  const filteredJobs = useMemo(() => {
    if (deptFilter === 'all') return jobs;
    return jobs.filter(j => j.deptName === deptFilter);
  }, [jobs, deptFilter]);

  const uniqueDepts = [...new Set(jobs.map(j => j.deptName))].sort();

  if (loading) return <div className="p-10 text-center">Carregando Dashboard...</div>;

  return (
    <div className="p-8 max-w-7xl mx-auto">
      {/* Header */}
      <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b pb-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Dashboard</h1>
          <div className="flex items-center gap-2 text-sm text-gray-500 mt-1">
            <span className="bg-gray-100 px-2 py-0.5 rounded text-gray-600">
              {profile?.name || 'UsuÃ¡rio'}
            </span>
            <span className="text-gray-300">|</span>
            <button onClick={() => navigate('/settings')} className="text-gray-600 hover:text-blue-600 flex items-center gap-1">
               <SettingsIcon size={14} /> ConfiguraÃ§Ãµes
            </button>
            <span className="text-gray-300">|</span>
            <button onClick={() => supabase.auth.signOut()} className="text-red-500 hover:underline">
              Sair
            </button>
          </div>
        </div>
        
        {profile?.tenantId && (
          <button 
            onClick={() => setIsModalOpen(true)}
            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center shadow transition"
          >
            <Plus className="w-4 h-4 mr-2" /> Nova Vaga
          </button>
        )}
      </div>

      {!profile?.tenantId ? (
        <div className="bg-yellow-50 border border-yellow-200 p-8 rounded-lg text-center shadow-sm max-w-2xl mx-auto">
          <h2 className="text-xl font-bold text-yellow-800 mb-2">Finalizar ConfiguraÃ§Ã£o da Conta</h2>
          <p className="text-yellow-700 mb-6">
            Bem-vindo ao Novva R&S! Para comeÃ§ar, precisamos configurar sua empresa.
          </p>
          <button 
            onClick={fixAccount} 
            disabled={fixing}
            className="bg-yellow-600 text-white px-6 py-3 rounded-md font-bold hover:bg-yellow-700 shadow transition"
          >
            {fixing ? 'Configurando...' : 'âš™ï¸ Configurar Minha Empresa Agora'}
          </button>
        </div>
      ) : (
        <>
          {/* KPI Cards */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div className="bg-white p-6 rounded shadow border border-gray-100 flex items-center gap-4">
              <div className="p-3 bg-blue-100 text-blue-600 rounded-full"><Briefcase size={24}/></div>
              <div>
                <p className="text-sm text-gray-500">Vagas Ativas</p>
                <p className="text-2xl font-bold">{jobs.filter(j => j.status === 'active').length}</p>
              </div>
            </div>
            <div className="bg-white p-6 rounded shadow border border-gray-100 flex items-center gap-4">
              <div className="p-3 bg-green-100 text-green-600 rounded-full"><Users size={24}/></div>
              <div>
                <p className="text-sm text-gray-500">Total Candidatos</p>
                <p className="text-2xl font-bold">{jobs.reduce((acc, j) => acc + j.candidateCount, 0)}</p>
              </div>
            </div>
          </div>

          {/* Tabela de Vagas */}
          <div className="bg-white rounded shadow border overflow-hidden">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
              <h2 className="font-semibold text-gray-700">Listagem de Vagas</h2>
              <div className="flex items-center gap-2">
                <span className="text-sm text-gray-500">Filtrar:</span>
                <select 
                  className="border p-1 rounded text-sm bg-white outline-none"
                  value={deptFilter}
                  onChange={e => setDeptFilter(e.target.value)}
                >
                  <option value="all">Todas as Ãreas</option>
                  {uniqueDepts.map(d => <option key={d} value={d}>{d}</option>)}
                </select>
              </div>
            </div>

            <table className="w-full text-left text-sm">
              <thead className="bg-gray-50 text-gray-500 border-b">
                <tr>
                  <th className="p-4 font-medium">Ãrea / Depto</th>
                  <th className="p-4 font-medium">TÃ­tulo</th>
                  {/* NOVAS COLUNAS */}
                  <th className="p-4 font-medium text-center">Inscritos</th>
                  <th className="p-4 font-medium text-center">Tempo</th>
                  <th className="p-4 font-medium text-center">DivulgaÃ§Ã£o</th>
                  <th className="p-4 font-medium">Status</th>
                  <th className="p-4 font-medium text-right">AÃ§Ã£o</th>
                </tr>
              </thead>
              <tbody>
                {filteredJobs.length === 0 ? (
                  <tr><td colSpan="7" className="p-8 text-center text-gray-500">Nenhuma vaga encontrada.</td></tr>
                ) : (
                  filteredJobs.map(job => (
                    <tr 
                      key={job.id} 
                      onClick={() => navigate(`/jobs/${job.id}`)}
                      className="border-b hover:bg-blue-50 transition cursor-pointer group"
                    >
                      <td className="p-4 text-gray-600">{job.deptName}</td>
                      <td className="p-4 font-bold text-gray-800 group-hover:text-blue-600">{job.title}</td>
                      
                      {/* DADOS ADICIONADOS */}
                      <td className="p-4 text-center">
                          <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-bold text-xs">{job.candidateCount}</span>
                      </td>
                      <td className="p-4 text-center text-gray-500">
                          <div className="flex items-center justify-center gap-1">
                            <Clock size={14}/> {job.daysOpen} dias
                          </div>
                      </td>

                      {/* NOVO: BOTÃƒO DE LINK */}
                      <td className="p-4 text-center">
                        <button 
                          onClick={(e) => copyJobLink(e, job.id)}
                          className={`p-1.5 rounded transition ${
                            copiedId === job.id 
                            ? 'bg-green-100 text-green-700' 
                            : 'text-gray-400 hover:text-blue-600 hover:bg-white border border-transparent hover:border-gray-200'
                          }`}
                          title="Copiar Link para Candidatos"
                        >
                          {copiedId === job.id ? <CheckCircle size={16}/> : <LinkIcon size={16}/>}
                        </button>
                      </td>

                      <td className="p-4">
                        <span className={`px-2 py-1 rounded text-xs font-semibold ${job.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}`}>
                          {job.status === 'active' ? 'Ativa' : 'Inativa'}
                        </span>
                      </td>
                      <td className="p-4 text-right text-blue-600 font-medium">
                        Gerenciar â†’
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </>
      )}

      <CreateJobModal 
        open={isModalOpen} 
        onClose={() => setIsModalOpen(false)} 
        onSuccess={fetchData} 
      />
    </div>
  );
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\pages\JobDetails.jsx
------------------------------------------------
import React, { useState, useEffect, useMemo } from 'react';
import { useParams, Link as RouterLink, useNavigate } from 'react-router-dom';
import { supabase } from '../supabase/client';
import { 
    Container, Typography, Box, AppBar, Toolbar, Button, CircularProgress, 
    Paper, Tabs, Tab, TextField, IconButton, Snackbar,
    List, ListItem, ListItemText, Divider, Grid,
    Table, TableHead, TableRow, TableCell, TableBody, Checkbox,
    FormControl, InputLabel, Select, MenuItem, Chip, Modal, Alert
} from '@mui/material';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine, LabelList } from 'recharts';
import { Delete as DeleteIcon, ContentCopy as ContentCopyIcon } from '@mui/icons-material';
import { processEvaluation } from '../utils/evaluationLogic';

// --- COMPONENTES AUXILIARES ---
const modalStyle = { position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: 500, bgcolor: 'background.paper', boxShadow: 24, p: 4, borderRadius: 2 };

const CopyParametersModal = ({ open, onClose, currentJobId, onCopy }) => {
  const [jobs, setJobs] = useState([]);
  const [selectedJobId, setSelectedJobId] = useState('');
  useEffect(() => { if (open) { const f = async () => { const { data } = await supabase.from('jobs').select('id, title').neq('id', currentJobId).eq('status', 'active'); setJobs(data || []); }; f(); } }, [open, currentJobId]);
  const handleConfirm = async () => { if (!selectedJobId) return; const { data } = await supabase.from('jobs').select('parameters').eq('id', selectedJobId).single(); if (data?.parameters) onCopy(data.parameters); onClose(); };
  return ( <Modal open={open} onClose={onClose}><Box sx={modalStyle}><Typography variant="h6">Copiar de Vaga</Typography><FormControl fullWidth margin="normal"><InputLabel>Vaga</InputLabel><Select value={selectedJobId} onChange={e=>setSelectedJobId(e.target.value)} label="Vaga">{jobs.map(j=><MenuItem key={j.id} value={j.id}>{j.title}</MenuItem>)}</Select></FormControl><Box sx={{ mt: 3, display: 'flex', justifyContent: 'flex-end', gap: 1 }}><Button onClick={onClose}>Cancelar</Button><Button onClick={handleConfirm} variant="contained" disabled={!selectedJobId}>Copiar</Button></Box></Box></Modal> );
};

const ParametersSection = ({ criteria = [], onCriteriaChange }) => {
  const handleChange = (i, f, v) => { const n = [...criteria]; n[i] = { ...n[i], [f]: f==='weight'?Number(v):v }; onCriteriaChange(n); };
  const total = criteria.reduce((acc, c) => acc + (Number(c.weight)||0), 0);
  return (
    <Box sx={{mt:2}}>{criteria.map((c, i) => <Box key={i} display="flex" gap={2} mb={1}><TextField value={c.name} onChange={e=>handleChange(i,'name',e.target.value)} fullWidth size="small" label="CritÃ©rio" /><TextField type="number" value={c.weight} onChange={e=>handleChange(i,'weight',e.target.value)} sx={{width:100}} size="small" label="Peso %" /><IconButton onClick={()=>onCriteriaChange(criteria.filter((_,idx)=>idx!==i))} color="error"><DeleteIcon/></IconButton></Box>)}<Button onClick={()=>onCriteriaChange([...criteria, {name:'', weight:0}])} variant="outlined" size="small">Adicionar</Button><Typography color={total===100?'green':'red'} variant="caption" display="block" sx={{mt:1, fontWeight:'bold'}}>Total: {total}%</Typography></Box>
  );
};

export default function JobDetails() {
  const { jobId } = useParams();
  const [job, setJob] = useState(null);
  const [parameters, setParameters] = useState(null);
  const [loading, setLoading] = useState(true);
  const [tabValue, setTabValue] = useState(0);
  const [applicants, setApplicants] = useState([]);
  const [allEvaluations, setAllEvaluations] = useState([]);
  const [usersMap, setUsersMap] = useState({});
  const [evaluatorFilter, setEvaluatorFilter] = useState('all');
  const [isCopyModalOpen, setIsCopyModalOpen] = useState(false);
  const [feedback, setFeedback] = useState({ open: false, message: '', severity: 'success' });

  useEffect(() => {
    const fetchAllData = async () => {
      setLoading(true);
      try {
        const { data: jobData } = await supabase.from('jobs').select('*').eq('id', jobId).single();
        setJob(jobData);
        setParameters(jobData.parameters || { triagem: [], cultura: [], tecnico: [], notas: [] });

        const { data: appsData } = await supabase.from('applications').select('*, candidate:candidates(name, email)').eq('jobId', jobId);
        setApplicants(appsData || []);

        const appIds = (appsData || []).map(a => a.id);
        if (appIds.length > 0) {
            const { data: evalsData } = await supabase.from('evaluations').select('*').in('application_id', appIds);
            setAllEvaluations(evalsData || []);

            const userIds = [...new Set((evalsData || []).map(e => e.evaluator_id))];
            if (userIds.length > 0) {
                const { data: usersData } = await supabase.from('users').select('id, name, email').in('id', userIds);
                const map = {};
                usersData?.forEach(u => map[u.id] = u.name || u.email);
                setUsersMap(map);
            }
        }
      } catch (err) { console.error(err); } finally { setLoading(false); }
    };
    fetchAllData();
  }, [jobId]);

  const processedData = useMemo(() => {
    if (!parameters) return { chartData: [], evaluators: [] };

    const evaluators = Object.keys(usersMap).map(id => ({ id, name: usersMap[id] || 'Desconhecido' }));

    const chartData = applicants.map(app => {
        const appEvals = allEvaluations.filter(e => 
            String(e.application_id) === String(app.id) && 
            (evaluatorFilter === 'all' || e.evaluator_id === evaluatorFilter)
        );

        let sumT = 0, sumC = 0, sumTc = 0, count = 0, sumTotal = 0;
        appEvals.forEach(ev => {
            const scores = processEvaluation(ev, parameters);
            if (scores.total > 0 || scores.triagem > 0 || scores.cultura > 0 || scores.tecnico > 0) {
                sumT += scores.triagem; sumC += scores.cultura; sumTc += scores.tecnico; sumTotal += scores.total; count++;
            }
        });

        const avgT = count > 0 ? sumT / count : 0;
        const avgC = count > 0 ? sumC / count : 0;
        const avgTc = count > 0 ? sumTc / count : 0;
        const general = count > 0 ? sumTotal / count : 0;

        return {
            appId: app.id,
            name: app.candidate?.name || 'Sem Nome',
            email: app.candidate?.email,
            triagem: Number(avgT.toFixed(1)),
            cultura: Number(avgC.toFixed(1)),
            tecnico: Number(avgTc.toFixed(1)),
            total: Number(general.toFixed(1)),
            count: count,
            hired: app.isHired
        };
    }).sort((a, b) => b.total - a.total);

    return { chartData, evaluators };
  }, [applicants, allEvaluations, evaluatorFilter, parameters, usersMap]);

  const handleHireToggle = async (appId, currentStatus) => {
      const newStatus = !currentStatus;
      setApplicants(prev => prev.map(a => a.id === appId ? {...a, isHired: newStatus} : a));
      await supabase.from('applications').update({ isHired: newStatus }).eq('id', appId);
  };
  const handleSaveParameters = async () => {
      await supabase.from('jobs').update({ parameters }).eq('id', jobId);
      setFeedback({ open: true, message: 'Salvo!', severity: 'success' });
  };

  if (loading) return <Box p={5} display="flex" justifyContent="center"><CircularProgress /></Box>;

  return (
    <Box>
        <AppBar position="static" color="default" elevation={1}><Toolbar><Typography variant="h6" sx={{flexGrow:1}}>{job?.title}</Typography><Button color="inherit" component={RouterLink} to="/">Voltar</Button></Toolbar></AppBar>
        <Container maxWidth="xl" sx={{ mt: 4, mb: 4 }}>
            <Paper sx={{ mb: 3 }}><Tabs value={tabValue} onChange={(e, v) => setTabValue(v)} centered><Tab label="Candidatos" /><Tab label="ClassificaÃ§Ã£o" /><Tab label="ConfiguraÃ§Ãµes da Vaga" /></Tabs></Paper>
            
            {tabValue === 0 && (
                <Paper sx={{ p: 0 }}>
                    <Table>
                        <TableHead sx={{ bgcolor: '#f5f5f5' }}><TableRow><TableCell><strong>Nome</strong></TableCell><TableCell><strong>Email</strong></TableCell><TableCell align="center"><strong>AvaliaÃ§Ãµes</strong></TableCell><TableCell align="center"><strong>Nota Geral</strong></TableCell></TableRow></TableHead>
                        <TableBody>{processedData.chartData.map(d => (
                            <TableRow key={d.appId} hover component={RouterLink} to={`/applications/${d.appId}`} style={{textDecoration:'none', cursor:'pointer'}}>
                                <TableCell>{d.name}</TableCell>
                                <TableCell>{d.email}</TableCell>
                                <TableCell align="center"><Chip label={d.count} size="small" /></TableCell>
                                <TableCell align="center"><Chip label={d.total.toFixed(1)} color={d.total >= 8 ? 'success' : d.total >= 5 ? 'warning' : 'default'} variant={d.count > 0 ? 'filled' : 'outlined'}/></TableCell>
                            </TableRow>
                        ))}</TableBody>
                    </Table>
                </Paper>
            )}

            {tabValue === 1 && (
                <Grid container spacing={3}>
                    <Grid item xs={12} md={8}>
                        <Paper sx={{ p: 3, height: '600px', display: 'flex', flexDirection: 'column' }} elevation={3}>
                            {/* CABEÃ‡ALHO DO GRÃFICO MELHORADO */}
                            <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 3, pb: 2, borderBottom: '1px solid #f0f0f0' }}>
                                <Typography variant="h6" color="text.primary" fontWeight="bold">Comparativo de Desempenho</Typography>
                                <FormControl size="small" sx={{ minWidth: 220 }}>
                                    <InputLabel>Filtrar por Avaliador</InputLabel>
                                    <Select value={evaluatorFilter} label="Filtrar por Avaliador" onChange={(e) => setEvaluatorFilter(e.target.value)}>
                                        <MenuItem value="all">VisÃ£o Geral (MÃ©dia da Equipe)</MenuItem>
                                        {processedData.evaluators.map(ev => <MenuItem key={ev.id} value={ev.id}>{ev.name}</MenuItem>)}
                                    </Select>
                                </FormControl>
                            </Box>
                            
                            {processedData.chartData.some(d => d.total > 0) ? (
                                <Box sx={{ flex: 1, width: '100%', minHeight: 0 }}>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart 
                                            data={processedData.chartData} 
                                            layout="vertical" 
                                            margin={{ top: 10, right: 30, left: 10, bottom: 5 }} 
                                            barGap={4}
                                        >
                                            <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={true} stroke="#eee" />
                                            <XAxis type="number" domain={[0, 10]} ticks={[0, 2, 4, 6, 8, 10]} stroke="#999" />
                                            <YAxis 
                                                dataKey="name" 
                                                type="category" 
                                                width={150} // AUMENTADO PARA NÃƒO CORTAR NOMES
                                                style={{fontSize: '0.8rem', fontWeight: 500, fill: '#444'}} 
                                            />
                                            <Tooltip 
                                                cursor={{fill: '#f5f5f5'}}
                                                contentStyle={{ borderRadius: 8, border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}
                                                formatter={(val, name) => [val, name]} 
                                            />
                                            <Legend verticalAlign="top" height={40} iconType="circle" />
                                            
                                            <Bar dataKey="triagem" name="Triagem" fill="#90caf9" barSize={20} radius={[0, 4, 4, 0]}>
                                                <LabelList dataKey="triagem" position="right" style={{fontSize:'0.7rem', fill:'#666'}} formatter={(v)=>v>0?v:''}/>
                                            </Bar>
                                            <Bar dataKey="cultura" name="Fit Cultural" fill="#a5d6a7" barSize={20} radius={[0, 4, 4, 0]}>
                                                <LabelList dataKey="cultura" position="right" style={{fontSize:'0.7rem', fill:'#666'}} formatter={(v)=>v>0?v:''}/>
                                            </Bar>
                                            <Bar dataKey="tecnico" name="TÃ©cnico" fill="#ffcc80" barSize={20} radius={[0, 4, 4, 0]}>
                                                <LabelList dataKey="tecnico" position="right" style={{fontSize:'0.7rem', fill:'#666'}} formatter={(v)=>v>0?v:''}/>
                                            </Bar>
                                            
                                            {/* BARRA DE MÃ‰DIA GERAL DESTACADA */}
                                            <Bar dataKey="total" name="MÃ©dia Geral" fill="#4caf50" barSize={20} radius={[0, 4, 4, 0]}>
                                                <LabelList dataKey="total" position="right" style={{fontSize:'0.8rem', fontWeight:'bold', fill:'#2e7d32'}} />
                                            </Bar>
                                            
                                            <ReferenceLine x={5} stroke="red" strokeDasharray="3 3" />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </Box>
                            ) : (
                                <Box sx={{ flex: 1, display: 'flex', flexDirection:'column', alignItems: 'center', justifyContent: 'center', color: 'text.secondary', bgcolor:'#fafafa', borderRadius:2 }}>
                                    <Typography variant="body1">Ainda nÃ£o hÃ¡ dados suficientes.</Typography>
                                    <Typography variant="caption">Realize avaliaÃ§Ãµes para visualizar o grÃ¡fico.</Typography>
                                </Box>
                            )}
                        </Paper>
                    </Grid>
                    <Grid item xs={12} md={4}>
                        <Paper sx={{ height: '600px', display: 'flex', flexDirection: 'column' }} elevation={3}>
                            <Box sx={{ p: 2, bgcolor: '#f5f5f5', borderBottom: '1px solid #e0e0e0' }}><Typography variant="subtitle1" fontWeight="bold">Ranking Final</Typography></Box>
                            <List sx={{ overflowY: 'auto', flex: 1 }}>
                                {processedData.chartData.map((d, index) => (
                                    <React.Fragment key={d.appId}>
                                        <ListItem secondaryAction={<Checkbox checked={d.hired || false} onChange={() => handleHireToggle(d.appId, d.hired)} color="success" />}>
                                            <ListItemText 
                                                primary={<Typography variant="body2" fontWeight="bold">#{index + 1} {d.name}</Typography>} 
                                                secondary={<Typography variant="caption" color="text.secondary">MÃ©dia: <strong style={{color:'#2e7d32', fontSize:'0.9rem'}}>{d.total.toFixed(1)}</strong></Typography>} 
                                            />
                                        </ListItem>
                                        <Divider component="li" />
                                    </React.Fragment>
                                ))}
                            </List>
                        </Paper>
                    </Grid>
                </Grid>
            )}

            {tabValue === 2 && (
                <Box p={3} sx={{ bgcolor: 'white', borderRadius: 1, boxShadow: 1 }}>
                    <Paper variant="outlined" sx={{p:3, mb:3}}><Typography variant="subtitle1" fontWeight="bold" gutterBottom>1. Triagem</Typography><ParametersSection criteria={parameters?.triagem || []} onCriteriaChange={(c) => setParameters({...parameters, triagem: c})} /></Paper>
                    <Paper variant="outlined" sx={{p:3, mb:3}}><Typography variant="subtitle1" fontWeight="bold" gutterBottom>2. Fit Cultural</Typography><ParametersSection criteria={parameters?.cultura || []} onCriteriaChange={(c) => setParameters({...parameters, cultura: c})} /></Paper>
                    <Paper variant="outlined" sx={{p:3, mb:3}}><Typography variant="subtitle1" fontWeight="bold" gutterBottom>3. Teste TÃ©cnico</Typography><ParametersSection criteria={parameters?.tecnico || parameters?.['tÃ©cnico'] || []} onCriteriaChange={(c) => setParameters({...parameters, tecnico: c})} /></Paper>
                    <Box display="flex" justifyContent="flex-end"><Button variant="contained" color="primary" onClick={handleSaveParameters}>Salvar ConfiguraÃ§Ãµes</Button></Box>
                </Box>
            )}
        </Container>
        <CopyParametersModal open={isCopyModalOpen} onClose={() => setIsCopyModalOpen(false)} currentJobId={jobId} onCopy={(p) => { setParameters(p); setFeedback({open:true, message:'Copiado!', severity:'info'}); }} />
        <Snackbar open={feedback.open} autoHideDuration={4000} onClose={() => setFeedback({...feedback, open:false})}><Alert severity={feedback.severity} variant="filled">{feedback.message}</Alert></Snackbar>
    </Box>
  );
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\pages\Login.jsx
------------------------------------------------
import React, { useState } from 'react';
import { supabase } from '../supabase/client';

export default function Login() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) alert(error.message);
    setLoading(false);
  };

  return (
    <div className="flex h-screen items-center justify-center bg-gray-100">
      <form onSubmit={handleLogin} className="p-8 bg-white rounded shadow-md w-96 border border-gray-200">
        <h1 className="text-2xl font-bold mb-6 text-center text-blue-600">Novva R&S 2.0</h1>
        <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input 
              className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
              placeholder="seu@email.com" 
              value={email} 
              onChange={e => setEmail(e.target.value)} 
            />
        </div>
        <div className="mb-6">
            <label className="block text-sm font-medium text-gray-700 mb-1">Senha</label>
            <input 
              className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
              type="password" 
              placeholder="********" 
              value={password} 
              onChange={e => setPassword(e.target.value)} 
            />
        </div>
        <button disabled={loading} className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition">
          {loading ? 'Entrando...' : 'Entrar'}
        </button>
      </form>
    </div>
  );
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\pages\Register.jsx
------------------------------------------------
import React, { useState } from 'react';
import { supabase } from '../supabase/client';
import { Link, useNavigate } from 'react-router-dom';

export default function Register() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [companyId, setCompanyId] = useState('');
  const [loading, setLoading] = useState(false);
  const navigate = useNavigate();

  const handleRegister = async (e) => {
    e.preventDefault();
    setLoading(true);
    
    try {
      let tenantIdToUse = null;

      // 1. ValidaÃ§Ã£o PRÃ‰VIA do CÃ³digo da Empresa
      if (companyId.trim()) {
        const { data: tenant, error: tError } = await supabase
            .from('tenants')
            .select('id, planId')
            .eq('id', companyId.trim())
            .single();
        
        if (tError || !tenant) {
            setLoading(false);
            return alert("CÃ³digo da empresa invÃ¡lido.");
        }

        // Busca o plano usando user_limit
        const { data: plan } = await supabase
            .from('plans')
            .select('user_limit')
            .eq('id', tenant.planId || 'freemium')
            .single();
            
        const limit = plan?.user_limit || 1;
        const isUnlimited = limit === -1;

        // Conta usuÃ¡rios ativos
        const { count } = await supabase
            .from('user_profiles')
            .select('*', { count: 'exact', head: true })
            .eq('tenantId', tenant.id)
            .eq('active', true);

        if (!isUnlimited && count >= limit) {
            setLoading(false);
            return alert(`Esta empresa atingiu o limite de ${limit} usuÃ¡rios do plano. NÃ£o Ã© possÃ­vel entrar.`);
        }
        
        tenantIdToUse = tenant.id;
      }

      // 2. Cria usuÃ¡rio Auth
      const { data: authData, error: authError } = await supabase.auth.signUp({ email, password });
      if (authError) throw authError;

      const user = authData.user;
      if (user) {
        if (!tenantIdToUse) {
           // Cria nova empresa (Plano FREEMIUM padrÃ£o)
           const { data: newTenant } = await supabase
             .from('tenants')
             .insert({ "companyName": "Minha Nova Empresa", "planId": "freemium" })
             .select()
             .single();
           tenantIdToUse = newTenant?.id;
        }

        // 3. Cria Perfil
        if (tenantIdToUse) {
           await supabase.from('user_profiles').upsert({
             id: user.id,
             name: email.split('@')[0],
             "tenantId": tenantIdToUse,
             role: companyId.trim() ? 'user' : 'admin',
             active: true
           });
        }
      }

      alert("Cadastro realizado!");
      navigate('/');

    } catch (error) {
      alert("Erro: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="flex h-screen items-center justify-center bg-gray-100">
      <form onSubmit={handleRegister} className="p-8 bg-white rounded shadow-md w-96 border border-gray-200">
        <h1 className="text-2xl font-bold mb-2 text-center text-green-600">Criar Conta</h1>
        <p className="text-center text-gray-500 text-sm mb-6">Novva R&S 2.0</p>
        
        <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
            <input 
              className="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-green-500" 
              placeholder="seu@email.com" 
              value={email} 
              onChange={e => setEmail(e.target.value)}
              required 
            />
        </div>
        <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-1">Senha *</label>
            <input 
              className="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-green-500" 
              type="password" 
              placeholder="Min. 6 caracteres" 
              value={password} 
              onChange={e => setPassword(e.target.value)}
              required 
            />
        </div>
        
        <div className="mb-6 pt-4 border-t">
            <label className="block text-sm font-bold text-gray-700 mb-1">CÃ³digo de Convite</label>
            <input 
              className="w-full border p-2 rounded outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50" 
              placeholder="Cole o ID da empresa (Opcional)" 
              value={companyId} 
              onChange={e => setCompanyId(e.target.value)}
            />
        </div>
        
        <button disabled={loading} className="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700 transition font-medium">
          {loading ? 'Validando...' : 'Cadastrar'}
        </button>
        <div className="mt-4 text-center text-sm">
          <Link to="/login" className="text-blue-600 hover:underline">Voltar para Login</Link>
        </div>
      </form>
    </div>
  );
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\pages\Settings.jsx
------------------------------------------------
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { supabase } from '../supabase/client';
import { Building, Users, ArrowLeft, Shield, Plus, Trash2, Mail, Lock, AlertCircle } from 'lucide-react';

export default function Settings() {
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState('company');
  const [loading, setLoading] = useState(true);
  
  const [tenant, setTenant] = useState(null);
  const [team, setTeam] = useState([]);
  const [currentUserProfile, setCurrentUserProfile] = useState(null);

  // Estados para Novo UsuÃ¡rio
  const [newUser, setNewUser] = useState({ name: '', email: '', password: '', role: 'recruiter', isAdmin: false });
  const [isAddingUser, setIsAddingUser] = useState(false);

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    setLoading(true);
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return navigate('/login');

      // 1. Pega perfil do usuÃ¡rio logado diretamente
      const { data: profile } = await supabase.from('user_profiles').select('*').eq('id', session.user.id).single();
      setCurrentUserProfile(profile);

      if (profile?.tenantId) {
        // 2. Busca EMPRESA diretamente (Leitura)
        const { data: tenantData } = await supabase
            .from('tenants')
            .select('*')
            .eq('id', profile.tenantId)
            .single();
        setTenant(tenantData);

        // 3. Busca EQUIPE diretamente (Leitura)
        const { data: teamData } = await supabase
            .from('user_profiles')
            .select('*')
            .eq('tenantId', profile.tenantId);
        setTeam(teamData || []);
      }
    } catch (error) {
      console.error("Erro ao carregar dados:", error);
    } finally {
      setLoading(false);
    }
  };

  const handleAddUser = async (e) => {
    e.preventDefault();
    if (!newUser.name || !newUser.email || !newUser.password) return alert("Preencha todos os campos.");

    const { data: { session } } = await supabase.auth.getSession();
    
    // Tenta usar a API Serverless (ProduÃ§Ã£o)
    try {
      const res = await fetch('/api/admin', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            Authorization: `Bearer ${session.access_token}`
        },
        body: JSON.stringify({
            action: 'createUser',
            tenantId: tenant.id,
            ...newUser
        })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Erro ao conectar na API.");

      alert("UsuÃ¡rio adicionado com sucesso!");
      setIsAddingUser(false);
      setNewUser({ name: '', email: '', password: '', role: 'recruiter', isAdmin: false });
      fetchData();
      
    } catch (err) {
      console.error(err);
      alert("Erro ao criar usuÃ¡rio: " + err.message + "\n\nNota: Em localhost, a criaÃ§Ã£o de usuÃ¡rios depende da Vercel Functions rodando. Se estiver testando localmente, suba para a Vercel.");
    }
  };

  const handleDeleteUser = async (userId) => {
    if (!confirm("Tem certeza? O acesso deste usuÃ¡rio serÃ¡ revogado imediatamente.")) return;
    const { data: { session } } = await supabase.auth.getSession();
    
    try {
        const res = await fetch('/api/admin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${session.access_token}` },
            body: JSON.stringify({ action: 'deleteUser', userId })
        });

        if (res.ok) {
            alert("UsuÃ¡rio removido.");
            fetchData();
        } else {
            throw new Error("Falha na API");
        }
    } catch (e) {
        alert("Erro: " + e.message);
    }
  };

  if (loading) return <div className="p-10 text-center text-gray-500">Carregando configuraÃ§Ãµes...</div>;

  return (
    <div className="p-8 max-w-5xl mx-auto font-sans">
      <button onClick={() => navigate('/')} className="flex items-center text-gray-500 mb-6 hover:text-blue-600 transition-colors">
        <ArrowLeft className="mr-2" size={20}/> Voltar ao Dashboard
      </button>

      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold text-gray-800">ConfiguraÃ§Ãµes</h1>
        {currentUserProfile?.is_admin_system && (
            <button onClick={() => navigate('/admin/super')} className="text-xs bg-slate-800 text-white px-3 py-1 rounded hover:bg-slate-700 transition shadow-sm">
                Acessar Painel Novva (Super Admin)
            </button>
        )}
      </div>

      <div className="flex gap-6 border-b mb-6">
        <button onClick={() => setActiveTab('company')} className={`pb-3 px-2 border-b-2 flex items-center gap-2 font-medium transition-colors ${activeTab === 'company' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
          <Building size={18}/> Minha Empresa
        </button>
        <button onClick={() => setActiveTab('team')} className={`pb-3 px-2 border-b-2 flex items-center gap-2 font-medium transition-colors ${activeTab === 'team' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
          <Users size={18}/> GestÃ£o de Equipe
        </button>
      </div>

      {/* ABA 1: EMPRESA (LEITURA) */}
      {activeTab === 'company' && tenant && (
        <div className="bg-white p-6 rounded-lg shadow-sm border max-w-2xl animate-in fade-in slide-in-from-left-2">
            <div className="mb-6">
                <label className="block text-sm font-medium text-gray-500 mb-1">RazÃ£o Social</label>
                <div className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                    {tenant.companyName} <Lock size={18} className="text-gray-400" title="Campo gerenciado pela Novva"/>
                </div>
                <div className="text-sm text-gray-400 font-mono mt-1">ID: {tenant.id}</div>
            </div>
            
            <div className="bg-slate-50 p-5 rounded-lg border border-slate-200">
                <div className="flex items-start gap-4">
                    <Shield className="text-slate-600 mt-1 shrink-0" size={24} />
                    <div>
                        <h3 className="font-bold text-slate-800 text-lg">Plano de Assinatura</h3>
                        <p className="text-sm text-slate-600 mt-2 leading-relaxed">
                            Seu plano atual Ã© gerenciado pela equipe da <strong>Novva Desenvolvimento</strong>.
                            Para upgrades, downgrades ou alteraÃ§Ãµes cadastrais (CNPJ), entre em contato com nosso suporte.
                        </p>
                        <div className="mt-4 flex gap-2">
                            <span className="text-xs font-semibold bg-green-100 text-green-700 px-3 py-1 rounded-full border border-green-200">
                                Status: Ativo
                            </span>
                            <span className="text-xs font-semibold bg-slate-200 text-slate-700 px-3 py-1 rounded-full border border-slate-300">
                                Plano ID: {tenant.planId || 'Standard'}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      )}

      {/* ABA 2: EQUIPE (CRUD) */}
      {activeTab === 'team' && (
        <div className="animate-in fade-in slide-in-from-right-2">
            <div className="flex justify-between items-center mb-4">
                <div>
                    <h2 className="text-lg font-semibold text-gray-800">Membros da Equipe</h2>
                    <p className="text-sm text-gray-500">Gerencie quem tem acesso aos dados da {tenant?.companyName}.</p>
                </div>
                {!isAddingUser && (
                    <button onClick={() => setIsAddingUser(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-700 shadow-sm transition">
                        <Plus size={18}/> Adicionar UsuÃ¡rio
                    </button>
                )}
            </div>

            {isAddingUser && (
                <div className="bg-blue-50 p-6 rounded-xl border border-blue-100 mb-6 shadow-sm">
                    <h3 className="font-bold mb-4 text-blue-900 flex items-center gap-2"><Plus size={16}/> Cadastrar Novo Membro</h3>
                    <form onSubmit={handleAddUser}>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                            <div>
                                <label className="block text-xs font-bold text-blue-700 mb-1">Nome Completo</label>
                                <input required className="w-full border border-blue-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                                    value={newUser.name} onChange={e => setNewUser({...newUser, name: e.target.value})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-blue-700 mb-1">E-mail Corporativo</label>
                                <input required type="email" className="w-full border border-blue-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                                    value={newUser.email} onChange={e => setNewUser({...newUser, email: e.target.value})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-blue-700 mb-1">Senha Inicial</label>
                                <input required type="password" className="w-full border border-blue-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                                    value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} />
                            </div>
                            <div className="flex items-center h-full pt-6">
                                <label className="flex items-center gap-3 cursor-pointer bg-white px-4 py-2 rounded-lg border border-blue-200 w-full hover:bg-blue-50 transition">
                                    <input type="checkbox" className="w-5 h-5 text-blue-600 rounded" checked={newUser.isAdmin} onChange={e => setNewUser({...newUser, isAdmin: e.target.checked})} />
                                    <span className="text-sm font-medium text-blue-900">Dar acesso de Administrador?</span>
                                </label>
                            </div>
                        </div>
                        <div className="flex gap-3 pt-2">
                            <button type="submit" className="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-blue-700 shadow transition">Salvar UsuÃ¡rio</button>
                            <button type="button" onClick={() => setIsAddingUser(false)} className="bg-white text-gray-700 px-6 py-2.5 rounded-lg border border-gray-300 hover:bg-gray-50 font-medium transition">Cancelar</button>
                        </div>
                    </form>
                </div>
            )}

            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <table className="w-full text-left">
                    <thead className="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th className="p-5 font-semibold text-slate-600 text-sm uppercase tracking-wide">Nome</th>
                            <th className="p-5 font-semibold text-slate-600 text-sm uppercase tracking-wide">Email</th>
                            <th className="p-5 font-semibold text-slate-600 text-sm uppercase tracking-wide">FunÃ§Ã£o</th>
                            <th className="p-5 font-semibold text-slate-600 text-sm uppercase tracking-wide text-right">AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                        {team.map(user => (
                            <tr key={user.id} className="hover:bg-slate-50 transition-colors">
                                <td className="p-5 font-medium text-slate-900">{user.name || 'Sem nome'}</td>
                                <td className="p-5 text-slate-600 flex items-center gap-2"><Mail size={16} className="text-slate-400"/> {user.email}</td>
                                <td className="p-5">
                                    <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide border ${user.isAdmin ? 'bg-purple-50 text-purple-700 border-purple-200' : 'bg-slate-100 text-slate-600 border-slate-200'}`}>
                                        {user.isAdmin ? 'Admin' : 'Membro'}
                                    </span>
                                </td>
                                <td className="p-5 text-right">
                                    {user.id !== currentUserProfile?.id ? (
                                        <button onClick={() => handleDeleteUser(user.id)} className="text-slate-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition-all" title="Remover UsuÃ¡rio">
                                            <Trash2 size={18} />
                                        </button>
                                    ) : (
                                        <span className="text-xs text-slate-400 italic pr-2">VocÃª</span>
                                    )}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                {team.length === 0 && (
                    <div className="p-10 text-center flex flex-col items-center">
                        <AlertCircle className="text-slate-300 mb-2" size={48} />
                        <p className="text-slate-500 font-medium">Nenhum membro encontrado.</p>
                        <p className="text-sm text-slate-400">Adicione usuÃ¡rios para colaborar nesta empresa.</p>
                    </div>
                )}
            </div>
        </div>
      )}
    </div>
  );
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\pages\SuperAdminDashboard.jsx
------------------------------------------------
import React, { useState, useEffect } from 'react';
import { supabase } from '../supabase/client';
import { useNavigate } from 'react-router-dom';
import { Building, Edit, Trash2, Plus, X, Save, UserCheck, Key, Users, Check } from 'lucide-react';

export default function SuperAdminDashboard() {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [tenants, setTenants] = useState([]);
  const [plans, setPlans] = useState([]);
  
  // Modais
  const [isModalOpen, setIsModalOpen] = useState(false); // Modal Empresa
  const [isUsersModalOpen, setIsUsersModalOpen] = useState(false); // Modal UsuÃ¡rios
  
  const [editingTenant, setEditingTenant] = useState(null); 
  const [selectedTenantUsers, setSelectedTenantUsers] = useState([]); // Lista de usuÃ¡rios do tenant selecionado
  const [currentTenantName, setCurrentTenantName] = useState('');
  
  // Estado para EdiÃ§Ã£o de UsuÃ¡rio
  const [editingUser, setEditingUser] = useState(null); // ID do user sendo editado
  const [userForm, setUserForm] = useState({ id: '', name: '', email: '', password: '' });

  // FormulÃ¡rio Empresa
  const [formData, setFormData] = useState({ 
      companyName: '', planId: 'freemium', cnpj: '',
      adminName: '', adminEmail: '', adminPassword: ''
  });

  useEffect(() => { checkPermission(); }, []);

  const checkPermission = async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return navigate('/login');
    
    const { data: profile } = await supabase
        .from('user_profiles')
        .select('is_admin_system')
        .eq('id', session.user.id)
        .single();

    if (!profile?.is_admin_system) {
        alert("Acesso restrito."); 
        return navigate('/');
    }
    fetchData(session.access_token);
  };

  const fetchData = async (token) => {
    setLoading(true);
    try {
      const res = await fetch('/api/admin?action=getTenantsAndPlans', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (res.ok) {
        setTenants(data.tenants || []);
        setPlans(data.plans || []);
      }
    } catch (e) { console.error(e); } finally { setLoading(false); }
  };

  // --- GESTÃƒO DE EMPRESAS ---

  const handleSubmitTenant = async (e) => {
    e.preventDefault();
    const { data: { session } } = await supabase.auth.getSession();
    const action = editingTenant ? 'updateTenant' : 'provisionTenant';
    const payload = editingTenant ? { id: editingTenant.id, companyName: formData.companyName, planId: formData.planId, cnpj: formData.cnpj } : formData;

    try {
        const res = await fetch('/api/admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${session.access_token}` },
          body: JSON.stringify({ action, ...payload })
        });
        const data = await res.json();
        if (res.ok) {
          alert("Sucesso!");
          setIsModalOpen(false);
          setEditingTenant(null);
          resetForm();
          fetchData(session.access_token);
        } else {
          throw new Error(data.error);
        }
    } catch (err) { alert("Erro: " + err.message); }
  };

  const handleDeleteTenant = async (tenantId) => {
      if(!confirm("Tem certeza absoluta? Isso apagarÃ¡ TUDO desta empresa.")) return;
      const { data: { session } } = await supabase.auth.getSession();
      await fetch('/api/admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${session.access_token}` },
          body: JSON.stringify({ action: 'deleteTenant', tenantId })
      });
      fetchData(session.access_token);
  };

  // --- GESTÃƒO DE USUÃRIOS DO CLIENTE ---

  const openUsersModal = async (tenant) => {
      setCurrentTenantName(tenant.companyName);
      const { data: { session } } = await supabase.auth.getSession();
      
      // Busca usuÃ¡rios dessa empresa
      const res = await fetch(`/api/admin?action=getTenantDetails&tenantId=${tenant.id}`, {
          headers: { Authorization: `Bearer ${session.access_token}` }
      });
      const data = await res.json();
      
      if (res.ok) {
          setSelectedTenantUsers(data.users || []);
          setIsUsersModalOpen(true);
          setEditingUser(null);
      } else {
          alert("Erro ao buscar usuÃ¡rios: " + data.error);
      }
  };

  const handleEditUserClick = (user) => {
      setEditingUser(user.id);
      setUserForm({ id: user.id, name: user.name, email: user.email, password: '' });
  };

  const handleSaveUser = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!userForm.name || !userForm.email) return alert("Nome e Email sÃ£o obrigatÃ³rios.");

      try {
          const res = await fetch('/api/admin', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${session.access_token}` },
              body: JSON.stringify({
                  action: 'updateUserAuth',
                  userId: userForm.id,
                  name: userForm.name,
                  email: userForm.email,
                  password: userForm.password || undefined // SÃ³ envia se preenchido
              })
          });

          if (res.ok) {
              alert("UsuÃ¡rio atualizado com sucesso!");
              setEditingUser(null);
              // Recarrega a lista localmente
              setSelectedTenantUsers(prev => prev.map(u => u.id === userForm.id ? { ...u, name: userForm.name, email: userForm.email } : u));
          } else {
              const err = await res.json();
              throw new Error(err.error);
          }
      } catch (e) {
          alert("Erro ao atualizar: " + e.message);
      }
  };

  // --- AUXILIARES ---

  const openEditTenant = (t) => {
      setEditingTenant(t);
      setFormData({ companyName: t.companyName, planId: t.planId, cnpj: t.cnpj || '', adminName: '', adminEmail: '', adminPassword: '' });
      setIsModalOpen(true);
  };

  const openNewTenant = () => {
      setEditingTenant(null);
      resetForm();
      setIsModalOpen(true);
  };

  const resetForm = () => {
      setFormData({ companyName: '', planId: 'freemium', cnpj: '', adminName: '', adminEmail: '', adminPassword: '' });
  };

  if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-100 text-slate-500">Carregando Painel...</div>;

  return (
    <div className="min-h-screen bg-slate-100 p-8 font-sans">
      <div className="max-w-7xl mx-auto">
        <div className="flex justify-between items-center mb-8">
            <div>
                <h1 className="text-3xl font-bold text-slate-800 tracking-tight">Painel Novva</h1>
                <p className="text-slate-500">GestÃ£o e Provisionamento de Clientes (SaaS)</p>
            </div>
            <button onClick={openNewTenant} className="bg-slate-900 text-white px-5 py-2.5 rounded-lg flex gap-2 hover:bg-slate-800 shadow-lg items-center font-medium">
                <Plus size={18}/> Novo Cliente
            </button>
        </div>

        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <table className="w-full text-left">
                <thead className="bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th className="p-5 text-sm uppercase text-slate-500 font-bold">Empresa Cliente</th>
                        <th className="p-5 text-sm uppercase text-slate-500 font-bold">Plano</th>
                        <th className="p-5 text-right text-sm uppercase text-slate-500 font-bold">AÃ§Ãµes</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-slate-100">
                    {tenants.map(t => (
                        <tr key={t.id} className="hover:bg-slate-50">
                            <td className="p-5">
                                <div className="font-bold text-slate-800">{t.companyName}</div>
                                <div className="text-xs text-slate-400 font-mono">{t.cnpj || 'Sem CNPJ'}</div>
                            </td>
                            <td className="p-5">
                                <span className="px-3 py-1 rounded-full text-xs font-bold uppercase border bg-slate-100 text-slate-600 border-slate-200">
                                  {t.plans?.name || t.planId}
                                </span>
                            </td>
                            <td className="p-5 text-right flex justify-end gap-2">
                                <button onClick={() => openUsersModal(t)} className="p-2 text-slate-600 hover:bg-slate-100 rounded-lg" title="Gerenciar UsuÃ¡rios / Senhas">
                                    <Users size={18} />
                                </button>
                                <button onClick={() => openEditTenant(t)} className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg" title="Editar Empresa">
                                    <Edit size={18} />
                                </button>
                                <button onClick={() => handleDeleteTenant(t.id)} className="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Excluir">
                                    <Trash2 size={18} />
                                </button>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
      </div>

      {/* MODAL 1: EMPRESA (CriaÃ§Ã£o/EdiÃ§Ã£o) */}
      {isModalOpen && (
        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
                <div className="flex justify-between items-center p-6 border-b">
                    <h3 className="text-xl font-bold">{editingTenant ? 'Editar Empresa' : 'Provisionar Novo Cliente'}</h3>
                    <button onClick={() => setIsModalOpen(false)}><X/></button>
                </div>
                <form onSubmit={handleSubmitTenant} className="p-6 space-y-4 max-h-[80vh] overflow-y-auto">
                    {/* Campos de Empresa ... */}
                    <div className="space-y-3">
                        <label className="block text-xs font-bold uppercase">RazÃ£o Social</label>
                        <input required className="w-full border p-2.5 rounded-lg" value={formData.companyName} onChange={e => setFormData({...formData, companyName: e.target.value})} />
                        
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="block text-xs font-bold uppercase">CNPJ</label>
                                <input className="w-full border p-2.5 rounded-lg" value={formData.cnpj} onChange={e => setFormData({...formData, cnpj: e.target.value})} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold uppercase">Plano</label>
                                <select className="w-full border p-2.5 rounded-lg bg-white" value={formData.planId} onChange={e => setFormData({...formData, planId: e.target.value})}>
                                    {plans.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>

                    {!editingTenant && (
                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 space-y-3">
                            <h4 className="font-bold text-sm text-blue-800 flex items-center gap-2"><UserCheck size={16}/> Admin Inicial</h4>
                            <input required placeholder="Nome ResponsÃ¡vel" className="w-full border p-2 rounded" value={formData.adminName} onChange={e => setFormData({...formData, adminName: e.target.value})} />
                            <input required type="email" placeholder="Email Login" className="w-full border p-2 rounded" value={formData.adminEmail} onChange={e => setFormData({...formData, adminEmail: e.target.value})} />
                            <input required type="text" placeholder="Senha TemporÃ¡ria" className="w-full border p-2 rounded" value={formData.adminPassword} onChange={e => setFormData({...formData, adminPassword: e.target.value})} />
                        </div>
                    )}

                    <button type="submit" className="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-800 flex justify-center gap-2">
                        <Save size={18}/> Salvar
                    </button>
                </form>
            </div>
        </div>
      )}

      {/* MODAL 2: GESTÃƒO DE USUÃRIOS (Reset de Senha/CorreÃ§Ã£o) */}
      {isUsersModalOpen && (
          <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
                  <div className="p-6 border-b bg-slate-50 flex justify-between items-center">
                      <div>
                          <h3 className="text-lg font-bold text-slate-800">UsuÃ¡rios: {currentTenantName}</h3>
                          <p className="text-xs text-slate-500">Gerencie acessos e resete senhas se necessÃ¡rio.</p>
                      </div>
                      <button onClick={() => setIsUsersModalOpen(false)}><X className="text-slate-400 hover:text-slate-600"/></button>
                  </div>
                  
                  <div className="p-0 overflow-y-auto flex-1">
                      <table className="w-full text-left border-collapse">
                          <thead className="bg-slate-100 text-xs uppercase text-slate-500 font-semibold">
                              <tr>
                                  <th className="p-4 border-b">Nome</th>
                                  <th className="p-4 border-b">Email (Login)</th>
                                  <th className="p-4 border-b">Cargo</th>
                                  <th className="p-4 border-b text-right">AÃ§Ã£o</th>
                              </tr>
                          </thead>
                          <tbody>
                              {selectedTenantUsers.map(u => (
                                  <tr key={u.id} className={`border-b hover:bg-slate-50 ${editingUser === u.id ? 'bg-blue-50' : ''}`}>
                                      {editingUser === u.id ? (
                                          // MODO EDIÃ‡ÃƒO
                                          <>
                                              <td className="p-3">
                                                  <input className="w-full border border-blue-300 p-1.5 rounded text-sm" 
                                                      value={userForm.name} onChange={e => setUserForm({...userForm, name: e.target.value})} />
                                              </td>
                                              <td className="p-3">
                                                  <input className="w-full border border-blue-300 p-1.5 rounded text-sm" 
                                                      value={userForm.email} onChange={e => setUserForm({...userForm, email: e.target.value})} />
                                              </td>
                                              <td className="p-3 text-sm text-slate-500">{u.role}</td>
                                              <td className="p-3 text-right">
                                                  <div className="flex flex-col gap-2 items-end">
                                                      <input type="text" placeholder="Nova Senha (Opcional)" className="w-32 border border-blue-300 p-1.5 rounded text-xs" 
                                                          value={userForm.password} onChange={e => setUserForm({...userForm, password: e.target.value})} />
                                                      <div className="flex gap-2">
                                                          <button onClick={handleSaveUser} className="bg-blue-600 text-white p-1.5 rounded hover:bg-blue-700" title="Salvar"><Check size={16}/></button>
                                                          <button onClick={() => setEditingUser(null)} className="bg-white border text-slate-500 p-1.5 rounded hover:bg-slate-100" title="Cancelar"><X size={16}/></button>
                                                      </div>
                                                  </div>
                                              </td>
                                          </>
                                      ) : (
                                          // MODO LEITURA
                                          <>
                                              <td className="p-4 font-medium text-slate-700">{u.name}</td>
                                              <td className="p-4 text-slate-600 text-sm">{u.email}</td>
                                              <td className="p-4">
                                                  <span className={`px-2 py-1 text-xs rounded-full border ${u.role === 'admin' ? 'bg-purple-50 text-purple-700 border-purple-200' : 'bg-slate-100 text-slate-600'}`}>
                                                      {u.role}
                                                  </span>
                                              </td>
                                              <td className="p-4 text-right">
                                                  <button onClick={() => handleEditUserClick(u)} className="text-blue-600 hover:bg-blue-50 p-2 rounded transition flex items-center gap-1 ml-auto text-sm font-medium">
                                                      <Key size={14}/> Editar Acesso
                                                  </button>
                                              </td>
                                          </>
                                      )}
                                  </tr>
                              ))}
                          </tbody>
                      </table>
                      {selectedTenantUsers.length === 0 && <div className="p-8 text-center text-slate-400">Nenhum usuÃ¡rio encontrado nesta empresa.</div>}
                  </div>
              </div>
          </div>
      )}
    </div>
  );
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\supabase\client.js
------------------------------------------------
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Chaves do Supabase ausentes no arquivo .env');
}

export const supabase = createClient(supabaseUrl, supabaseAnonKey);


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\utils\evaluationLogic.js
------------------------------------------------
// src/utils/evaluationLogic.js

export const calculatePillarScore = (sectionName, criteriaList, answers, ratingScale) => {
    // Se nÃ£o houver critÃ©rios ou respostas, retorna null (neutro)
    if (!criteriaList || !Array.isArray(criteriaList) || criteriaList.length === 0) return null;
    if (!answers) return null;
    
    let totalScore = 0;
    let totalWeightAnswered = 0;
    let hasAnswers = false;

    criteriaList.forEach(criterion => {
        // Tenta achar a resposta (suporta estrutura v2 aninhada ou v1 plana)
        const noteId = answers?.[sectionName]?.[criterion.name] || answers?.[criterion.name];
        
        // Ignora 'NA', null ou undefined
        if (noteId && noteId !== 'NA') {
            // CORREÃ‡ÃƒO CRÃTICA: Converte ambos para String para garantir o match (1 vs "1")
            const noteObj = ratingScale.find(n => String(n.id) === String(noteId));
            
            if (noteObj) {
                hasAnswers = true;
                const weight = Number(criterion.weight) || 0;
                
                // CÃ¡lculo: Valor da Nota * Peso
                totalScore += (Number(noteObj.valor) * weight);
                totalWeightAnswered += weight;
            }
        }
    });

    if (!hasAnswers || totalWeightAnswered === 0) return null;

    // Normaliza para escala 0-10
    return (totalScore / totalWeightAnswered);
};

export const processEvaluation = (evaluationObj, parameters) => {
    if (!evaluationObj || !parameters) {
        return { triagem: 0, cultura: 0, tecnico: 0, total: 0 };
    }

    const answers = evaluationObj.scores || evaluationObj; 
    const ratingScale = parameters.notas || [];
    
    const pTriagem = parameters.triagem || [];
    const pCultura = parameters.cultura || [];
    const pTecnico = parameters.tecnico || parameters['tÃ©cnico'] || parameters['tÃƒÂ©cnico'] || [];

    // Calcula parciais
    const triagem = calculatePillarScore('triagem', pTriagem, answers, ratingScale);
    const cultura = calculatePillarScore('cultura', pCultura, answers, ratingScale);
    const tecnico = calculatePillarScore('tecnico', pTecnico, answers, ratingScale);

    // MÃ©dia AritmÃ©tica Simples dos pilares respondidos
    let sum = 0;
    let count = 0;

    if (triagem !== null) { sum += triagem; count++; }
    if (cultura !== null) { sum += cultura; count++; }
    if (tecnico !== null) { sum += tecnico; count++; }

    // Se count for 0 (nenhum pilar avaliado), nota Ã© 0.
    const total = count > 0 ? (sum / count) : 0;

    return {
        triagem: triagem !== null ? Number(triagem) : 0,
        cultura: cultura !== null ? Number(cultura) : 0,
        tecnico: tecnico !== null ? Number(tecnico) : 0,
        total: Number(total)
    };
};


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\utils\formatters.js
------------------------------------------------
import { format, parseISO } from 'date-fns';

export const formatStatus = (status) => {
  const statusMap = {
    active: 'Ativa',
    inactive: 'Inativa',
    filled: 'Preenchida',
  };
  return statusMap[status] || status;
};

export const formatPhone = (phone) => {
  if (!phone) return 'NÃ£o informado';
  const cleaned = phone.replace(/\D/g, '');
  if (cleaned.length === 11) {
    return `(${cleaned.substring(0, 2)}) ${cleaned.substring(2, 7)}-${cleaned.substring(7)}`;
  }
  if (cleaned.length === 10) {
    return `(${cleaned.substring(0, 2)}) ${cleaned.substring(2, 6)}-${cleaned.substring(6)}`;
  }
  return phone;
};

export const formatUrl = (url) => {
  if (!url) return '#';
  if (url.startsWith('http://') || url.startsWith('https://')) { return url; }
  return `//${url}`;
};

export const formatDate = (dateStr) => {
    if (!dateStr) return 'NÃ£o informado';
    try {
        return format(parseISO(dateStr), 'dd/MM/yyyy');
    } catch (error) {
        console.error("Erro ao formatar data:", dateStr, error);
        return 'Data invÃ¡lida';
    }
};


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\App.jsx
------------------------------------------------
import React, { useState, useEffect } from 'react';
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { supabase } from './supabase/client';
import Login from './pages/Login';
import Register from './pages/Register';
import Dashboard from './pages/Dashboard';
import JobDetails from './pages/JobDetails';
import ApplicationDetails from './pages/ApplicationDetails';
import Settings from './pages/Settings';
import ApplyJob from './pages/ApplyJob'; // NOVO IMPORT
import SuperAdminDashboard from './pages/SuperAdminDashboard';

export default function App() {
  const [session, setSession] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      setLoading(false);
    });

    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
      setSession(session);
    });

    return () => subscription.unsubscribe();
  }, []);

  if (loading) return <div className="p-10 text-center">Carregando Sistema...</div>;

  return (
    <BrowserRouter>
      <Routes>
        {/* ROTAS PÃšBLICAS (Candidatos) */}
        <Route path="/apply/:jobId" element={<ApplyJob />} />

        {/* ROTAS DE AUTENTICAÃ‡ÃƒO */}
        <Route path="/login" element={!session ? <Login /> : <Navigate to="/" />} />
        <Route path="/register" element={!session ? <Register /> : <Navigate to="/" />} />
        
        {/* ROTAS PROTEGIDAS (Admin/Recrutador) */}
        <Route path="/" element={session ? <Dashboard /> : <Navigate to="/login" />} />
        <Route path="/jobs/:jobId" element={session ? <JobDetails /> : <Navigate to="/login" />} />
        <Route path="/applications/:appId" element={session ? <ApplicationDetails /> : <Navigate to="/login" />} />
        <Route path="/settings" element={session ? <Settings /> : <Navigate to="/login" />} />
        <Route path="/admin/super" element={session ? <SuperAdminDashboard /> : <Navigate to="/login" />} />
      </Routes>
    </BrowserRouter>
  );
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\index.css
------------------------------------------------
@tailwind base;
@tailwind components;
@tailwind utilities;

body {
  @apply bg-gray-50 text-gray-900;
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\src\main.jsx
------------------------------------------------
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.jsx'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\api\_utils\calculator.js
------------------------------------------------
// api/_utils/calculator.js
export function calculateWeightedScore(userScores, jobParameters) {
    if (!userScores || !jobParameters) return 0;

    // Converte lista de notas do banco em Mapa para acesso rÃ¡pido
    // Ex: { "uuid-nota-1": 0, "uuid-nota-2": 50, "uuid-nota-3": 100 }
    const notesMap = new Map((jobParameters.notas || []).map(n => [n.id, Number(n.valor)]));

    const sections = ['triagem', 'cultura', 'tecnico']; // SeÃ§Ãµes padrÃ£o
    let totalScore = 0;
    let totalMaxPossible = 0;

    sections.forEach(section => {
        const criteriaList = jobParameters[section] || []; // Ex: [{name: 'React', weight: 2}]
        const userSectionScores = userScores[section] || {}; // Ex: { 'React': 'uuid-nota-3' }

        criteriaList.forEach(criterion => {
            const noteId = userSectionScores[criterion.name];
            
            // LÃ“GICA DE N/A: Se a notaId for 'NA' ou nÃ£o existir, ignoramos este critÃ©rio
            if (!noteId || noteId === 'NA') return;

            const noteValue = notesMap.get(noteId); // Valor (0, 50, 100)
            const weight = Number(criterion.weight) || 1; // Peso (1x, 2x...)

            if (noteValue !== undefined) {
                totalScore += (noteValue * weight);
                totalMaxPossible += (100 * weight); // O mÃ¡ximo seria tirar 100 nesse critÃ©rio
            }
        });
    });

    // Evita divisÃ£o por zero se tudo for N/A
    if (totalMaxPossible === 0) return 0;

    // Normaliza para 0-100 com 1 casa decimal
    return Number(((totalScore / totalMaxPossible) * 100).toFixed(1));
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\api\admin.js
------------------------------------------------
import { createClient } from '@supabase/supabase-js';

// FunÃ§Ã£o auxiliar de seguranÃ§a e validaÃ§Ã£o
async function validateAdmin(request) {
  const supabaseAdmin = createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_KEY
  );
  
  const authHeader = request.headers['authorization'];
  if (!authHeader) throw new Error('Token de autorizaÃ§Ã£o ausente.');
  
  const token = authHeader.replace('Bearer ', '');
  const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
  
  if (userError || !user) throw new Error('Token invÃ¡lido ou expirado.');

  // Busca o perfil do usuÃ¡rio para checar permissÃµes
  const { data: userData, error: profileError } = await supabaseAdmin
    .from('user_profiles')
    .select('id, is_admin_system, tenantId, role') 
    .eq('id', user.id)
    .single();

  if (profileError || !userData) {
      if (user.email === 'eider@novvaempresa.com.br') { 
          return { supabaseAdmin, requesterProfile: { is_admin_system: true, id: user.id }, requesterId: user.id };
      }
      throw new Error('Perfil de usuÃ¡rio nÃ£o encontrado.');
  }
  
  return { supabaseAdmin, requesterProfile: userData, requesterId: user.id };
}

export default async function handler(request, response) {
  try {
    const { supabaseAdmin, requesterProfile } = await validateAdmin(request);
    
    const action = request.method === 'GET' ? request.query.action : request.body.action;
    const isSuperAdmin = requesterProfile.is_admin_system === true;

    switch (action) {
      // ======================================================================
      // 1. GESTÃƒO DE EMPRESAS E DASHBOARD
      // ======================================================================

      case 'getTenantsAndPlans': {
        if (!isSuperAdmin) return response.status(403).json({ error: 'Acesso negado.' });
        
        const { data: tenants, error: tErr } = await supabaseAdmin
          .from('tenants')
          .select(`id, companyName, planId, cnpj, plans ( name )`)
          .order('created_at', { ascending: false });
        if (tErr) throw tErr;

        const { data: plans, error: pErr } = await supabaseAdmin
          .from('plans')
          .select('*')
          .order('price', { ascending: true });
        if (pErr) throw pErr;

        return response.status(200).json({ tenants, plans });
      }

      case 'provisionTenant': {
        if (request.method !== 'POST') return response.status(405).json({ error: 'Use POST.' });
        if (!isSuperAdmin) return response.status(403).json({ error: 'Apenas Super Admin.' });

        const { companyName, planId, cnpj, adminName, adminEmail, adminPassword } = request.body;
        if (!companyName || !adminEmail || !adminPassword) return response.status(400).json({ error: 'Dados incompletos.' });

        // A. Criar Tenant
        const { data: newTenant, error: tErr } = await supabaseAdmin
          .from('tenants')
          .insert({ companyName, planId, cnpj: cnpj || null })
          .select().single();
        if (tErr) throw tErr;

        // B. Criar Auth User
        const { data: authUser, error: aErr } = await supabaseAdmin.auth.admin.createUser({
            email: adminEmail,
            password: adminPassword,
            email_confirm: true,
            user_metadata: { name: adminName }
        });

        if (aErr) {
            await supabaseAdmin.from('tenants').delete().eq('id', newTenant.id);
            throw aErr;
        }

        // C. Criar Perfil
        const { error: pErr } = await supabaseAdmin.from('user_profiles').insert({
            id: authUser.user.id,
            name: adminName,
            email: adminEmail,
            role: 'admin',
            tenantId: newTenant.id,
            is_admin_system: false,
            active: true
        });
        if (pErr) throw pErr;

        return response.status(201).json({ message: 'Cliente provisionado com sucesso!', tenant: newTenant });
      }

      case 'updateTenant': {
        if (!isSuperAdmin) return response.status(403).json({ error: 'Acesso negado.' });
        const { id, companyName, planId, cnpj } = request.body;
        
        const { data, error } = await supabaseAdmin
            .from('tenants')
            .update({ companyName, planId, cnpj })
            .eq('id', id)
            .select().single();
        if (error) throw error;
        
        return response.status(200).json({ message: 'Atualizado.' });
      }

      case 'deleteTenant': {
        if (!isSuperAdmin) return response.status(403).json({ error: 'Acesso negado.' });
        const { tenantId } = request.body;
        
        await supabaseAdmin.from('user_profiles').delete().eq('tenantId', tenantId);
        const { error } = await supabaseAdmin.from('tenants').delete().eq('id', tenantId);
        if (error) throw error;
        
        return response.status(200).json({ message: 'Empresa excluÃ­da.' });
      }

      // ======================================================================
      // 2. GESTÃƒO DE PLANOS
      // ======================================================================

      case 'createPlan': {
        if (!isSuperAdmin) return response.status(403).json({ error: 'Apenas Super Admin.' });
        const { planData } = request.body;
        const { data: newPlan, error } = await supabaseAdmin.from('plans').insert(planData).select().single();
        if (error) throw error;
        return response.status(201).json({ message: 'Plano criado!', newPlan });
      }

      case 'updatePlan': {
        if (!isSuperAdmin) return response.status(403).json({ error: 'Apenas Super Admin.' });
        const { planId, planData } = request.body;
        const { data: updatedPlan, error } = await supabaseAdmin.from('plans').update(planData).eq('id', planId).select().single();
        if (error) throw error;
        return response.status(200).json({ message: 'Plano atualizado!', updatedPlan });
      }

      case 'deletePlan': {
        if (!isSuperAdmin) return response.status(403).json({ error: 'Apenas Super Admin.' });
        const { planId } = request.body;
        const { count, error: checkError } = await supabaseAdmin.from('tenants').select('*', { count: 'exact', head: true }).eq('planId', planId);
        if (checkError) throw checkError;
        if (count > 0) return response.status(400).json({ error: `Plano em uso por ${count} empresa(s).` });
        const { error } = await supabaseAdmin.from('plans').delete().eq('id', planId);
        if (error) throw error;
        return response.status(200).json({ message: 'Plano excluÃ­do!' });
      }

      // ======================================================================
      // 3. GESTÃƒO DE USUÃRIOS E EQUIPE
      // ======================================================================

      case 'getTenantDetails': {
        const { tenantId } = request.query;
        if (!tenantId) return response.status(400).json({ error: 'ID obrigatÃ³rio.' });
        
        if (!isSuperAdmin && requesterProfile.tenantId !== tenantId) {
            return response.status(403).json({ error: 'NÃ£o autorizado.' });
        }

        const { data: tenant } = await supabaseAdmin.from('tenants').select('id, companyName, planId').eq('id', tenantId).single();
        const { data: users } = await supabaseAdmin.from('user_profiles').select('id, name, email, role, is_admin_system').eq('tenantId', tenantId);
        
        return response.status(200).json({ tenant, users });
      }

      // --- NOVO: GESTÃƒO COMPLETA DE USUÃRIO (Update Auth + Profile) ---
      case 'updateUserAuth': {
        if (request.method !== 'POST') return response.status(405).json({ error: 'Use POST.' });
        if (!isSuperAdmin) return response.status(403).json({ error: 'Apenas Super Admin pode alterar credenciais de terceiros.' });

        const { userId, email, password, name } = request.body;
        if (!userId) return response.status(400).json({ error: 'ID do usuÃ¡rio necessÃ¡rio.' });

        // 1. Atualiza Auth (Login, Senha, Metadados)
        const updateData = { email_confirm: true };
        if (email) updateData.email = email;
        if (password) updateData.password = password;
        if (name) updateData.user_metadata = { name };

        const { error: authError } = await supabaseAdmin.auth.admin.updateUserById(userId, updateData);
        if (authError) throw authError;

        // 2. Atualiza Profile (Dados visuais)
        const profileUpdate = {};
        if (email) profileUpdate.email = email;
        if (name) profileUpdate.name = name;

        if (Object.keys(profileUpdate).length > 0) {
            const { error: profileError } = await supabaseAdmin
                .from('user_profiles')
                .update(profileUpdate)
                .eq('id', userId);
            if (profileError) throw profileError;
        }

        return response.status(200).json({ message: 'Dados do usuÃ¡rio atualizados com sucesso!' });
      }
      // ---------------------------------------------------------------

      case 'createUser': {
        const { email, password, name, isAdmin, tenantId } = request.body;
        
        if (!isSuperAdmin && requesterProfile.tenantId !== tenantId) {
            return response.status(403).json({ error: 'NÃ£o autorizado para esta empresa.' });
        }

        const { data: authUser, error: aErr } = await supabaseAdmin.auth.admin.createUser({
            email, password, email_confirm: true, user_metadata: { name }
        });
        if (aErr) throw aErr;

        const userRole = isAdmin ? 'admin' : 'recruiter';

        const { error: pErr } = await supabaseAdmin.from('user_profiles').insert({
            id: authUser.user.id, 
            name, 
            email, 
            role: userRole, 
            tenantId, 
            active: true, 
            is_admin_system: false
        });
        if (pErr) {
            await supabaseAdmin.auth.admin.deleteUser(authUser.user.id);
            throw pErr;
        }

        return response.status(201).json({ message: 'UsuÃ¡rio criado.' });
      }

      case 'deleteUser': {
        const { userId } = request.body;
        
        if (!isSuperAdmin) {
            const { data: target } = await supabaseAdmin.from('user_profiles').select('tenantId').eq('id', userId).single();
            if (!target || target.tenantId !== requesterProfile.tenantId) {
                return response.status(403).json({ error: 'NÃ£o autorizado.' });
            }
        }

        await supabaseAdmin.from('user_profiles').delete().eq('id', userId);
        await supabaseAdmin.auth.admin.deleteUser(userId);
        return response.status(200).json({ message: 'UsuÃ¡rio removido.' });
      }

      default:
        return response.status(400).json({ error: 'AÃ§Ã£o desconhecida.' });
    }

  } catch (error) {
    console.error("API Error:", error);
    return response.status(500).json({ error: error.message || 'Erro interno.' });
  }
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\api\apply.js
------------------------------------------------
// api/apply.js (VERSÃƒO FINAL, COMPLETA E CORRIGIDA)
import { createClient } from '@supabase/supabase-js';
import { formidable } from 'formidable';
import fs from 'fs';
import path from 'path';

export const config = {
  api: {
    bodyParser: false,
  },
};

export default async function handler(request, response) {
  if (request.method !== 'POST') {
    return response.status(405).json({ error: `MÃ©todo ${request.method} nÃ£o permitido.` });
  }

  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    const form = formidable({});
    const [fields, files] = await form.parse(request);
    
    const jobId = fields.jobId ? fields.jobId[0] : null;
    if (!jobId) { return response.status(400).json({ error: 'ID da vaga Ã© obrigatÃ³rio.' }); }

    // --- LÃ“GICA DE LIMITE ROBUSTA ---
    const { data: job, error: jobError } = await supabaseAdmin
      .from('jobs')
      .select('tenantId')
      .eq('id', jobId)
      .single();
    
    if (jobError || !job) { return response.status(404).json({ error: 'Vaga nÃ£o encontrada.' }); }

    const { data: tenant, error: tenantError } = await supabaseAdmin
      .from('tenants')
      .select('planId')
      .eq('id', job.tenantId)
      .single();

    if (tenantError || !tenant) { throw new Error('Empresa (tenant) nÃ£o encontrada para esta vaga.'); }

    const { data: plan, error: planError } = await supabaseAdmin
      .from('plans')
      .select('candidate_limit')
      .eq('id', tenant.planId)
      .single();
    
    if (planError || !plan) {
      throw new Error(`ConfiguraÃ§Ã£o de plano invÃ¡lida. O plano com ID "${tenant.planId}" nÃ£o foi encontrado na tabela 'plans'.`);
    }
    
    if (plan.candidate_limit !== -1) {
      const { count, error: countError } = await supabaseAdmin
        .from('applications')
        .select('*', { count: 'exact', head: true })
        .eq('jobId', jobId);
      if (countError) throw countError;
      if (count >= plan.candidate_limit) {
        return response.status(403).json({ error: `Limite de ${plan.candidate_limit} candidaturas para esta vaga foi atingido.` });
      }
    }
    // --- FIM DA LÃ“GICA DE LIMITE ---

    const { name, email } = fields;
    const resumeFile = files.resume;
    if (!name || !email || !resumeFile) { return response.status(400).json({ error: 'Nome, e-mail e currÃ­culo sÃ£o obrigatÃ³rios.' }); }
    const fileContent = fs.readFileSync(resumeFile[0].filepath);
    const fileExtension = path.extname(resumeFile[0].originalFilename);
    const fileName = `${email[0].replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}${fileExtension}`;
    const { data: uploadData, error: uploadError } = await supabaseAdmin.storage.from('resumes').upload(fileName, fileContent, { contentType: resumeFile[0].mimetype, upsert: false });
    if (uploadError) throw new Error(`Erro no upload: ${uploadError.message}`);
    let { data: candidate } = await supabaseAdmin.from('candidates').select('id').eq('email', email[0]).single();
    if (!candidate) {
      const { data: newCandidate, error: newCandidateError } = await supabaseAdmin.from('candidates').insert({ name: name[0], email: email[0] }).select('id').single();
      if (newCandidateError) throw newCandidateError;
      candidate = newCandidate;
    }
    const applicationFields = {};
    for (const key in fields) { applicationFields[key] = fields[key][0]; }
    const { error: applicationError } = await supabaseAdmin.from('applications').insert({ jobId: jobId, candidateId: candidate.id, resumeUrl: uploadData.path, formData: applicationFields });
    if (applicationError) throw applicationError;
    
    return response.status(201).json({ message: 'Candidatura enviada com sucesso!' });

  } catch (error) {
    console.error("Erro na candidatura:", error.message);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\api\createJob.js
------------------------------------------------
// api/createJob.js (VersÃ£o V2.0 - Freemium Limit & Full Fields)
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  if (request.method !== 'POST') {
    response.setHeader('Allow', ['POST']);
    return response.status(405).json({ error: `MÃ©todo ${request.method} nÃ£o permitido.` });
  }
  try {
    const supabaseAdmin = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY);
    const authHeader = request.headers['authorization'];
    if (!authHeader) return response.status(401).json({ error: 'NÃ£o autorizado.' });
    
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) return response.status(401).json({ error: 'Token invÃ¡lido.' });
    
    const { data: userData } = await supabaseAdmin.from('users').select('tenantId').eq('id', user.id).single();
    if (!userData) return response.status(404).json({ error: 'Perfil nÃ£o encontrado.' });
    const tenantId = userData.tenantId;

    // Busca dados do plano e contagem atual
    const { data: tenant, error: tenantError } = await supabaseAdmin
      .from('tenants')
      .select('plan:plans(id, job_limit)')
      .eq('id', tenantId)
      .single();
    
    if (tenantError) throw tenantError;

    // REGRA 6: Limite de Vagas Ativas apenas (especialmente Freemium)
    const job_limit = tenant.plan.job_limit;
    
    // Se o limite for diferente de -1 (ilimitado), verificamos
    if (job_limit !== -1) {
      const { count, error: countError } = await supabaseAdmin
        .from('jobs')
        .select('*', { count: 'exact', head: true })
        .eq('tenantId', tenantId)
        .eq('status', 'active'); // Conta apenas ativas!

      if (countError) throw countError;
      
      if (count >= job_limit) {
        return response.status(403).json({ 
            error: `Limite de ${job_limit} vagas ativas atingido para o plano ${tenant.plan.id}. Arquive ou exclua uma vaga para criar outra.` 
        });
      }
    }

    // Recebe todos os campos novos
    const { 
        title, 
        description, 
        requirements, 
        type, 
        location_type, 
        company_department_id 
    } = request.body;

    if (!title) return response.status(400).json({ error: 'O tÃ­tulo da vaga Ã© obrigatÃ³rio.' });
    
    // Prepara objeto de inserÃ§Ã£o com campos seguros
    const insertData = {
        title,
        tenantId,
        status: 'active',
        description: description || '',
        requirements: requirements || '',
        type: type || 'CLT',
        location_type: location_type || 'HÃ­brido',
        // Inicia com parÃ¢metros padrÃ£o se nÃ£o existirem
        parameters: { 
            triagem: [], 
            cultura: [], 
            tecnico: [], 
            notas: [
                {id: '1', nome: 'Abaixo', valor: 0},
                {id: '2', nome: 'Atende', valor: 50},
                {id: '3', nome: 'Supera', valor: 100}
            ] 
        }
    };

    // SÃ³ adiciona o departamento se ele vier preenchido
    if (company_department_id) {
        insertData.company_department_id = company_department_id;
    }
    
    const { data: newJob, error: insertError } = await supabaseAdmin
      .from('jobs')
      .insert(insertData)
      .select()
      .single();
      
    if (insertError) throw insertError;
    
    return response.status(201).json({ newJob });

  } catch (error) {
    console.error("Erro createJob:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\api\getApplicantsForJob.js
------------------------------------------------
// api/getApplicantsForJob.js (VERSÃƒO FINAL E CORRIGIDA)
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    // ValidaÃ§Ã£o do usuÃ¡rio (sem alteraÃ§Ãµes)
    const authHeader = request.headers['authorization'];
    if (!authHeader) return response.status(401).json({ error: 'NÃ£o autorizado.' });
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) return response.status(401).json({ error: 'Token invÃ¡lido.' });
    const { data: userData } = await supabaseAdmin.from('users').select('tenantId').eq('id', user.id).single();
    if (!userData) return response.status(404).json({ error: 'Perfil de usuÃ¡rio nÃ£o encontrado.' });
    const tenantId = userData.tenantId;
    const { jobId } = request.query;
    if (!jobId) return response.status(400).json({ error: 'O ID da vaga Ã© obrigatÃ³rio.' });

    // Busca a vaga e suas candidaturas de uma sÃ³ vez
    const { data: job, error: jobError } = await supabaseAdmin
      .from('jobs')
      .select(`
        id,
        tenantId,
        parameters,
        applications (
          id,
          created_at,
          evaluation,
          isHired,
          candidate:candidates ( id, name, email )
        )
      `)
      .eq('id', Number(jobId))
      .eq('tenantId', tenantId)
      .single();

    if (jobError || !job) {
      return response.status(404).json({ error: 'Vaga nÃ£o encontrada ou nÃ£o pertence Ã  sua empresa.' });
    }

    // Prepara os mapas para cÃ¡lculo (sem alteraÃ§Ãµes)
    const parameters = job.parameters || {};
    const notesMap = new Map((parameters.notas || []).map(note => [note.id, note.valor]));
    const weightsMap = {
      triagem: new Map((parameters.triagem || []).map(c => [c.name, c.weight])),
      cultura: new Map((parameters.cultura || []).map(c => [c.name, c.weight])),
      tÃ©cnico: new Map((parameters.tÃ©cnico || []).map(c => [c.name, c.weight])),
    };

    // Calcula as notas para cada candidatura
    const classifiedApplicants = job.applications.map(app => {
      const scores = { notaTriagem: 0, notaCultura: 0, notaTecnico: 0, notaGeral: 0 };
      if (app.evaluation) {
        ['triagem', 'cultura', 'tÃ©cnico'].forEach(section => {
          let sectionScore = 0;
          const sectionEvaluation = app.evaluation[section];
          if (sectionEvaluation) {
            for (const criterionName in sectionEvaluation) {
              if (criterionName !== 'anotacoes') {
                const noteId = sectionEvaluation[criterionName];
                const noteValue = notesMap.get(noteId) ?? 0;
                const weight = weightsMap[section]?.get(criterionName) ?? 0;
                sectionScore += (noteValue * weight) / 100;
              }
            }
          }
          if (section === 'triagem') scores.notaTriagem = sectionScore;
          if (section === 'cultura') scores.notaCultura = sectionScore;
          if (section === 'tÃ©cnico') scores.notaTecnico = sectionScore;
        });
        scores.notaGeral = scores.notaTriagem + scores.notaCultura + scores.notaTecnico;
      }

      // A CORREÃ‡ÃƒO ESTÃ AQUI: O campo 'isHired' foi restaurado
      return {
        applicationId: app.id,
        submissionDate: app.created_at,
        isHired: app.isHired,
        candidateName: app.candidate.name,
        candidateEmail: app.candidate.email,
        ...scores
      };
    });
    
    return response.status(200).json({ applicants: classifiedApplicants });

  } catch (error) {
    console.error("Erro na funÃ§Ã£o getApplicantsForJob:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\api\getApplicationDetails.js
------------------------------------------------
// api/getApplicationDetails.js (VersÃ£o Definitivamente Corrigida)
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    const authHeader = request.headers['authorization'];
    if (!authHeader) return response.status(401).json({ error: 'NÃ£o autorizado.' });
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) return response.status(401).json({ error: 'Token invÃ¡lido.' });

    const { data: userData } = await supabaseAdmin.from('users').select('tenantId').eq('id', user.id).single();
    if (!userData) return response.status(404).json({ error: 'Perfil de usuÃ¡rio nÃ£o encontrado.' });
    const tenantId = userData.tenantId;

    const { applicationId } = request.query;
    if (!applicationId) {
      return response.status(400).json({ error: 'O ID da candidatura Ã© obrigatÃ³rio.' });
    }

    const { data: application, error: applicationError } = await supabaseAdmin
      .from('applications')
      .select(`
        id,
        created_at,
        formData,
        resumeUrl,
        evaluation, 
        candidate:candidates ( * ),
        job:jobs ( title, parameters, tenantId )
      `)
      .eq('id', Number(applicationId))
      .single();

    if (applicationError) {
      if (applicationError.code === 'PGRST116') {
         return response.status(404).json({ error: 'Candidatura nÃ£o encontrada.' });
      }
      throw applicationError;
    }

    if (application.job.tenantId !== tenantId) {
      return response.status(403).json({ error: 'VocÃª nÃ£o tem permissÃ£o para ver esta candidatura.' });
    }

    return response.status(200).json({ application });

  } catch (error) {
    console.error("Erro na funÃ§Ã£o getApplicationDetails:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\api\getHiredApplicants.js
------------------------------------------------
// api/getHiredApplicants.js
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    // ValidaÃ§Ã£o do usuÃ¡rio de RH
    const authHeader = request.headers['authorization'];
    if (!authHeader) return response.status(401).json({ error: 'NÃ£o autorizado.' });
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) return response.status(401).json({ error: 'Token invÃ¡lido.' });
    
    const { data: userData } = await supabaseAdmin.from('users').select('tenantId').eq('id', user.id).single();
    if (!userData) return response.status(404).json({ error: 'Perfil de usuÃ¡rio nÃ£o encontrado.' });
    const tenantId = userData.tenantId;

    // Busca todas as candidaturas marcadas como 'isHired = true'
    const { data: hiredApplications, error: fetchError } = await supabaseAdmin
      .from('applications')
      .select(`
        id,
        hiredAt,
        formData,
        candidate:candidates ( name, email ),
        job:jobs ( id, title, tenantId )
      `)
      .eq('isHired', true);

    if (fetchError) throw fetchError;

    // Filtra no servidor para garantir que o usuÃ¡rio sÃ³ veja os aprovados do seu prÃ³prio tenant
    const tenantHired = hiredApplications.filter(app => app.job.tenantId === tenantId);

    return response.status(200).json({ hired: tenantHired });

  } catch (error) {
    console.error("Erro ao buscar candidatos contratados:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\api\getPublicJobData.js
------------------------------------------------
// api/getPublicJobData.js (VERSÃƒO FINAL E CORRIGIDA)
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    const { id: jobId } = request.query;
    if (!jobId) {
      return response.status(400).json({ error: 'O ID da vaga Ã© obrigatÃ³rio.' });
    }

    // A CORREÃ‡ÃƒO ESTÃ AQUI: Convertemos o jobId para Number()
    const { data: job, error: jobError } = await supabaseAdmin
      .from('jobs')
      .select(`
        title,
        tenantId,
        applications ( count )
      `)
      .eq('id', Number(jobId)) // Comparando nÃºmero com nÃºmero
      .single();

    if (jobError) throw jobError;

    const { data: tenant, error: tenantError } = await supabaseAdmin
      .from('tenants')
      .select('planId')
      .eq('id', job.tenantId)
      .single();
    
    if (tenantError) throw tenantError;
    
    const formattedJob = {
      title: job.title,
      candidateCount: job.applications[0] ? job.applications[0].count : 0,
      planId: tenant.planId
    };

    return response.status(200).json({ job: formattedJob });
  } catch (error) {
    console.error("Erro ao buscar dados pÃºblicos da vaga:", error);
    return response.status(500).json({ error: 'NÃ£o foi possÃ­vel buscar os dados da vaga.' });
  }
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\api\getResumeSignedUrl.js
------------------------------------------------
// api/getResumeSignedUrl.js
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    // ValidaÃ§Ã£o de seguranÃ§a (sÃ³ usuÃ¡rios logados podem pedir links)
    const authHeader = request.headers['authorization'];
    if (!authHeader) return response.status(401).json({ error: 'NÃ£o autorizado.' });
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) return response.status(401).json({ error: 'Token invÃ¡lido.' });

    // Pega o caminho do arquivo que o frontend quer acessar
    const { filePath } = request.query;
    if (!filePath) {
      return response.status(400).json({ error: 'O caminho do arquivo Ã© obrigatÃ³rio.' });
    }

    // Gera uma URL assinada e segura, com validade de 60 segundos
    const { data, error: urlError } = await supabaseAdmin
      .storage
      .from('resumes')
      .createSignedUrl(filePath, 60); // 60 segundos de validade

    if (urlError) throw urlError;

    return response.status(200).json({ signedUrl: data.signedUrl });

  } catch (error) {
    console.error("Erro ao gerar URL assinada:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.' });
  }
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\api\jobs.js
------------------------------------------------
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  // Usa a chave de serviÃ§o para ter acesso TOTAL (ignora RLS e permissÃµes)
  const supabaseAdmin = createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_KEY
  );

  try {
    // 1. AutenticaÃ§Ã£o BÃ¡sica
    const authHeader = request.headers['authorization'];
    if (!authHeader) throw new Error('Token ausente.');
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    
    if (userError || !user) throw new Error('Token invÃ¡lido.');

    // 2. Busca o Perfil para pegar o Tenant ID correto
    const { data: profile } = await supabaseAdmin
        .from('user_profiles')
        .select('tenantId, name, is_admin_system')
        .eq('id', user.id)
        .single();

    if (!profile || !profile.tenantId) {
        throw new Error('Perfil de usuÃ¡rio nÃ£o encontrado ou sem empresa.');
    }

    const tenantId = profile.tenantId;

    if (request.method === 'GET') {
        const { id } = request.query;

        // --- BUSCAS SEPARADAS (BLINDAGEM CONTRA ERRO DE TIPOS) ---

        // A. Busca Dados da Empresa
        const { data: tenant } = await supabaseAdmin
            .from('tenants')
            .select('companyName, planId')
            .eq('id', tenantId)
            .single();

        // B. Busca TODAS as Vagas deste Tenant
        const { data: jobs, error: jobsError } = await supabaseAdmin
            .from('jobs')
            .select('*') // Pega tudo, sem tentar join quebrado
            .eq('tenantId', tenantId);

        if (jobsError) throw jobsError;

        // C. Busca TODOS os Departamentos deste Tenant
        // (Aqui resolvemos o problema: O banco pode ter salvo como texto ou uuid, pegamos por string)
        const { data: departments } = await supabaseAdmin
            .from('company_departments')
            .select('id, name, tenantId'); 
            // Filtramos no cÃ³digo abaixo para garantir, caso o tipo no banco impeÃ§a o .eq()

        // D. Busca Contagem de Candidatos
        // Fazemos uma query raw ou agrupada para evitar join complexo
        const { data: applications } = await supabaseAdmin
            .from('applications')
            .select('jobId');

        // --- MONTAGEM DOS DADOS (MANUAL JOIN) ---
        
        // 1. Mapa de Contagem de Candidatos
        const candidateCounts = {};
        applications.forEach(app => {
            candidateCounts[app.jobId] = (candidateCounts[app.jobId] || 0) + 1;
        });

        // 2. Mapa de Departamentos (ID -> Nome)
        const deptMap = {};
        if (departments) {
            departments.forEach(d => {
                // Normaliza para string para garantir o match
                if (String(d.tenantId) === String(tenantId)) {
                    deptMap[d.id] = d.name;
                }
            });
        }

        // 3. Monta o Objeto Final para o Dashboard
        let formattedJobs = jobs.map(job => ({
            id: job.id,
            title: job.title,
            status: job.status,
            created_at: job.created_at,
            type: job.type,
            location_type: job.location_type,
            candidateCount: candidateCounts[job.id] || 0,
            // Aqui fazemos o vÃ­nculo manual que o banco estava recusando
            deptName: deptMap[job.company_department_id] || 'Geral'
        }));

        // 4. OrdenaÃ§Ã£o
        formattedJobs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        // Se for detalhe de uma vaga especÃ­fica
        if (id) {
            const specificJob = formattedJobs.find(j => j.id == id); // == para aceitar string/number
            if (!specificJob) return response.status(404).json({ error: 'Vaga nÃ£o encontrada.' });
            
            // Adiciona campos extras necessÃ¡rios para a tela de detalhes
            const rawJob = jobs.find(j => j.id == id);
            specificJob.description = rawJob.description;
            specificJob.requirements = rawJob.requirements;
            specificJob.parameters = rawJob.parameters;
            
            return response.status(200).json({ job: specificJob });
        }

        return response.status(200).json({
            jobs: formattedJobs,
            meta: {
                companyName: tenant?.companyName || 'Minha Empresa',
                userName: profile.name || user.email,
                planId: tenant?.planId || 'free',
                isAdmin: profile.is_admin_system
            }
        });
    }

    // POST (Escrita) - Mantido simples e direto
    if (request.method === 'POST') {
         const { action, jobId, newStatus } = request.body;
         
         if (action === 'updateJobStatus') {
            await supabaseAdmin.from('jobs').update({ status: newStatus }).eq('id', jobId);
            return response.status(200).json({ message: 'Atualizado' });
         }
         if (action === 'deleteJob') {
            await supabaseAdmin.from('applications').delete().eq('jobId', jobId);
            await supabaseAdmin.from('jobs').delete().eq('id', jobId);
            return response.status(200).json({ message: 'Deletado' });
         }
    }

    return response.status(405).json({ error: 'Method not allowed' });

  } catch (error) {
    console.error('API Error:', error.message);
    return response.status(500).json({ error: error.message });
  }
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\api\saveEvaluation.js
------------------------------------------------
import { createClient } from '@supabase/supabase-js';
// Certifique-se de que o arquivo _utils/calculator.js existe conforme passo anterior
import { calculateWeightedScore } from './_utils/calculator.js'; 

export default async function handler(request, response) {
  if (request.method !== 'POST') return response.status(405).json({ error: 'MÃ©todo nÃ£o permitido' });

  const supabaseAdmin = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY);

  try {
    const authHeader = request.headers['authorization'];
    if (!authHeader) throw new Error('Token ausente.');
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: authError } = await supabaseAdmin.auth.getUser(token);
    
    if (authError || !user) throw new Error('Token invÃ¡lido.');

    const { applicationId, scores, notes } = request.body;

    // 1. Busca ParÃ¢metros da Vaga
    const { data: appData, error: appError } = await supabaseAdmin
        .from('applications')
        .select('job:jobs(parameters)')
        .eq('id', applicationId)
        .single();

    if (appError || !appData) throw new Error('Candidatura nÃ£o encontrada.');

    // 2. Calcula Nota (Backend)
    // A funÃ§Ã£o calculateWeightedScore deve tratar o 'N/A' ignorando o peso
    const finalScore = calculateWeightedScore(scores, appData.job.parameters);

    // 3. Salva na tabela EVALUATIONS (Confirmada nos metadados)
    const { error: saveError } = await supabaseAdmin
        .from('evaluations')
        .upsert({
            application_id: applicationId,
            evaluator_id: user.id,
            scores: scores,
            notes: notes,
            final_score: finalScore,
            updated_at: new Date()
        }, { onConflict: 'application_id, evaluator_id' });

    if (saveError) throw saveError;

    return response.status(200).json({ message: 'AvaliaÃ§Ã£o salva!', score: finalScore });

  } catch (error) {
    console.error('Save Error:', error);
    return response.status(500).json({ error: error.message });
  }
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\api\updateHiredStatus.js
------------------------------------------------
// api/updateHiredStatus.js (VersÃ£o com data de contrataÃ§Ã£o)
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  if (request.method !== 'POST') {
    return response.status(405).json({ error: 'MÃ©todo nÃ£o permitido.' });
  }

  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    // ValidaÃ§Ã£o do usuÃ¡rio (sem alteraÃ§Ãµes)
    const authHeader = request.headers['authorization'];
    if (!authHeader) return response.status(401).json({ error: 'NÃ£o autorizado.' });
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) return response.status(401).json({ error: 'Token invÃ¡lido.' });
    
    const { applicationId, isHired } = request.body;
    if (!applicationId || typeof isHired !== 'boolean') {
      return response.status(400).json({ error: 'applicationId e isHired (booleano) sÃ£o obrigatÃ³rios.' });
    }

    // AQUI ESTÃ A LÃ“GICA ADITIVA:
    // Se estÃ¡ contratando, define a data atual. Se estÃ¡ "descontratando", define como nulo.
    const updateData = {
      isHired: isHired,
      hiredAt: isHired ? new Date().toISOString() : null
    };

    const { data, error: updateError } = await supabaseAdmin
      .from('applications')
      .update(updateData) // Usa o novo objeto de dados
      .eq('id', applicationId)
      .select()
      .single();

    if (updateError) throw updateError;

    return response.status(200).json({ message: 'Status do candidato atualizado com sucesso!', updatedApplication: data });

  } catch (error) {
    console.error("Erro ao atualizar status de contrataÃ§Ã£o:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}


------------------------------------------------
 ARQUIVO: C:\Users\Eider\NOVVA\novva-rs-saas-2_0\api\updateJobParameters.js
------------------------------------------------
// api/updateJobParameters.js
import { createClient } from '@supabase/supabase-js';

export default async function handler(request, response) {
  if (request.method !== 'POST') {
    response.setHeader('Allow', ['POST']);
    return response.status(405).json({ error: `MÃ©todo ${request.method} nÃ£o permitido.` });
  }

  try {
    const supabaseAdmin = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_KEY
    );

    // 1. Valida o token do usuÃ¡rio para garantir que ele estÃ¡ logado
    const authHeader = request.headers['authorization'];
    if (!authHeader) {
      return response.status(401).json({ error: 'NÃ£o autorizado.' });
    }
    const token = authHeader.replace('Bearer ', '');
    const { data: { user }, error: userError } = await supabaseAdmin.auth.getUser(token);
    if (userError) {
      return response.status(401).json({ error: 'Token invÃ¡lido.' });
    }

    // 2. Busca o tenantId do usuÃ¡rio para garantir que ele sÃ³ edite suas prÃ³prias vagas
    const { data: userData } = await supabaseAdmin.from('users').select('tenantId').eq('id', user.id).single();
    if (!userData) {
      return response.status(404).json({ error: 'Perfil de usuÃ¡rio nÃ£o encontrado.' });
    }
    const tenantId = userData.tenantId;

    // 3. Pega o ID da vaga e os novos parÃ¢metros do corpo da requisiÃ§Ã£o
    const { jobId, parameters } = request.body;
    if (!jobId || !parameters) {
      return response.status(400).json({ error: 'jobId e parameters sÃ£o obrigatÃ³rios.' });
    }

    // 4. Atualiza a vaga no banco de dados
    const { data, error: updateError } = await supabaseAdmin
      .from('jobs')
      .update({ parameters: parameters }) // Atualiza apenas a coluna 'parameters'
      .eq('id', jobId)                   // Onde o ID da vaga bate
      .eq('tenantId', tenantId)          // E ONDE a vaga pertence ao tenant do usuÃ¡rio (SEGURANÃ‡A)
      .select()
      .single();

    if (updateError) {
      // Se o erro for 'PGRST116', significa que a vaga nÃ£o foi encontrada (ou nÃ£o pertence ao tenant)
      if (updateError.code === 'PGRST116') {
        return response.status(404).json({ error: 'Vaga nÃ£o encontrada ou vocÃª nÃ£o tem permissÃ£o para editÃ¡-la.' });
      }
      throw updateError;
    }

    // 5. Retorna sucesso
    return response.status(200).json({ message: 'ParÃ¢metros salvos com sucesso!', updatedJob: data });

  } catch (error) {
    console.error("Erro na funÃ§Ã£o updateJobParameters:", error);
    return response.status(500).json({ error: 'Erro interno do servidor.', details: error.message });
  }
}
